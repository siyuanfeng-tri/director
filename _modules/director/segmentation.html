

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>director.segmentation &mdash; Director  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Director  documentation" href="../../index.html"/>
        <link rel="up" title="director" href="../director.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Director
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/index.html">Application User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/modules.html">Python Module API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Director</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../director.html">director</a> &raquo;</li>
      
    <li>director.segmentation</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for director.segmentation</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">vtk</span>
<span class="kn">import</span> <span class="nn">colorsys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">PythonQt</span>
<span class="kn">from</span> <span class="nn">PythonQt</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>
<span class="kn">import</span> <span class="nn">director.applogic</span> <span class="kn">as</span> <span class="nn">app</span>
<span class="kn">from</span> <span class="nn">director</span> <span class="kn">import</span> <span class="n">objectmodel</span> <span class="k">as</span> <span class="n">om</span>
<span class="kn">from</span> <span class="nn">director</span> <span class="kn">import</span> <span class="n">perception</span>
<span class="kn">from</span> <span class="nn">director</span> <span class="kn">import</span> <span class="n">lcmUtils</span>
<span class="kn">from</span> <span class="nn">director</span> <span class="kn">import</span> <span class="n">roboturdf</span>
<span class="kn">from</span> <span class="nn">director</span> <span class="kn">import</span> <span class="n">transformUtils</span>
<span class="kn">from</span> <span class="nn">director</span> <span class="kn">import</span> <span class="n">visualization</span> <span class="k">as</span> <span class="n">vis</span>
<span class="kn">from</span> <span class="nn">director.transformUtils</span> <span class="kn">import</span> <span class="n">getTransformFromAxes</span>
<span class="kn">from</span> <span class="nn">director.timercallback</span> <span class="kn">import</span> <span class="n">TimerCallback</span>
<span class="kn">from</span> <span class="nn">director</span> <span class="kn">import</span> <span class="n">mapsregistrar</span>
<span class="kn">from</span> <span class="nn">director</span> <span class="kn">import</span> <span class="n">affordancemanager</span>
<span class="kn">from</span> <span class="nn">director.affordanceitems</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">director.visualization</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">director.filterUtils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">director.fieldcontainer</span> <span class="kn">import</span> <span class="n">FieldContainer</span>
<span class="kn">from</span> <span class="nn">director.segmentationroutines</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">director</span> <span class="kn">import</span> <span class="n">cameraview</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">vtkNumpy</span>
<span class="kn">from</span> <span class="nn">debugVis</span> <span class="kn">import</span> <span class="n">DebugData</span>
<span class="kn">from</span> <span class="nn">shallowCopy</span> <span class="kn">import</span> <span class="n">shallowCopy</span>
<span class="kn">import</span> <span class="nn">ioUtils</span>
<span class="kn">from</span> <span class="nn">director.uuidutil</span> <span class="kn">import</span> <span class="n">newUUID</span>

<span class="kn">import</span> <span class="nn">drc</span> <span class="kn">as</span> <span class="nn">lcmdrc</span>
<span class="kn">import</span> <span class="nn">bot_core</span> <span class="kn">as</span> <span class="nn">lcmbotcore</span>

<span class="kn">import</span> <span class="nn">vs</span> <span class="kn">as</span> <span class="nn">lcmvs</span>
<span class="kn">from</span> <span class="nn">director</span> <span class="kn">import</span> <span class="n">lcmUtils</span>


<span class="n">DRILL_TRIANGLE_BOTTOM_LEFT</span> <span class="o">=</span> <span class="s">&#39;bottom left&#39;</span>
<span class="n">DRILL_TRIANGLE_BOTTOM_RIGHT</span> <span class="o">=</span> <span class="s">&#39;bottom right&#39;</span>
<span class="n">DRILL_TRIANGLE_TOP_LEFT</span> <span class="o">=</span> <span class="s">&#39;top left&#39;</span>
<span class="n">DRILL_TRIANGLE_TOP_RIGHT</span> <span class="o">=</span> <span class="s">&#39;top right&#39;</span>

<span class="c"># using drc plane segmentation instead of PCL</span>
<span class="n">planeSegmentationFilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPlaneSegmentation</span>
<span class="c">#planeSegmentationFilter = vtk.vtkPCLSACSegmentationPlane</span>


<span class="n">_defaultSegmentationView</span> <span class="o">=</span> <span class="bp">None</span>
<div class="viewcode-block" id="getSegmentationView"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getSegmentationView">[docs]</a><span class="k">def</span> <span class="nf">getSegmentationView</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_defaultSegmentationView</span> <span class="ow">or</span> <span class="n">app</span><span class="o">.</span><span class="n">getViewManager</span><span class="p">()</span><span class="o">.</span><span class="n">findView</span><span class="p">(</span><span class="s">&#39;Segmentation View&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="getDRCView"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getDRCView">[docs]</a><span class="k">def</span> <span class="nf">getDRCView</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="switchToView"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.switchToView">[docs]</a><span class="k">def</span> <span class="nf">switchToView</span><span class="p">(</span><span class="n">viewName</span><span class="p">):</span>
    <span class="n">app</span><span class="o">.</span><span class="n">getViewManager</span><span class="p">()</span><span class="o">.</span><span class="n">switchToView</span><span class="p">(</span><span class="n">viewName</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="getCurrentView"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getCurrentView">[docs]</a><span class="k">def</span> <span class="nf">getCurrentView</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">getCurrentRenderView</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="initAffordanceManager"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.initAffordanceManager">[docs]</a><span class="k">def</span> <span class="nf">initAffordanceManager</span><span class="p">(</span><span class="n">view</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Normally the affordance manager is initialized by the application.</span>
<span class="sd">    This function can be called from scripts and tests to initialize the manager.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">global</span> <span class="n">affordanceManager</span>
    <span class="n">affordanceManager</span> <span class="o">=</span> <span class="n">affordancemanager</span><span class="o">.</span><span class="n">AffordanceObjectModelManager</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="cropToLineSegment"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.cropToLineSegment">[docs]</a><span class="k">def</span> <span class="nf">cropToLineSegment</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point1</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">line</span> <span class="o">/</span> <span class="n">length</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelPointDistanceAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="o">=</span><span class="s">&#39;dist_along_line&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_along_line&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">length</span><span class="p">])</span>


</div>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">icp programmable filter</span>

<span class="sd">import vtkFiltersGeneralPython as filtersGeneral</span>

<span class="sd">points = inputs[0]</span>
<span class="sd">block = inputs[1]</span>

<span class="sd">print points.GetNumberOfPoints()</span>
<span class="sd">print block.GetNumberOfPoints()</span>

<span class="sd">if points.GetNumberOfPoints() &lt; block.GetNumberOfPoints():</span>
<span class="sd">    block, points = points, block</span>

<span class="sd">icp = vtk.vtkIterativeClosestPointTransform()</span>
<span class="sd">icp.SetSource(points.VTKObject)</span>
<span class="sd">icp.SetTarget(block.VTKObject)</span>
<span class="sd">icp.GetLandmarkTransform().SetModeToRigidBody()</span>
<span class="sd">icp.Update()</span>

<span class="sd">t = filtersGeneral.vtkTransformPolyDataFilter()</span>
<span class="sd">t.SetInput(points.VTKObject)</span>
<span class="sd">t.SetTransform(icp)</span>
<span class="sd">t.Update()</span>

<span class="sd">output.ShallowCopy(t.GetOutput())</span>
<span class="sd">&#39;&#39;&#39;</span>



<div class="viewcode-block" id="lockAffordanceToHand"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.lockAffordanceToHand">[docs]</a><span class="k">def</span> <span class="nf">lockAffordanceToHand</span><span class="p">(</span><span class="n">aff</span><span class="p">,</span> <span class="n">hand</span><span class="o">=</span><span class="s">&#39;l_hand&#39;</span><span class="p">):</span>

    <span class="n">linkFrame</span> <span class="o">=</span> <span class="n">getLinkFrame</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span>
    <span class="n">affT</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetUserTransform</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">aff</span><span class="p">,</span> <span class="s">&#39;handToAffT&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">aff</span><span class="o">.</span><span class="n">handToAffT</span><span class="p">:</span>
        <span class="n">aff</span><span class="o">.</span><span class="n">handToAffT</span> <span class="o">=</span> <span class="n">computeAToB</span><span class="p">(</span><span class="n">linkFrame</span><span class="p">,</span> <span class="n">affT</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">aff</span><span class="o">.</span><span class="n">handToAffT</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">linkFrame</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetUserTransform</span><span class="p">()</span><span class="o">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">GetMatrix</span><span class="p">())</span>

</div>
<span class="n">handAffUpdater</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="lockToHandOn"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.lockToHandOn">[docs]</a><span class="k">def</span> <span class="nf">lockToHandOn</span><span class="p">():</span>
    <span class="n">aff</span> <span class="o">=</span> <span class="n">getDefaultAffordanceObject</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">aff</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">global</span> <span class="n">handAffUpdater</span>
    <span class="k">if</span> <span class="n">handAffUpdater</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">handAffUpdater</span> <span class="o">=</span> <span class="n">TimerCallback</span><span class="p">()</span>
        <span class="n">handAffUpdater</span><span class="o">.</span><span class="n">targetFps</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="n">handAffUpdater</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">lockAffordanceToHand</span><span class="p">,</span> <span class="n">aff</span><span class="p">)</span>
    <span class="n">handAffUpdater</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="lockToHandOff"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.lockToHandOff">[docs]</a><span class="k">def</span> <span class="nf">lockToHandOff</span><span class="p">():</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">getDefaultAffordanceObject</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">aff</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">handAffUpdater</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">handToAffT</span> <span class="o">=</span> <span class="bp">None</span>


</div>
<div class="viewcode-block" id="DisparityPointCloudItem"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.DisparityPointCloudItem">[docs]</a><span class="k">class</span> <span class="nc">DisparityPointCloudItem</span><span class="p">(</span><span class="n">vis</span><span class="o">.</span><span class="n">PolyDataItem</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">imagesChannel</span><span class="p">,</span> <span class="n">cameraName</span><span class="p">,</span> <span class="n">imageManager</span><span class="p">):</span>
        <span class="n">vis</span><span class="o">.</span><span class="n">PolyDataItem</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">(),</span> <span class="n">view</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addProperty</span><span class="p">(</span><span class="s">&#39;Channel&#39;</span><span class="p">,</span> <span class="n">imagesChannel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addProperty</span><span class="p">(</span><span class="s">&#39;Camera name&#39;</span><span class="p">,</span> <span class="n">cameraName</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addProperty</span><span class="p">(</span><span class="s">&#39;Decimation&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">om</span><span class="o">.</span><span class="n">PropertyAttributes</span><span class="p">(</span><span class="n">enumNames</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;2&#39;</span><span class="p">,</span> <span class="s">&#39;4&#39;</span><span class="p">,</span> <span class="s">&#39;8&#39;</span><span class="p">,</span> <span class="s">&#39;16&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addProperty</span><span class="p">(</span><span class="s">&#39;Remove Size&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">om</span><span class="o">.</span><span class="n">PropertyAttributes</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mf">100000.0</span><span class="p">,</span> <span class="n">singleStep</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addProperty</span><span class="p">(</span><span class="s">&#39;Target FPS&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">om</span><span class="o">.</span><span class="n">PropertyAttributes</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">singleStep</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">TimerCallback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastUtime</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imageManager</span> <span class="o">=</span> <span class="n">imageManager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cameraName</span> <span class="o">=</span> <span class="n">cameraName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Visible&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_onPropertyChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propertySet</span><span class="p">,</span> <span class="n">propertyName</span><span class="p">):</span>
        <span class="n">vis</span><span class="o">.</span><span class="n">PolyDataItem</span><span class="o">.</span><span class="n">_onPropertyChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propertySet</span><span class="p">,</span> <span class="n">propertyName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">propertyName</span> <span class="o">==</span> <span class="s">&#39;Visible&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="n">propertyName</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">propertyName</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;Decimation&#39;</span><span class="p">,</span> <span class="s">&#39;Remove outliers&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastUtime</span> <span class="o">=</span> <span class="mi">0</span>


<div class="viewcode-block" id="DisparityPointCloudItem.onRemoveFromObjectModel"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.DisparityPointCloudItem.onRemoveFromObjectModel">[docs]</a>    <span class="k">def</span> <span class="nf">onRemoveFromObjectModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vis</span><span class="o">.</span><span class="n">PolyDataItem</span><span class="o">.</span><span class="n">onRemoveFromObjectModel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="DisparityPointCloudItem.update"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.DisparityPointCloudItem.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">utime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageManager</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">getCurrentImageTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cameraName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">utime</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastUtime</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">utime</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastUtime</span> <span class="p">):</span>
            <span class="n">temp</span><span class="o">=</span><span class="mi">0</span> <span class="c"># dummy</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">utime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastUtime</span> <span class="o">&lt;</span> <span class="mf">1E6</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;Target FPS&#39;</span><span class="p">)):</span>
            <span class="k">return</span>

        <span class="n">decimation</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">getPropertyEnumValue</span><span class="p">(</span><span class="s">&#39;Decimation&#39;</span><span class="p">))</span>
        <span class="n">removeSize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;Remove Size&#39;</span><span class="p">))</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">getDisparityPointCloud</span><span class="p">(</span><span class="n">decimation</span><span class="p">,</span> <span class="n">imagesChannel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;Channel&#39;</span><span class="p">),</span> <span class="n">cameraName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;Camera name&#39;</span><span class="p">),</span>
                                          <span class="n">removeOutliers</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">removeSize</span><span class="o">=</span><span class="n">removeSize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setPolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastUtime</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Color By&#39;</span><span class="p">,</span> <span class="s">&#39;rgb_colors&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lastUtime</span> <span class="o">=</span> <span class="n">utime</span>

</div></div>
<div class="viewcode-block" id="getRandomColor"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getRandomColor">[docs]</a><span class="k">def</span> <span class="nf">getRandomColor</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return a random color as a list of RGB values between 0.0 and 1.0.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="extractLargestCluster"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.extractLargestCluster">[docs]</a><span class="k">def</span> <span class="nf">extractLargestCluster</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">applyEuclideanClustering</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="n">minClusterSize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;cluster_labels&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="segmentGround"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentGround">[docs]</a><span class="k">def</span> <span class="nf">segmentGround</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">groundThickness</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">sceneHeightFromGround</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A More complex ground removal algorithm. Works when plane isn&#39;t</span>
<span class="sd">    preceisely flat. First clusters on z to find approx ground height, then fits a plane there</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">searchRegionThickness</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="n">zvalues</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)[:,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">groundHeight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">zvalues</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">zvalues</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s">&#39;z&#39;</span><span class="p">)</span>
    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">groundHeight</span> <span class="o">-</span> <span class="n">searchRegionThickness</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">groundHeight</span> <span class="o">+</span> <span class="n">searchRegionThickness</span><span class="o">/</span><span class="mf">2.0</span><span class="p">])</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="s">&#39;ground search region&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;z&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">points</span> <span class="o">-</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">)</span>

    <span class="n">groundPoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">groundThickness</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">groundThickness</span><span class="o">/</span><span class="mf">2.0</span><span class="p">])</span>
    <span class="n">scenePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">sceneHeightFromGround</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">groundPoints</span><span class="p">,</span> <span class="n">scenePoints</span>

</div>
<div class="viewcode-block" id="segmentGroundPlane"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentGroundPlane">[docs]</a><span class="k">def</span> <span class="nf">segmentGroundPlane</span><span class="p">():</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">inputObj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Visible&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span><span class="p">)</span>

    <span class="n">zvalues</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)[:,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">groundHeight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">zvalues</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">groundHeight</span> <span class="o">-</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">groundHeight</span> <span class="o">+</span> <span class="mf">0.3</span><span class="p">])</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="s">&#39;ground search region&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;z&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">points</span> <span class="o">-</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">)</span>

    <span class="n">groundPoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">scenePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">groundPoints</span><span class="p">,</span> <span class="s">&#39;ground points&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;scene points&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c">#scenePoints = applyEuclideanClustering(scenePoints, clusterTolerance=0.10, minClusterSize=100, maxClusterSize=1e6)</span>
    <span class="c">#updatePolyData(scenePoints, &#39;scene points&#39;, colorByName=&#39;cluster_labels&#39;)</span>

</div>
<div class="viewcode-block" id="applyLocalPlaneFit"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.applyLocalPlaneFit">[docs]</a><span class="k">def</span> <span class="nf">applyLocalPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">,</span> <span class="n">searchRadius</span><span class="p">,</span> <span class="n">searchRadiusEnd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">removeGroundFirst</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="n">useVoxelGrid</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">voxelGridSize</span> <span class="o">=</span> <span class="mf">0.03</span>
    <span class="n">distanceToPlaneThreshold</span> <span class="o">=</span> <span class="mf">0.02</span>

    <span class="k">if</span> <span class="n">useVoxelGrid</span><span class="p">:</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="n">voxelGridSize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">removeGroundFirst</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">polyData</span> <span class="o">=</span> <span class="n">removeGround</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">groundThickness</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">sceneHeightFromGround</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>

    <span class="n">cropped</span> <span class="o">=</span> <span class="n">cropToSphere</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">,</span> <span class="n">searchRadius</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span> <span class="s">&#39;crop to sphere&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;distance_to_point&#39;</span><span class="p">)</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">distanceToPlaneThreshold</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">searchPoint</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="n">searchRadius</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">searchRadiusEnd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">polyData</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">distanceToPlaneThreshold</span><span class="p">,</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="n">normal</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">searchPoint</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="n">searchRadiusEnd</span><span class="p">)</span>

    <span class="n">fitPoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">distanceToPlaneThreshold</span><span class="p">,</span> <span class="n">distanceToPlaneThreshold</span><span class="p">])</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">fitPoints</span><span class="p">,</span> <span class="s">&#39;fitPoints&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">fitPoints</span> <span class="o">=</span> <span class="n">labelDistanceToPoint</span><span class="p">(</span><span class="n">fitPoints</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">)</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">extractClusters</span><span class="p">(</span><span class="n">fitPoints</span><span class="p">,</span> <span class="n">clusterTolerance</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">clusters</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#39;distance_to_point&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">fitPoints</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">fitPoints</span><span class="p">,</span> <span class="n">normal</span>


    <span class="n">normalEstimationSearchRadius</span> <span class="o">=</span> <span class="mf">0.065</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPCLNormalEstimation</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetSearchRadius</span><span class="p">(</span><span class="n">normalEstimationSearchRadius</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">scenePoints</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

    <span class="n">normals</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;normals&#39;</span><span class="p">)</span>
    <span class="n">normalsDotPlaneNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">normal</span><span class="p">))</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="n">normalsDotPlaneNormal</span><span class="p">,</span> <span class="s">&#39;normals_dot_plane_normal&#39;</span><span class="p">)</span>

    <span class="n">showPolyData</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;scene_with_normals&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;normals_dot_plane_normal&#39;</span><span class="p">)</span>

    <span class="n">surfaces</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;normals_dot_plane_normal&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="n">extractClusters</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span> <span class="n">clusterTolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>
        <span class="n">showPolyData</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s">&#39;plane cluster </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fitPoints</span>

</div>
<div class="viewcode-block" id="orientToMajorPlane"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.orientToMajorPlane">[docs]</a><span class="k">def</span> <span class="nf">orientToMajorPlane</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">pickedPoint</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find the largest plane and transform the cloud to align that plane</span>
<span class="sd">    Use the given point as the origin</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">distanceToPlaneThreshold</span><span class="o">=</span><span class="mf">0.02</span>
    <span class="n">searchRadius</span> <span class="o">=</span> <span class="mf">0.5</span>


    <span class="n">planePoints</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">distanceToPlaneThreshold</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">pickedPoint</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="n">searchRadius</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">updatePolyData</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;local plane fit&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">planeFrame</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">getTransformFromOriginAndNormal</span><span class="p">(</span><span class="n">pickedPoint</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">updateFrame</span><span class="p">(</span><span class="n">planeFrame</span><span class="p">,</span> <span class="s">&#39;plane frame&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">planeFrame</span><span class="o">.</span><span class="n">GetLinearInverse</span><span class="p">()</span> <span class="p">)</span>

    <span class="c"># if the mean point is below the horizontal plane, flip the cloud</span>
    <span class="n">zvalues</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)[:,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">midCloudHeight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">zvalues</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">midCloudHeight</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
      <span class="n">flipTransform</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">polyData</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">flipTransform</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">polyData</span><span class="p">,</span> <span class="n">planeFrame</span>

</div>
<div class="viewcode-block" id="getMajorPlanes"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getMajorPlanes">[docs]</a><span class="k">def</span> <span class="nf">getMajorPlanes</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">useVoxelGrid</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="n">voxelGridSize</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">distanceToPlaneThreshold</span> <span class="o">=</span> <span class="mf">0.02</span>

    <span class="k">if</span> <span class="n">useVoxelGrid</span><span class="p">:</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="n">voxelGridSize</span><span class="p">)</span>

    <span class="n">polyDataList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">minClusterSize</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">polyDataList</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">:</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">planeSegmentationFilter</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">SetDistanceThreshold</span><span class="p">(</span><span class="n">distanceToPlaneThreshold</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

        <span class="n">outliers</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;ransac_labels&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">inliers</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;ransac_labels&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">largestCluster</span> <span class="o">=</span> <span class="n">extractLargestCluster</span><span class="p">(</span><span class="n">inliers</span><span class="p">)</span>

        <span class="c">#i = len(polyDataList)</span>
        <span class="c">#showPolyData(inliers, &#39;inliers %d&#39; % i, color=getRandomColor(), parent=&#39;major planes&#39;)</span>
        <span class="c">#showPolyData(outliers, &#39;outliers %d&#39; % i, color=getRandomColor(), parent=&#39;major planes&#39;)</span>
        <span class="c">#showPolyData(largestCluster, &#39;cluster %d&#39; % i, color=getRandomColor(), parent=&#39;major planes&#39;)</span>

        <span class="k">if</span> <span class="n">largestCluster</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">minClusterSize</span><span class="p">:</span>
            <span class="n">polyDataList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">largestCluster</span><span class="p">)</span>
            <span class="n">polyData</span> <span class="o">=</span> <span class="n">outliers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">polyDataList</span>

</div>
<div class="viewcode-block" id="showMajorPlanes"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.showMajorPlanes">[docs]</a><span class="k">def</span> <span class="nf">showMajorPlanes</span><span class="p">(</span><span class="n">polyData</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">polyData</span><span class="p">:</span>
        <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
        <span class="n">inputObj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Visible&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">om</span><span class="o">.</span><span class="n">removeFromObjectModel</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;major planes&#39;</span><span class="p">))</span>
    <span class="n">folderObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;segmentation&#39;</span><span class="p">)</span>
    <span class="n">folderObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">getOrCreateContainer</span><span class="p">(</span><span class="s">&#39;major planes&#39;</span><span class="p">,</span> <span class="n">folderObj</span><span class="p">)</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewFrame</span><span class="p">()</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelDistanceToPoint</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;distance_to_point&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

    <span class="n">polyDataList</span> <span class="o">=</span> <span class="n">getMajorPlanes</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">polyData</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polyDataList</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;plane </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">getRandomColor</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;major planes&#39;</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Point Size&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="cropToBox"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.cropToBox">[docs]</a><span class="k">def</span> <span class="nf">cropToBox</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    dimensions is length 3 describing box dimensions</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">getAxesFromTransform</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">):</span>
        <span class="n">cropAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">length</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">cropToLineSegment</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span> <span class="o">-</span> <span class="n">cropAxis</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">cropAxis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">polyData</span>
</div>
<div class="viewcode-block" id="cropToBounds"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.cropToBounds">[docs]</a><span class="k">def</span> <span class="nf">cropToBounds</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    bounds is a 2x3 containing the min/max values along the transform axes to use for cropping</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">getAxesFromTransform</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">bound</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">cropToLineSegment</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">axis</span><span class="o">*</span><span class="n">bound</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">axis</span><span class="o">*</span><span class="n">bound</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">polyData</span>

</div>
<div class="viewcode-block" id="cropToSphere"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.cropToSphere">[docs]</a><span class="k">def</span> <span class="nf">cropToSphere</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelDistanceToPoint</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;distance_to_point&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">radius</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="applyPlaneFit"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.applyPlaneFit">[docs]</a><span class="k">def</span> <span class="nf">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="n">expectedNormal</span> <span class="o">=</span> <span class="n">expectedNormal</span> <span class="k">if</span> <span class="n">expectedNormal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">fitInput</span> <span class="o">=</span> <span class="n">polyData</span>
    <span class="k">if</span> <span class="n">searchOrigin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">searchRadius</span>
        <span class="n">fitInput</span> <span class="o">=</span> <span class="n">cropToSphere</span><span class="p">(</span><span class="n">fitInput</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="p">,</span> <span class="n">searchRadius</span><span class="p">)</span>

    <span class="c"># perform plane segmentation</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">planeSegmentationFilter</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">fitInput</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetDistanceThreshold</span><span class="p">(</span><span class="n">distanceThreshold</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">perpendicularAxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">SetPerpendicularConstraintEnabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">SetPerpendicularAxis</span><span class="p">(</span><span class="n">perpendicularAxis</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">SetAngleEpsilon</span><span class="p">(</span><span class="n">angleEpsilon</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">GetPlaneOrigin</span><span class="p">()</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">GetPlaneNormal</span><span class="p">())</span>

    <span class="c"># flip the normal if needed</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>

    <span class="c"># for each point, compute signed distance to plane</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">points</span> <span class="o">-</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">returnOrigin</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">polyData</span><span class="p">,</span> <span class="n">normal</span>

</div>
<div class="viewcode-block" id="flipNormalsWithViewDirection"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.flipNormalsWithViewDirection">[docs]</a><span class="k">def</span> <span class="nf">flipNormalsWithViewDirection</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">viewDirection</span><span class="p">):</span>
    <span class="n">normals</span> <span class="o">=</span> <span class="n">vnp</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;normals&#39;</span><span class="p">)</span>
    <span class="n">normals</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">viewDirection</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

</div>
<div class="viewcode-block" id="normalEstimation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.normalEstimation">[docs]</a><span class="k">def</span> <span class="nf">normalEstimation</span><span class="p">(</span><span class="n">dataObj</span><span class="p">,</span> <span class="n">searchCloud</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">useVoxelGrid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">voxelGridLeafSize</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPCLNormalEstimation</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetSearchRadius</span><span class="p">(</span><span class="n">searchRadius</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">dataObj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">searchCloud</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">searchCloud</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">useVoxelGrid</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">dataObj</span><span class="p">,</span> <span class="n">voxelGridLeafSize</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">dataObj</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
    <span class="n">dataObj</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetNormals</span><span class="p">(</span><span class="n">dataObj</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="s">&#39;normals&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">dataObj</span>

</div>
<div class="viewcode-block" id="addCoordArraysToPolyData"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.addCoordArraysToPolyData">[docs]</a><span class="k">def</span> <span class="nf">addCoordArraysToPolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">):</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s">&#39;z&#39;</span><span class="p">)</span>

    <span class="n">viewFrame</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewFrame</span><span class="p">()</span>
    <span class="n">viewOrigin</span> <span class="o">=</span> <span class="n">viewFrame</span><span class="o">.</span><span class="n">TransformPoint</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">viewX</span> <span class="o">=</span> <span class="n">viewFrame</span><span class="o">.</span><span class="n">TransformVector</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">viewY</span> <span class="o">=</span> <span class="n">viewFrame</span><span class="o">.</span><span class="n">TransformVector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">viewZ</span> <span class="o">=</span> <span class="n">viewFrame</span><span class="o">.</span><span class="n">TransformVector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelPointDistanceAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">viewX</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">viewOrigin</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="o">=</span><span class="s">&#39;distance_along_view_x&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelPointDistanceAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">viewY</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">viewOrigin</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="o">=</span><span class="s">&#39;distance_along_view_y&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelPointDistanceAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">viewZ</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">viewOrigin</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="o">=</span><span class="s">&#39;distance_along_view_z&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">polyData</span>

</div>
<div class="viewcode-block" id="getDebugRevolutionData"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getDebugRevolutionData">[docs]</a><span class="k">def</span> <span class="nf">getDebugRevolutionData</span><span class="p">():</span>
    <span class="c">#dataDir = os.path.abspath(os.path.join(os.path.dirname(__file__), &#39;../../../../drc-data&#39;))</span>
    <span class="c">#filename = os.path.join(dataDir, &#39;valve_wall.vtp&#39;)</span>
    <span class="c">#filename = os.path.join(dataDir, &#39;bungie_valve.vtp&#39;)</span>
    <span class="c">#filename = os.path.join(dataDir, &#39;cinder-blocks.vtp&#39;)</span>
    <span class="c">#filename = os.path.join(dataDir, &#39;cylinder_table.vtp&#39;)</span>
    <span class="c">#filename = os.path.join(dataDir, &#39;firehose.vtp&#39;)</span>
    <span class="c">#filename = os.path.join(dataDir, &#39;debris.vtp&#39;)</span>
    <span class="c">#filename = os.path.join(dataDir, &#39;rev1.vtp&#39;)</span>
    <span class="c">#filename = os.path.join(dataDir, &#39;drill-in-hand.vtp&#39;)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&#39;~/Desktop/scans/debris-scan.vtp&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">addCoordArraysToPolyData</span><span class="p">(</span><span class="n">ioUtils</span><span class="o">.</span><span class="n">readPolyData</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="getCurrentScanBundle"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getCurrentScanBundle">[docs]</a><span class="k">def</span> <span class="nf">getCurrentScanBundle</span><span class="p">():</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;SCANS_HALF_SWEEP&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">revPolyData</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">polyData</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">revPolyData</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">revPolyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">useVoxelGrid</span><span class="p">:</span>
        <span class="n">revPolyData</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">revPolyData</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">addCoordArraysToPolyData</span><span class="p">(</span><span class="n">revPolyData</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="getCurrentRevolutionData"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getCurrentRevolutionData">[docs]</a><span class="k">def</span> <span class="nf">getCurrentRevolutionData</span><span class="p">():</span>
    <span class="n">revPolyData</span> <span class="o">=</span> <span class="n">perception</span><span class="o">.</span><span class="n">_multisenseItem</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">revPolyData</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">revPolyData</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">revPolyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">getCurrentScanBundle</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">useVoxelGrid</span><span class="p">:</span>
        <span class="n">revPolyData</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">revPolyData</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">addCoordArraysToPolyData</span><span class="p">(</span><span class="n">revPolyData</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="getDisparityPointCloud"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getDisparityPointCloud">[docs]</a><span class="k">def</span> <span class="nf">getDisparityPointCloud</span><span class="p">(</span><span class="n">decimation</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">removeOutliers</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">removeSize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">imagesChannel</span><span class="o">=</span><span class="s">&#39;CAMERA&#39;</span><span class="p">,</span> <span class="n">cameraName</span><span class="o">=</span><span class="s">&#39;CAMERA_LEFT&#39;</span><span class="p">):</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">cameraview</span><span class="o">.</span><span class="n">getStereoPointCloud</span><span class="p">(</span><span class="n">decimation</span><span class="p">,</span> <span class="n">imagesChannel</span><span class="o">=</span><span class="n">imagesChannel</span><span class="p">,</span> <span class="n">cameraName</span><span class="o">=</span><span class="n">cameraName</span><span class="p">,</span> <span class="n">removeSize</span><span class="o">=</span><span class="n">removeSize</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">removeOutliers</span><span class="p">:</span>
        <span class="c"># attempt to scale outlier filtering, best tuned for decimation of 2 or 4</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">decimation</span><span class="o">*</span><span class="n">decimation</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">labelOutliers</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">neighborsInSearchRadius</span><span class="o">=</span><span class="n">scaling</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&#39;is_outlier&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">p</span>

</div>
<div class="viewcode-block" id="getCurrentMapServerData"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getCurrentMapServerData">[docs]</a><span class="k">def</span> <span class="nf">getCurrentMapServerData</span><span class="p">():</span>
    <span class="n">mapServer</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;Map Server&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">mapServer</span> <span class="ow">and</span> <span class="n">mapServer</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;Visible&#39;</span><span class="p">):</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">mapServer</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">polyData</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">polyData</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">addCoordArraysToPolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>

</div>
<span class="n">useVoxelGrid</span> <span class="o">=</span> <span class="bp">False</span>




<div class="viewcode-block" id="segmentGroundPlanes"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentGroundPlanes">[docs]</a><span class="k">def</span> <span class="nf">segmentGroundPlanes</span><span class="p">():</span>

    <span class="n">objs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">om</span><span class="o">.</span><span class="n">getObjects</span><span class="p">():</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">):</span>
            <span class="n">objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="n">objs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">objs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">))</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>

    <span class="n">prevHeadAxis</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;----- </span><span class="si">%s</span><span class="s">---------&#39;</span> <span class="o">%</span> <span class="n">name</span>
        <span class="k">print</span>  <span class="s">&#39;head axis:&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">headAxis</span>
        <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">groundPoints</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">segmentGround</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">polyData</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;ground normal:&#39;</span><span class="p">,</span> <span class="n">normal</span>
        <span class="n">showPolyData</span><span class="p">(</span><span class="n">groundPoints</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39; ground points&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
            <span class="k">print</span> <span class="mi">180</span> <span class="o">-</span> <span class="n">diff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">diff</span>

        <span class="k">if</span> <span class="n">prevHeadAxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">prevHeadAxis</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">headAxis</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">))))</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                <span class="k">print</span> <span class="mi">180</span> <span class="o">-</span> <span class="n">diff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">diff</span>
        <span class="n">prevHeadAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">headAxis</span><span class="p">)</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">normal</span><span class="p">)</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;normals&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="extractCircle"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.extractCircle">[docs]</a><span class="k">def</span> <span class="nf">extractCircle</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">radiusLimit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="n">circleFit</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPCLSACSegmentationCircle</span><span class="p">()</span>
    <span class="n">circleFit</span><span class="o">.</span><span class="n">SetDistanceThreshold</span><span class="p">(</span><span class="n">distanceThreshold</span><span class="p">)</span>
    <span class="n">circleFit</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">radiusLimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">circleFit</span><span class="o">.</span><span class="n">SetRadiusLimit</span><span class="p">(</span><span class="n">radiusLimit</span><span class="p">)</span>
        <span class="n">circleFit</span><span class="o">.</span><span class="n">SetRadiusConstraintEnabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">circleFit</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">circleFit</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">(),</span> <span class="s">&#39;ransac_labels&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">polyData</span><span class="p">,</span> <span class="n">circleFit</span>

</div>
<div class="viewcode-block" id="removeMajorPlane"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.removeMajorPlane">[docs]</a><span class="k">def</span> <span class="nf">removeMajorPlane</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>

    <span class="c"># perform plane segmentation</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">planeSegmentationFilter</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetDistanceThreshold</span><span class="p">(</span><span class="n">distanceThreshold</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">(),</span> <span class="s">&#39;ransac_labels&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">polyData</span><span class="p">,</span> <span class="n">f</span>

</div>
<div class="viewcode-block" id="removeGroundSimple"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.removeGroundSimple">[docs]</a><span class="k">def</span> <span class="nf">removeGroundSimple</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">groundThickness</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">sceneHeightFromGround</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Simple ground plane removal algorithm. Uses ground height</span>
<span class="sd">        and does simple z distance filtering.</span>
<span class="sd">        Suitable for noisy data e.g. kinect/stereo camera</span>
<span class="sd">        (Default args should be relaxed, filtering simplfied)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">groundHeight</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getGroundHeight</span><span class="p">()</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">groundHeight</span><span class="p">]</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">points</span> <span class="o">-</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">)</span>

    <span class="n">groundPoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">groundThickness</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">groundThickness</span><span class="o">/</span><span class="mf">2.0</span><span class="p">])</span>
    <span class="n">scenePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">sceneHeightFromGround</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">groundPoints</span><span class="p">,</span> <span class="n">scenePoints</span>

</div>
<div class="viewcode-block" id="removeGround"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.removeGround">[docs]</a><span class="k">def</span> <span class="nf">removeGround</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">groundThickness</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">sceneHeightFromGround</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">groundPoints</span><span class="p">,</span> <span class="n">scenePoints</span> <span class="o">=</span> <span class="n">segmentGround</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">groundThickness</span><span class="p">,</span> <span class="n">sceneHeightFromGround</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">groundPoints</span><span class="p">,</span> <span class="n">scenePoints</span>

</div>
<div class="viewcode-block" id="generateFeetForValve"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.generateFeetForValve">[docs]</a><span class="k">def</span> <span class="nf">generateFeetForValve</span><span class="p">():</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;valve affordance&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">aff</span>


    <span class="n">params</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">])</span>
    <span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;axis&#39;</span><span class="p">]</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>

    <span class="n">stanceWidth</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">stanceRotation</span> <span class="o">=</span> <span class="mf">25.0</span>
    <span class="n">stanceOffset</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

    <span class="n">valveFrame</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">valveFrame</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">valveFrame</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">stanceFrame</span><span class="p">,</span> <span class="n">lfootFrame</span><span class="p">,</span> <span class="n">rfootFrame</span> <span class="o">=</span> <span class="n">getFootFramesFromReferenceFrame</span><span class="p">(</span><span class="n">valveFrame</span><span class="p">,</span> <span class="n">stanceWidth</span><span class="p">,</span> <span class="n">stanceRotation</span><span class="p">,</span> <span class="n">stanceOffset</span><span class="p">)</span>

    <span class="n">showFrame</span><span class="p">(</span><span class="n">boardFrame</span><span class="p">,</span> <span class="s">&#39;board ground frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">showFrame</span><span class="p">(</span><span class="n">lfootFrame</span><span class="p">,</span> <span class="s">&#39;lfoot frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">showFrame</span><span class="p">(</span><span class="n">rfootFrame</span><span class="p">,</span> <span class="s">&#39;rfoot frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

    <span class="c">#d = DebugData()</span>
    <span class="c">#d.addLine(valveFrame.GetPosition(), stanceFrame.GetPosition())</span>
    <span class="c">#updatePolyData(d.getPolyData(), &#39;stance debug&#39;)</span>
    <span class="c">#publishSteppingGoal(lfootFrame, rfootFrame)</span>

</div>
<div class="viewcode-block" id="generateFeetForDebris"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.generateFeetForDebris">[docs]</a><span class="k">def</span> <span class="nf">generateFeetForDebris</span><span class="p">():</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;board A&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">aff</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">])</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;zaxis&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;zwidth&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;xaxis&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;xwidth&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;zaxis&#39;</span><span class="p">]</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>

    <span class="n">stanceWidth</span> <span class="o">=</span> <span class="mf">0.35</span>
    <span class="n">stanceRotation</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">stanceOffset</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.48</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">boardFrame</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">boardFrame</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">boardFrame</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">stanceFrame</span><span class="p">,</span> <span class="n">lfootFrame</span><span class="p">,</span> <span class="n">rfootFrame</span> <span class="o">=</span> <span class="n">getFootFramesFromReferenceFrame</span><span class="p">(</span><span class="n">boardFrame</span><span class="p">,</span> <span class="n">stanceWidth</span><span class="p">,</span> <span class="n">stanceRotation</span><span class="p">,</span> <span class="n">stanceOffset</span><span class="p">)</span>

    <span class="n">showFrame</span><span class="p">(</span><span class="n">boardFrame</span><span class="p">,</span> <span class="s">&#39;board ground frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">lfoot</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">lfootFrame</span><span class="p">,</span> <span class="s">&#39;lfoot frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">rfoot</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">rfootFrame</span><span class="p">,</span> <span class="s">&#39;rfoot frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="n">lfoot</span><span class="p">,</span> <span class="n">rfoot</span><span class="p">]:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="c">#d = DebugData()</span>
    <span class="c">#d.addLine(valveFrame.GetPosition(), stanceFrame.GetPosition())</span>
    <span class="c">#updatePolyData(d.getPolyData(), &#39;stance debug&#39;)</span>
    <span class="c">#publishSteppingGoal(lfootFrame, rfootFrame)</span>

</div>
<div class="viewcode-block" id="generateFeetForWye"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.generateFeetForWye">[docs]</a><span class="k">def</span> <span class="nf">generateFeetForWye</span><span class="p">():</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;wye points&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">aff</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">])</span>
    <span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;xaxis&#39;</span><span class="p">]</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;zaxis&#39;</span><span class="p">]</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>

    <span class="n">stanceWidth</span> <span class="o">=</span> <span class="mf">0.20</span>
    <span class="n">stanceRotation</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">stanceOffset</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.48</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">affGroundFrame</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">affGroundFrame</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">affGroundFrame</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">stanceFrame</span><span class="p">,</span> <span class="n">lfootFrame</span><span class="p">,</span> <span class="n">rfootFrame</span> <span class="o">=</span> <span class="n">getFootFramesFromReferenceFrame</span><span class="p">(</span><span class="n">affGroundFrame</span><span class="p">,</span> <span class="n">stanceWidth</span><span class="p">,</span> <span class="n">stanceRotation</span><span class="p">,</span> <span class="n">stanceOffset</span><span class="p">)</span>

    <span class="n">showFrame</span><span class="p">(</span><span class="n">affGroundFrame</span><span class="p">,</span> <span class="s">&#39;affordance ground frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">lfoot</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">lfootFrame</span><span class="p">,</span> <span class="s">&#39;lfoot frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">rfoot</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">rfootFrame</span><span class="p">,</span> <span class="s">&#39;rfoot frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="n">lfoot</span><span class="p">,</span> <span class="n">rfoot</span><span class="p">]:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>


</div>
<div class="viewcode-block" id="getFootFramesFromReferenceFrame"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getFootFramesFromReferenceFrame">[docs]</a><span class="k">def</span> <span class="nf">getFootFramesFromReferenceFrame</span><span class="p">(</span><span class="n">referenceFrame</span><span class="p">,</span> <span class="n">stanceWidth</span><span class="p">,</span> <span class="n">stanceRotation</span><span class="p">,</span> <span class="n">stanceOffset</span><span class="p">):</span>

    <span class="n">footHeight</span><span class="o">=</span><span class="mf">0.0745342</span>

    <span class="n">ref</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">ref</span><span class="o">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="n">referenceFrame</span><span class="o">.</span><span class="n">GetMatrix</span><span class="p">())</span>

    <span class="n">stanceFrame</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">stanceFrame</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">stanceFrame</span><span class="o">.</span><span class="n">RotateZ</span><span class="p">(</span><span class="n">stanceRotation</span><span class="p">)</span>
    <span class="n">stanceFrame</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">stanceOffset</span><span class="p">)</span>
    <span class="n">stanceFrame</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

    <span class="n">lfootFrame</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">lfootFrame</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">lfootFrame</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stanceWidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">footHeight</span><span class="p">)</span>
    <span class="n">lfootFrame</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">stanceFrame</span><span class="p">)</span>

    <span class="n">rfootFrame</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">rfootFrame</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">rfootFrame</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">stanceWidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">footHeight</span><span class="p">)</span>
    <span class="n">rfootFrame</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">stanceFrame</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stanceFrame</span><span class="p">,</span> <span class="n">lfootFrame</span><span class="p">,</span> <span class="n">rfootFrame</span>

</div>
<div class="viewcode-block" id="poseFromFrame"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.poseFromFrame">[docs]</a><span class="k">def</span> <span class="nf">poseFromFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>

    <span class="n">trans</span> <span class="o">=</span> <span class="n">lcmdrc</span><span class="o">.</span><span class="n">vector_3d_t</span><span class="p">()</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">trans</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">trans</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()</span>

    <span class="n">wxyz</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">perception</span><span class="o">.</span><span class="n">drc</span><span class="o">.</span><span class="n">vtkMultisenseSource</span><span class="o">.</span><span class="n">GetBotQuaternion</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">wxyz</span><span class="p">)</span>
    <span class="n">quat</span> <span class="o">=</span> <span class="n">lcmdrc</span><span class="o">.</span><span class="n">quaternion_t</span><span class="p">()</span>
    <span class="n">quat</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="n">quat</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">quat</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">quat</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">wxyz</span>

    <span class="n">pose</span> <span class="o">=</span> <span class="n">lcmdrc</span><span class="o">.</span><span class="n">position_3d_t</span><span class="p">()</span>
    <span class="n">pose</span><span class="o">.</span><span class="n">translation</span> <span class="o">=</span> <span class="n">trans</span>
    <span class="n">pose</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">quat</span>
    <span class="k">return</span> <span class="n">pose</span>

</div>
<div class="viewcode-block" id="cropToPlane"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.cropToPlane">[docs]</a><span class="k">def</span> <span class="nf">cropToPlane</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">normal</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">points</span> <span class="o">-</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">)</span>
    <span class="n">cropped</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cropped</span><span class="p">,</span> <span class="n">polyData</span>

</div>
<div class="viewcode-block" id="createLine"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.createLine">[docs]</a><span class="k">def</span> <span class="nf">createLine</span><span class="p">(</span><span class="n">blockDimensions</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>


    <span class="n">sliceWidth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">blockDimensions</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="mf">0.02</span>
    <span class="n">sliceThreshold</span> <span class="o">=</span>  <span class="p">[</span><span class="o">-</span><span class="n">sliceWidth</span><span class="p">,</span> <span class="n">sliceWidth</span><span class="p">]</span>


    <span class="c"># require p1 to be point on left</span>
    <span class="k">if</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p1</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">worldPt1</span> <span class="o">=</span> <span class="n">getRayFromDisplayPoint</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getCurrentRenderView</span><span class="p">(),</span> <span class="n">p1</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">worldPt2</span> <span class="o">=</span> <span class="n">getRayFromDisplayPoint</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getCurrentRenderView</span><span class="p">(),</span> <span class="n">p2</span><span class="p">)</span>

    <span class="n">cameraPt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getCurrentRenderView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>

    <span class="n">leftRay</span> <span class="o">=</span> <span class="n">worldPt1</span> <span class="o">-</span> <span class="n">cameraPt</span>
    <span class="n">rightRay</span> <span class="o">=</span> <span class="n">worldPt2</span> <span class="o">-</span> <span class="n">cameraPt</span>
    <span class="n">middleRay</span> <span class="o">=</span> <span class="p">(</span><span class="n">leftRay</span> <span class="o">+</span> <span class="n">rightRay</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>


    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">cameraPt</span><span class="p">,</span> <span class="n">worldPt1</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">cameraPt</span><span class="p">,</span> <span class="n">worldPt2</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">worldPt1</span><span class="p">,</span> <span class="n">worldPt2</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">cameraPt</span><span class="p">,</span> <span class="n">cameraPt</span> <span class="o">+</span> <span class="n">middleRay</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;line annotation&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inputObj</span><span class="p">:</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">getCurrentRevolutionData</span><span class="p">()</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">cameraPt</span>

    <span class="n">normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rightRay</span><span class="p">,</span> <span class="n">leftRay</span><span class="p">)</span>
    <span class="n">leftNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">leftRay</span><span class="p">)</span>
    <span class="n">rightNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rightRay</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>

    <span class="n">normal</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
    <span class="n">leftNormal</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">leftNormal</span><span class="p">)</span>
    <span class="n">rightNormal</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rightNormal</span><span class="p">)</span>
    <span class="n">middleRay</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">middleRay</span><span class="p">)</span>

    <span class="n">cropped</span><span class="p">,</span> <span class="n">polyData</span> <span class="o">=</span> <span class="n">cropToPlane</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">sliceThreshold</span><span class="p">)</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;slice dist&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="n">colorByRange</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span> <span class="s">&#39;slice&#39;</span><span class="p">,</span>  <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">cropped</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cropToPlane</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">leftNormal</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">1e6</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">cropped</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cropToPlane</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">rightNormal</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">1e6</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span> <span class="s">&#39;slice segment&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">planePoints</span><span class="p">,</span> <span class="n">planeNormal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="n">middleRay</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">60</span><span class="p">))</span>
    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;board segmentation&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">getRandomColor</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    names = [&#39;board A&#39;, &#39;board B&#39;, &#39;board C&#39;, &#39;board D&#39;, &#39;board E&#39;, &#39;board F&#39;, &#39;board G&#39;, &#39;board H&#39;, &#39;board I&#39;]</span>
<span class="sd">    for name in names:</span>
<span class="sd">        if not om.findObjectByName(name):</span>
<span class="sd">            break</span>
<span class="sd">    else:</span>
<span class="sd">        name = &#39;board&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;board&#39;</span>

    <span class="n">segmentBlockByTopPlane</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="n">blockDimensions</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=-</span><span class="n">middleRay</span><span class="p">,</span> <span class="n">expectedXAxis</span><span class="o">=</span><span class="n">middleRay</span><span class="p">,</span> <span class="n">edgeSign</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="updateBlockAffordances"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.updateBlockAffordances">[docs]</a><span class="k">def</span> <span class="nf">updateBlockAffordances</span><span class="p">(</span><span class="n">polyData</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">om</span><span class="o">.</span><span class="n">getObjects</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">BoxAffordanceItem</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;refit&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">):</span>
                <span class="n">om</span><span class="o">.</span><span class="n">removeFromObjectModel</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">om</span><span class="o">.</span><span class="n">getObjects</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">BoxAffordanceItem</span><span class="p">):</span>
            <span class="n">updateBlockFit</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">polyData</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="updateBlockFit"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.updateBlockFit">[docs]</a><span class="k">def</span> <span class="nf">updateBlockFit</span><span class="p">(</span><span class="n">affordanceObj</span><span class="p">,</span> <span class="n">polyData</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="n">affordanceObj</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">affordanceObj</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; refit&#39;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">affordanceObj</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">]</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">affordanceObj</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;yaxis&#39;</span><span class="p">]</span>
    <span class="n">edgePerpAxis</span> <span class="o">=</span> <span class="n">affordanceObj</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;xaxis&#39;</span><span class="p">]</span>
    <span class="n">blockDimensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">affordanceObj</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;xwidth&#39;</span><span class="p">],</span> <span class="n">affordanceObj</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;ywidth&#39;</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">polyData</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span><span class="p">)</span>

    <span class="n">cropThreshold</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">cropped</span> <span class="o">=</span> <span class="n">polyData</span>
    <span class="n">cropped</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cropToPlane</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">cropThreshold</span><span class="p">,</span> <span class="n">cropThreshold</span><span class="p">])</span>
    <span class="n">cropped</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cropToPlane</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">edgePerpAxis</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">cropThreshold</span><span class="p">,</span> <span class="n">cropThreshold</span><span class="p">])</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span> <span class="s">&#39;refit search region&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">cropped</span> <span class="o">=</span> <span class="n">extractLargestCluster</span><span class="p">(</span><span class="n">cropped</span><span class="p">)</span>

    <span class="n">planePoints</span><span class="p">,</span> <span class="n">planeNormal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="n">normal</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;refit board segmentation&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">refitObj</span> <span class="o">=</span> <span class="n">segmentBlockByTopPlane</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="n">blockDimensions</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">normal</span><span class="p">,</span> <span class="n">expectedXAxis</span><span class="o">=</span><span class="n">edgePerpAxis</span><span class="p">,</span> <span class="n">edgeSign</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">refitOrigin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">refitObj</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">])</span>
    <span class="n">refitLength</span> <span class="o">=</span> <span class="n">refitObj</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;zwidth&#39;</span><span class="p">]</span>
    <span class="n">refitZAxis</span> <span class="o">=</span> <span class="n">refitObj</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;zaxis&#39;</span><span class="p">]</span>
    <span class="n">refitEndPoint1</span> <span class="o">=</span> <span class="n">refitOrigin</span> <span class="o">+</span> <span class="n">refitZAxis</span><span class="o">*</span><span class="n">refitLength</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="n">originalLength</span> <span class="o">=</span> <span class="n">affordanceObj</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;zwidth&#39;</span><span class="p">]</span>
    <span class="n">correctedOrigin</span> <span class="o">=</span> <span class="n">refitEndPoint1</span> <span class="o">-</span> <span class="n">refitZAxis</span><span class="o">*</span><span class="n">originalLength</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">originDelta</span> <span class="o">=</span> <span class="n">correctedOrigin</span> <span class="o">-</span> <span class="n">refitOrigin</span>

    <span class="n">refitObj</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;zwidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">originalLength</span>
    <span class="n">refitObj</span><span class="o">.</span><span class="n">polyData</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">(</span><span class="n">affordanceObj</span><span class="o">.</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">refitObj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetUserTransform</span><span class="p">()</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">originDelta</span><span class="p">)</span>
    <span class="n">refitObj</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="startInteractiveLineDraw"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startInteractiveLineDraw">[docs]</a><span class="k">def</span> <span class="nf">startInteractiveLineDraw</span><span class="p">(</span><span class="n">blockDimensions</span><span class="p">):</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">LineDraw</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getCurrentRenderView</span><span class="p">())</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">createLine</span><span class="p">,</span> <span class="n">blockDimensions</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startLeverValveSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startLeverValveSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startLeverValveSegmentation</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentLeverValve</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="refitValveAffordance"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.refitValveAffordance">[docs]</a><span class="k">def</span> <span class="nf">refitValveAffordance</span><span class="p">(</span><span class="n">aff</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">):</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;xaxis&#39;</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;yaxis&#39;</span><span class="p">]</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;zaxis&#39;</span><span class="p">]</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">]</span>

    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">normal</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetUserTransform</span><span class="p">()</span><span class="o">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">GetMatrix</span><span class="p">())</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="segmentValve"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentValve">[docs]</a><span class="k">def</span> <span class="nf">segmentValve</span><span class="p">(</span><span class="n">expectedValveRadius</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">viewPlaneNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">getSegmentationView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">())</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">wallNormal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">viewPlaneNormal</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="n">wallPoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">wallPoints</span><span class="p">,</span> <span class="s">&#39;wall points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">polyData</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">wallNormal</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point2</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="n">expectedValveRadius</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">valveCluster</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">valveCluster</span> <span class="o">=</span> <span class="n">cropToSphere</span><span class="p">(</span><span class="n">valveCluster</span><span class="p">,</span> <span class="n">point2</span><span class="p">,</span> <span class="n">expectedValveRadius</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">valveCluster</span> <span class="o">=</span> <span class="n">extractLargestCluster</span><span class="p">(</span><span class="n">valveCluster</span><span class="p">,</span>  <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">valveCluster</span><span class="p">,</span> <span class="s">&#39;valve cluster&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">valveCluster</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span> <span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">wallNormal</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">zwidth</span> <span class="o">=</span> <span class="mf">0.03</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">expectedValveRadius</span>


    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">zwidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">zwidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]),</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;valve affordance&#39;</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;affordances&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>
    <span class="n">refitWallCallbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">refitValveAffordance</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>

    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">zwidth</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span>
                  <span class="n">xwidth</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="n">zwidth</span><span class="p">,</span>
                  <span class="n">otdf_type</span><span class="o">=</span><span class="s">&#39;steering_cyl&#39;</span><span class="p">,</span> <span class="n">friendly_name</span><span class="o">=</span><span class="s">&#39;valve&#39;</span><span class="p">)</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>

    <span class="n">frameObj</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetUserTransform</span><span class="p">(),</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39; frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">frameObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="segmentValveByBoundingBox"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentValveByBoundingBox">[docs]</a><span class="k">def</span> <span class="nf">segmentValveByBoundingBox</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">):</span>

    <span class="n">viewDirection</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewDirection</span><span class="p">()</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">cropToSphere</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>

    <span class="c"># extract tube search region</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelDistanceToLine</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">searchPoint</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;distance_to_line&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="s">&#39;valve tube search region&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># guess valve plane</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="n">viewDirection</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">expectedNormal</span><span class="o">=-</span><span class="n">viewDirection</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># extract plane search region</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelPointDistanceAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;distance_along_axis&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="s">&#39;valve plane search region&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;distance_along_axis&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">valvePoints</span> <span class="o">=</span> <span class="n">extractLargestCluster</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">valvePoints</span><span class="p">,</span> <span class="s">&#39;valve cluster&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">valvePoints</span><span class="p">,</span> <span class="n">_</span>  <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">valvePoints</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">normal</span><span class="p">,</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="n">normal</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">valveFit</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">valvePoints</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">valveFit</span><span class="p">,</span> <span class="s">&#39;valve cluster&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">valveFit</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">zvalues</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">minZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">zvalues</span><span class="p">)</span>
    <span class="n">maxZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">zvalues</span><span class="p">)</span>

    <span class="n">tubeRadius</span> <span class="o">=</span> <span class="mf">0.017</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">maxZ</span> <span class="o">-</span> <span class="n">minZ</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">tubeRadius</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="n">makePolyDataFields</span><span class="p">(</span><span class="n">valveFit</span><span class="p">)</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>

    <span class="c">#origin = computeCentroid(valveFit)</span>

    <span class="n">zaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">normal</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">pose</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">poseFromTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">classname</span><span class="o">=</span><span class="s">&#39;CapsuleRingAffordanceItem&#39;</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="s">&#39;valve&#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">newUUID</span><span class="p">(),</span> <span class="n">pose</span><span class="o">=</span><span class="n">pose</span><span class="p">,</span> <span class="n">Color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">Segments</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">desc</span><span class="p">[</span><span class="s">&#39;Tube Radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tubeRadius</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">affordanceManager</span><span class="o">.</span><span class="n">newAffordanceFromDescription</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">obj</span>

</div>
<div class="viewcode-block" id="segmentDoorPlane"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDoorPlane">[docs]</a><span class="k">def</span> <span class="nf">segmentDoorPlane</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">doorPoint</span><span class="p">,</span> <span class="n">stanceFrame</span><span class="p">):</span>

    <span class="n">doorPoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">doorPoint</span><span class="p">)</span>
    <span class="n">doorBand</span> <span class="o">=</span> <span class="mf">1.5</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">cropToLineSegment</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">doorPoint</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">doorBand</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="n">doorPoint</span> <span class="o">-</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">doorBand</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">fitPoints</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyLocalPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">doorPoint</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">searchRadiusEnd</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">removeGroundFirst</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">fitPoints</span><span class="p">,</span> <span class="s">&#39;door points&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">viewDirection</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewDirection</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">viewDirection</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">computeCentroid</span><span class="p">(</span><span class="n">fitPoints</span><span class="p">)</span>
    <span class="n">groundHeight</span> <span class="o">=</span> <span class="n">stanceFrame</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">groundHeight</span><span class="p">]</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">t</span>

</div>
<div class="viewcode-block" id="segmentValveByRim"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentValveByRim">[docs]</a><span class="k">def</span> <span class="nf">segmentValveByRim</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">rimPoint1</span><span class="p">,</span> <span class="n">rimPoint2</span><span class="p">):</span>

    <span class="n">viewDirection</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewDirection</span><span class="p">()</span>

    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rimPoint2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rimPoint1</span><span class="p">)</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>

    <span class="c"># flip xaxis to be with view direction</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">viewDirection</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">xaxis</span>

    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rimPoint2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rimPoint1</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelPointDistanceAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;distance_along_axis&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;valve plane region&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;distance_along_axis&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">polyData</span> <span class="o">=</span> <span class="n">cropToSphere</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;valve search region&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">valveFit</span> <span class="o">=</span> <span class="n">extractLargestCluster</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">valveFit</span><span class="p">,</span> <span class="s">&#39;valve cluster&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">valveFit</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">zvalues</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">minZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">zvalues</span><span class="p">)</span>
    <span class="n">maxZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">zvalues</span><span class="p">)</span>

    <span class="n">tubeRadius</span> <span class="o">=</span> <span class="mf">0.017</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">maxZ</span> <span class="o">-</span> <span class="n">minZ</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">tubeRadius</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="n">makePolyDataFields</span><span class="p">(</span><span class="n">valveFit</span><span class="p">)</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">updatePolyData</span><span class="p">(</span><span class="n">transformPolyData</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">box</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">frame</span><span class="p">),</span> <span class="s">&#39;valve cluster bounding box&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c">#origin = computeCentroid(valveFit)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    zaxis = [0,0,1]</span>
<span class="sd">    xaxis = normal</span>
<span class="sd">    yaxis = np.cross(zaxis, xaxis)</span>
<span class="sd">    yaxis /= np.linalg.norm(yaxis)</span>
<span class="sd">    xaxis = np.cross(yaxis, zaxis)</span>
<span class="sd">    xaxis /= np.linalg.norm(xaxis)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">tubeRadius</span>


    <span class="n">proj</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">axes</span><span class="p">]</span>
    <span class="n">xaxisNew</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">proj</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xaxisNew</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xaxisNew</span> <span class="o">=</span> <span class="o">-</span><span class="n">xaxisNew</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">xaxisNew</span>

    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>


    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">pose</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">poseFromTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">classname</span><span class="o">=</span><span class="s">&#39;CapsuleRingAffordanceItem&#39;</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="s">&#39;valve&#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">newUUID</span><span class="p">(),</span> <span class="n">pose</span><span class="o">=</span><span class="n">pose</span><span class="p">,</span> <span class="n">Color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Radius</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span> <span class="n">Segments</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">desc</span><span class="p">[</span><span class="s">&#39;Tube Radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tubeRadius</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">affordanceManager</span><span class="o">.</span><span class="n">newAffordanceFromDescription</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">obj</span>

</div>
<div class="viewcode-block" id="segmentValveByWallPlane"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentValveByWallPlane">[docs]</a><span class="k">def</span> <span class="nf">segmentValveByWallPlane</span><span class="p">(</span><span class="n">expectedValveRadius</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>


    <span class="n">centerPoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">point1</span> <span class="o">+</span> <span class="n">point2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">_</span> <span class="p">,</span> <span class="n">polyData</span> <span class="o">=</span>  <span class="n">removeGround</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>

    <span class="n">viewDirection</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewDirection</span><span class="p">()</span>
    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=-</span><span class="n">viewDirection</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="n">perpLine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">point2</span> <span class="o">-</span> <span class="n">point1</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="c">#perpLine /= np.linalg.norm(perpLine)</span>
    <span class="c">#perpLine * np.linalg.norm(point2 - point1)/2.0</span>
    <span class="n">point3</span><span class="p">,</span> <span class="n">point4</span> <span class="o">=</span> <span class="n">centerPoint</span> <span class="o">+</span> <span class="n">perpLine</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">centerPoint</span> <span class="o">-</span> <span class="n">perpLine</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">point3</span><span class="p">,</span> <span class="n">point4</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;crop lines&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">wallPoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">wallPoints</span><span class="p">,</span> <span class="s">&#39;valve wall&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">cropToLineSegment</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">)</span>
    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">cropToLineSegment</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">point3</span><span class="p">,</span> <span class="n">point4</span><span class="p">)</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="s">&#39;valve search region&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">searchRegionSpokes</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">)</span>

    <span class="n">searchRegion</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">_</span>  <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">normal</span><span class="p">,</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="n">normal</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">])</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="s">&#39;valve search region 2&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">largestCluster</span> <span class="o">=</span> <span class="n">extractLargestCluster</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">largestCluster</span><span class="p">,</span> <span class="s">&#39;valve cluster&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">radiusLimit</span> <span class="o">=</span> <span class="p">[</span><span class="n">expectedValveRadius</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">expectedValveRadius</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">]</span> <span class="k">if</span> <span class="n">expectedValveRadius</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="c">#radiusLimit = None</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">circleFit</span> <span class="o">=</span> <span class="n">extractCircle</span><span class="p">(</span><span class="n">largestCluster</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">radiusLimit</span><span class="o">=</span><span class="n">radiusLimit</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;circle fit&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="c">#polyData, circleFit = extractCircle(polyData, distanceThreshold=0.01)</span>
    <span class="c">#showPolyData(polyData, &#39;circle fit&#39;, colorByName=&#39;z&#39;)</span>


    <span class="n">radius</span> <span class="o">=</span> <span class="n">circleFit</span><span class="o">.</span><span class="n">GetCircleRadius</span><span class="p">()</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">circleFit</span><span class="o">.</span><span class="n">GetCircleOrigin</span><span class="p">())</span>
    <span class="n">circleNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">circleFit</span><span class="o">.</span><span class="n">GetCircleNormal</span><span class="p">())</span>
    <span class="n">circleNormal</span> <span class="o">=</span> <span class="n">circleNormal</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">circleNormal</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">circleNormal</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">circleNormal</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c"># force use of the plane normal</span>
    <span class="n">circleNormal</span> <span class="o">=</span> <span class="n">normal</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">expectedValveRadius</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">origin</span> <span class="o">-</span> <span class="n">normal</span><span class="o">*</span><span class="n">radius</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">normal</span><span class="o">*</span><span class="n">radius</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCircle</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">circleNormal</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;valve axes&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">zaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">circleNormal</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="c">#t = getTransformFromAxes(xaxis, yaxis, zaxis) # this was added to be consistent with segmentValveByRim</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="o">-</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span> <span class="c"># this was added to be consistent with segmentValveByRim</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>


    <span class="c"># Spoke angle fitting:</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> <span class="c"># disabled jan 2015</span>
        <span class="c"># extract the relative positon of the points to the valve axis:</span>
        <span class="n">searchRegionSpokes</span> <span class="o">=</span> <span class="n">labelDistanceToLine</span><span class="p">(</span><span class="n">searchRegionSpokes</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="p">[</span><span class="n">origin</span> <span class="o">+</span> <span class="n">circleNormal</span><span class="p">])</span>
        <span class="n">searchRegionSpokes</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">searchRegionSpokes</span><span class="p">,</span> <span class="s">&#39;distance_to_line&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">radius</span><span class="o">-</span><span class="mf">0.04</span><span class="p">])</span>
        <span class="n">updatePolyData</span><span class="p">(</span><span class="n">searchRegionSpokes</span><span class="p">,</span> <span class="s">&#39;valve spoke search&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">searchRegionSpokesLocal</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">searchRegionSpokes</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">GetLinearInverse</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">searchRegionSpokesLocal</span> <span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>

        <span class="n">spoke_angle</span> <span class="o">=</span> <span class="n">findValveSpokeAngle</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spoke_angle</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">spokeAngleTransform</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">spoke_angle</span><span class="p">])</span>
    <span class="n">spokeTransform</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">copyFrame</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">spokeAngleTransform</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">spokeTransform</span><span class="p">)</span>
    <span class="n">spokeObj</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">spokeAngleTransform</span><span class="p">,</span> <span class="s">&#39;spoke frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>
    <span class="n">spokeObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">spokeAngleTransform</span>

    <span class="n">tubeRadius</span> <span class="o">=</span> <span class="mf">0.017</span>

    <span class="n">pose</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">poseFromTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">classname</span><span class="o">=</span><span class="s">&#39;CapsuleRingAffordanceItem&#39;</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="s">&#39;valve&#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">newUUID</span><span class="p">(),</span> <span class="n">pose</span><span class="o">=</span><span class="n">pose</span><span class="p">,</span> <span class="n">Color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Radius</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span> <span class="n">Segments</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">desc</span><span class="p">[</span><span class="s">&#39;Tube Radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tubeRadius</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">affordanceManager</span><span class="o">.</span><span class="n">newAffordanceFromDescription</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>



</div>
<div class="viewcode-block" id="showHistogram"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.showHistogram">[docs]</a><span class="k">def</span> <span class="nf">showHistogram</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">arrayName</span><span class="p">,</span> <span class="n">numberOfBins</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">vnp</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">arrayName</span><span class="p">)</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">numberOfBins</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;center&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">bins</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">hist</span><span class="p">)]</span> <span class="o">+</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span>

</div>
<div class="viewcode-block" id="applyKmeansLabel"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.applyKmeansLabel">[docs]</a><span class="k">def</span> <span class="nf">applyKmeansLabel</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">arrayName</span><span class="p">,</span> <span class="n">numberOfClusters</span><span class="p">,</span> <span class="n">whiten</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="kn">import</span> <span class="nn">scipy.cluster</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="n">vnp</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">arrayName</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">whiten</span><span class="p">:</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">vq</span><span class="o">.</span><span class="n">whiten</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span>

    <span class="n">codes</span><span class="p">,</span> <span class="n">disturbances</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">vq</span><span class="o">.</span><span class="n">kmeans</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">numberOfClusters</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">arrayName</span> <span class="o">==</span> <span class="s">&#39;normals&#39;</span> <span class="ow">and</span> <span class="n">numberOfClusters</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">codes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">v1</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
        <span class="n">v2</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span>
        <span class="k">print</span> <span class="s">&#39;angle between normals:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

    <span class="n">code</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">vq</span><span class="o">.</span><span class="n">vq</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">vnp</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_kmeans_label&#39;</span> <span class="o">%</span> <span class="n">arrayName</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">polyData</span>

</div>
<div class="viewcode-block" id="findValveSpokeAngle"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.findValveSpokeAngle">[docs]</a><span class="k">def</span> <span class="nf">findValveSpokeAngle</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Determine the location of the valve spoke angle</span>
<span class="sd">    By binning the spoke returns. returns angle in degrees</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">#np.savetxt(&quot;/home/mfallon/Desktop/spoke_points.csv&quot;, points, delimiter=&quot;,&quot;)</span>


    <span class="c"># convert all points to degrees in range [0,120]</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span> <span class="n">points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span>  <span class="n">points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">qq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">angle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">angle</span><span class="p">[</span><span class="n">qq</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">360</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span> <span class="n">angle</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>

    <span class="c"># find the spoke as the max of a histogram:</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>  <span class="c"># 0,10,...130</span>
    <span class="n">freq</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
    <span class="n">amax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
    <span class="n">spoke_angle</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="n">amax</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span> <span class="c"># correct for 5deg offset</span>

    <span class="k">return</span> <span class="n">spoke_angle</span>


</div>
<div class="viewcode-block" id="findWallCenter"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.findWallCenter">[docs]</a><span class="k">def</span> <span class="nf">findWallCenter</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">removeGroundMethod</span><span class="o">=</span><span class="n">removeGround</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find a frame at the center of the valve wall</span>
<span class="sd">    X&amp;Y: average of points on the wall plane</span>
<span class="sd">    Z: 4 feet off the ground (determined using robot&#39;s feet</span>
<span class="sd">    Orientation: z-normal into plane, y-axis horizontal</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">_</span> <span class="p">,</span> <span class="n">polyData</span> <span class="o">=</span>  <span class="n">removeGroundMethod</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>

    <span class="n">viewDirection</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewDirection</span><span class="p">()</span>
    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=-</span><span class="n">viewDirection</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">wallPoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">wallPoints</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">wallPoints</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
    <span class="n">wallPoints</span> <span class="o">=</span> <span class="n">extractLargestCluster</span><span class="p">(</span><span class="n">wallPoints</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">wallPoints</span><span class="p">,</span> <span class="s">&#39;auto valve wall&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">xvalues</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">wallPoints</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yvalues</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">wallPoints</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="c"># median or mid of max or min?</span>
    <span class="c">#xcenter = np.median(xvalues)</span>
    <span class="c">#ycenter = np.median(yvalues)</span>
    <span class="n">xcenter</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xvalues</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xvalues</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">ycenter</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yvalues</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">yvalues</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>

    <span class="c"># not used, not very reliable</span>
    <span class="c">#zvalues = vtkNumpy.getNumpyFromVtk(wallPoints, &#39;Points&#39;)[:,2]</span>
    <span class="c">#zcenter = np.median(zvalues)</span>
    <span class="n">zcenter</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getGroundHeight</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.2192</span> <span class="c"># valves are 4ft from ground</span>
    <span class="n">point1</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">xcenter</span><span class="p">,</span> <span class="n">ycenter</span><span class="p">,</span> <span class="n">zcenter</span>  <span class="p">])</span> <span class="c"># center of the valve wall</span>

    <span class="n">zaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">point1</span><span class="p">)</span>

    <span class="n">normalObj</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;valve wall frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c"># z direction out of wall</span>
    <span class="n">normalObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">t</span>

</div>
<div class="viewcode-block" id="segmentValveWallAuto"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentValveWallAuto">[docs]</a><span class="k">def</span> <span class="nf">segmentValveWallAuto</span><span class="p">(</span><span class="n">expectedValveRadius</span><span class="o">=.</span><span class="mi">195</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">,</span> <span class="n">removeGroundMethod</span><span class="o">=</span><span class="n">removeGround</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Automatically segment a valve hanging in front of the wall at the center</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># find the valve wall and its center</span>
    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">findWallCenter</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">removeGroundMethod</span><span class="p">)</span>

    <span class="n">valve_point1</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">,</span> <span class="mf">0.6</span> <span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">valveTransform1</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">(</span><span class="n">valve_point1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">valveTransform1</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">point1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valveTransform1</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span> <span class="c"># left of wall</span>

    <span class="n">valve_point2</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span> <span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">valveTransform2</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">(</span><span class="n">valve_point2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">valveTransform2</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">point2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valveTransform2</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span> <span class="c"># left of wall</span>

    <span class="n">valve_point3</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="c"># lever can over hang</span>
    <span class="n">valveTransform3</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">(</span><span class="n">valve_point3</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">valveTransform3</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">point3</span> <span class="o">=</span><span class="n">valveTransform3</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()</span> <span class="c"># right of wall</span>


    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">point2</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">point3</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;auto wall points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="s">&#39;valve&#39;</span><span class="p">):</span>
      <span class="n">segmentValveByWallPlane</span><span class="p">(</span><span class="n">expectedValveRadius</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="s">&#39;lever&#39;</span><span class="p">):</span>
      <span class="n">segmentLeverByWallPlane</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="s">&#39;both&#39;</span><span class="p">):</span>
      <span class="n">segmentValveByWallPlane</span><span class="p">(</span><span class="n">expectedValveRadius</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">)</span>
      <span class="n">segmentLeverByWallPlane</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;unexpected segmentation mode: &#39;</span> <span class="o">+</span> <span class="n">mode</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="segmentLeverByWallPlane"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentLeverByWallPlane">[docs]</a><span class="k">def</span> <span class="nf">segmentLeverByWallPlane</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    determine the position (including rotation of a lever near a wall</span>
<span class="sd">    input is as for the valve - to points on the wall either side of the lever</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># 1. determine the wall plane and normal</span>
    <span class="n">centerPoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">point1</span> <span class="o">+</span> <span class="n">point2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">viewDirection</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewDirection</span><span class="p">()</span>
    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=-</span><span class="n">viewDirection</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># 2. Crop the cloud down to the lever only using the wall plane</span>
    <span class="n">perpLine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">point2</span> <span class="o">-</span> <span class="n">point1</span><span class="p">,</span> <span class="o">-</span><span class="n">normal</span><span class="p">)</span>
    <span class="c">#perpLine /= np.linalg.norm(perpLine)</span>
    <span class="c">#perpLine * np.linalg.norm(point2 - point1)/2.0</span>
    <span class="n">point3</span><span class="p">,</span> <span class="n">point4</span> <span class="o">=</span> <span class="n">centerPoint</span> <span class="o">+</span> <span class="n">perpLine</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">centerPoint</span> <span class="o">-</span> <span class="n">perpLine</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">point3</span><span class="p">,</span> <span class="n">point4</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;lever crop lines&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">wallPoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">wallPoints</span><span class="p">,</span> <span class="s">&#39;lever valve wall&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span> <span class="c"># very tight threshold</span>
    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">cropToLineSegment</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">)</span>
    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">cropToLineSegment</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">point3</span><span class="p">,</span> <span class="n">point4</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="s">&#39;lever search region&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="c"># 3. fit line to remaining points - all assumed to be the lever</span>
    <span class="n">linePoint</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">applyLineFit</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
    <span class="c">#if np.dot(lineDirection, forwardDirection) &lt; 0:</span>
    <span class="c">#    lineDirection = -lineDirection</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">linePoint</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;lever point&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">pts</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pts</span><span class="o">-</span><span class="n">linePoint</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">)</span>
    <span class="n">lever_center</span> <span class="o">=</span> <span class="n">linePoint</span> <span class="o">+</span> <span class="n">lineDirection</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">lever_tip</span> <span class="o">=</span> <span class="n">linePoint</span> <span class="o">+</span> <span class="n">lineDirection</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>


    <span class="c"># 4. determine which lever point is closest to the lower left of the wall. That&#39;s the lever_center point</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">point1</span><span class="p">)</span>

    <span class="c"># a distant point down and left from wall</span>
    <span class="n">wall_point_lower_left</span> <span class="o">=</span> <span class="p">[</span> <span class="o">-</span><span class="mi">20</span> <span class="p">,</span> <span class="o">-</span><span class="mf">20.0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">wall_point_lower_left_Transform</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">(</span><span class="n">wall_point_lower_left</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">wall_point_lower_left_Transform</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">wall_point_lower_left</span> <span class="o">=</span> <span class="n">wall_point_lower_left_Transform</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()</span>
    <span class="n">d1</span> <span class="o">=</span>   <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">wall_point_lower_left</span><span class="o">-</span> <span class="n">projectPointToPlane</span><span class="p">(</span><span class="n">lever_center</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">d2</span> <span class="o">=</span>   <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">wall_point_lower_left</span><span class="o">-</span> <span class="n">projectPointToPlane</span><span class="p">(</span><span class="n">lever_tip</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">d2</span> <span class="o">&lt;</span> <span class="n">d1</span><span class="p">):</span> <span class="c"># flip the points to match variable names</span>
        <span class="n">p_temp</span> <span class="o">=</span> <span class="n">lever_center</span>
        <span class="n">lever_center</span> <span class="o">=</span> <span class="n">lever_tip</span>
        <span class="n">lever_tip</span> <span class="o">=</span> <span class="n">p_temp</span>
        <span class="n">lineDirection</span> <span class="o">=</span> <span class="o">-</span><span class="n">lineDirection</span>


    <span class="c"># 5. compute the rotation angle of the lever and, using that, its frame</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>
    <span class="n">xaxis</span> <span class="o">=</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">lever_center</span><span class="p">)</span> <span class="c"># nominal frame at lever center</span>

    <span class="n">rotationAngle</span> <span class="o">=</span> <span class="o">-</span><span class="n">computeSignedAngleBetweenVectors</span><span class="p">(</span><span class="n">lineDirection</span><span class="p">,</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">normal</span><span class="p">)</span>
    <span class="n">t_lever</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">(</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span> <span class="n">rotationAngle</span> <span class="p">)</span>  <span class="p">]</span> <span class="p">)</span>
    <span class="n">t_lever</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t_lever</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>


    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="c"># d.addSphere( point1 , radius=0.1)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span> <span class="n">wall_point_lower_left</span> <span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">lever_center</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">lever_tip</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">lever_center</span><span class="p">,</span> <span class="n">lever_tip</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;lever end points&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">lever_tip</span> <span class="o">-</span> <span class="n">lever_center</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span> <span class="p">(</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">0.02</span><span class="p">)</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">()</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="s">&#39;valve lever&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;affordances&#39;</span> <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t_lever</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>
    <span class="n">frameObj</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">t_lever</span><span class="p">,</span> <span class="s">&#39;lever frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">frameObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">otdfType</span> <span class="o">=</span> <span class="s">&#39;lever_valve&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_lever</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()),</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">friendly_name</span><span class="o">=</span><span class="n">otdfType</span><span class="p">,</span> <span class="n">otdf_type</span><span class="o">=</span><span class="n">otdfType</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>


</div>
<div class="viewcode-block" id="applyICP"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.applyICP">[docs]</a><span class="k">def</span> <span class="nf">applyICP</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>

    <span class="n">icp</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIterativeClosestPointTransform</span><span class="p">()</span>
    <span class="n">icp</span><span class="o">.</span><span class="n">SetSource</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">icp</span><span class="o">.</span><span class="n">SetTarget</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="n">icp</span><span class="o">.</span><span class="n">GetLandmarkTransform</span><span class="p">()</span><span class="o">.</span><span class="n">SetModeToRigidBody</span><span class="p">()</span>
    <span class="n">icp</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="n">icp</span><span class="o">.</span><span class="n">GetMatrix</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">t</span>

</div>
<div class="viewcode-block" id="applyDiskGlyphs"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.applyDiskGlyphs">[docs]</a><span class="k">def</span> <span class="nf">applyDiskGlyphs</span><span class="p">(</span><span class="n">polyData</span><span class="p">):</span>

    <span class="n">voxelGridLeafSize</span> <span class="o">=</span> <span class="mf">0.03</span>
    <span class="n">normalEstimationSearchRadius</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">diskRadius</span> <span class="o">=</span> <span class="mf">0.015</span>
    <span class="n">diskResolution</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="n">scanInput</span> <span class="o">=</span> <span class="n">polyData</span>

    <span class="n">pd</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">scanInput</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="n">voxelGridLeafSize</span><span class="p">)</span>

    <span class="n">pd</span> <span class="o">=</span> <span class="n">labelOutliers</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="n">normalEstimationSearchRadius</span><span class="p">,</span> <span class="n">neighborsInSearchRadius</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">pd</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="s">&#39;is_outlier&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">pd</span> <span class="o">=</span> <span class="n">normalEstimation</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="n">normalEstimationSearchRadius</span><span class="p">,</span> <span class="n">searchCloud</span><span class="o">=</span><span class="n">scanInput</span><span class="p">)</span>

    <span class="n">disk</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkDiskSource</span><span class="p">()</span>
    <span class="n">disk</span><span class="o">.</span><span class="n">SetOuterRadius</span><span class="p">(</span><span class="n">diskRadius</span><span class="p">)</span>
    <span class="n">disk</span><span class="o">.</span><span class="n">SetInnerRadius</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">disk</span><span class="o">.</span><span class="n">SetRadialResolution</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">disk</span><span class="o">.</span><span class="n">SetCircumferentialResolution</span><span class="p">(</span><span class="n">diskResolution</span><span class="p">)</span>
    <span class="n">disk</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">RotateY</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">disk</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">disk</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">(),</span> <span class="n">t</span><span class="p">)</span>

    <span class="n">glyph</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkGlyph3D</span><span class="p">()</span>
    <span class="n">glyph</span><span class="o">.</span><span class="n">ScalingOff</span><span class="p">()</span>
    <span class="n">glyph</span><span class="o">.</span><span class="n">OrientOn</span><span class="p">()</span>
    <span class="n">glyph</span><span class="o">.</span><span class="n">SetSource</span><span class="p">(</span><span class="n">disk</span><span class="p">)</span>
    <span class="n">glyph</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">pd</span><span class="p">)</span>
    <span class="n">glyph</span><span class="o">.</span><span class="n">SetVectorModeToUseNormal</span><span class="p">()</span>
    <span class="n">glyph</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">glyph</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="applyArrowGlyphs"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.applyArrowGlyphs">[docs]</a><span class="k">def</span> <span class="nf">applyArrowGlyphs</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">computeNormals</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">voxelGridLeafSize</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">normalEstimationSearchRadius</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">arrowSize</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">computeNormals</span><span class="p">:</span>
        <span class="n">voxelData</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="n">voxelGridLeafSize</span><span class="p">)</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">normalEstimation</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="n">normalEstimationSearchRadius</span><span class="p">,</span> <span class="n">searchCloud</span><span class="o">=</span><span class="n">voxelData</span><span class="p">)</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">removeNonFinitePoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;normals&#39;</span><span class="p">)</span>
        <span class="n">flipNormalsWithViewDirection</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewDirection</span><span class="p">())</span>

    <span class="k">assert</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNormals</span><span class="p">()</span>

    <span class="n">arrow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkArrowSource</span><span class="p">()</span>
    <span class="n">arrow</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="n">glyph</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkGlyph3D</span><span class="p">()</span>
    <span class="n">glyph</span><span class="o">.</span><span class="n">SetScaleFactor</span><span class="p">(</span><span class="n">arrowSize</span><span class="p">)</span>
    <span class="n">glyph</span><span class="o">.</span><span class="n">SetSource</span><span class="p">(</span><span class="n">arrow</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
    <span class="n">glyph</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">glyph</span><span class="o">.</span><span class="n">SetVectorModeToUseNormal</span><span class="p">()</span>
    <span class="n">glyph</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">glyph</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="segmentLeverValve"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentLeverValve">[docs]</a><span class="k">def</span> <span class="nf">segmentLeverValve</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">viewPlaneNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">getSegmentationView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">())</span>
    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">viewPlaneNormal</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="n">wallPoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">wallPoints</span><span class="p">,</span> <span class="s">&#39;wall points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">length</span> <span class="o">=</span> <span class="mf">0.33</span>

    <span class="n">normal</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span> <span class="c"># set z to face into wall</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">normal</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">point2</span><span class="p">)</span>

    <span class="n">leverP1</span> <span class="o">=</span> <span class="n">point2</span>
    <span class="n">leverP2</span> <span class="o">=</span> <span class="n">point2</span> <span class="o">+</span> <span class="n">xaxis</span> <span class="o">*</span> <span class="n">length</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span> <span class="p">(</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">0.02</span><span class="p">)</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">()</span>


    <span class="n">obj</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="s">&#39;valve lever&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;affordances&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>
    <span class="n">frameObj</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;lever frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">frameObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">otdfType</span> <span class="o">=</span> <span class="s">&#39;lever_valve&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()),</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">friendly_name</span><span class="o">=</span><span class="n">otdfType</span><span class="p">,</span> <span class="n">otdf_type</span><span class="o">=</span><span class="n">otdfType</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="segmentWye"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentWye">[docs]</a><span class="k">def</span> <span class="nf">segmentWye</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>


    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">viewPlaneNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">getSegmentationView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">())</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">viewPlaneNormal</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="n">wallPoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">wallPoints</span><span class="p">,</span> <span class="s">&#39;wall points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">wyeMesh</span> <span class="o">=</span> <span class="n">ioUtils</span><span class="o">.</span><span class="n">readPolyData</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCBase</span><span class="p">(),</span> <span class="s">&#39;software/models/otdf/wye.obj&#39;</span><span class="p">))</span>

    <span class="n">wyeMeshPoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">])</span>
    <span class="n">wyeMeshLeftHandle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.032292</span><span class="p">,</span> <span class="mf">0.02949</span><span class="p">,</span> <span class="mf">0.068485</span><span class="p">])</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PreMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="o">-</span><span class="n">wyeMeshPoint</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">point2</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">point2</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;wye pick point&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">wyeObj</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">wyeMesh</span><span class="p">,</span> <span class="s">&#39;wye&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">wyeObj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">wyeObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>
    <span class="n">frameObj</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;wye frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">wyeObj</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">frameObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()),</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">friendly_name</span><span class="o">=</span><span class="s">&#39;wye&#39;</span><span class="p">,</span> <span class="n">otdf_type</span><span class="o">=</span><span class="s">&#39;wye&#39;</span><span class="p">)</span>
    <span class="n">wyeObj</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">wyeObj</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="segmentDoorHandle"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDoorHandle">[docs]</a><span class="k">def</span> <span class="nf">segmentDoorHandle</span><span class="p">(</span><span class="n">otdfType</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">viewPlaneNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">getSegmentationView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">())</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">viewPlaneNormal</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">wallPoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">wallPoints</span><span class="p">,</span> <span class="s">&#39;wall points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">handlePoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.065</span><span class="p">,</span> <span class="mf">0.011</span><span class="p">])</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>

    <span class="n">xwidth</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">ywidth</span> <span class="o">=</span> <span class="mf">0.13</span>
    <span class="n">zwidth</span> <span class="o">=</span> <span class="mf">0.022</span>
    <span class="n">cube</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCubeSource</span><span class="p">()</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">SetXLength</span><span class="p">(</span><span class="n">xwidth</span><span class="p">)</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">SetYLength</span><span class="p">(</span><span class="n">ywidth</span><span class="p">)</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">SetZLength</span><span class="p">(</span><span class="n">zwidth</span><span class="p">)</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">cube</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="c">#t.PreMultiply()</span>
    <span class="c">#t.Translate(-handlePoint)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">point2</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;door handle&#39;</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;affordances&#39;</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">xwidth</span><span class="o">=</span><span class="n">xwidth</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="n">ywidth</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="n">zwidth</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">friendly_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">otdf_type</span><span class="o">=</span><span class="n">otdfType</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>

    <span class="n">frameObj</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetUserTransform</span><span class="p">(),</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39; frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">frameObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="segmentTruss"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentTruss">[docs]</a><span class="k">def</span> <span class="nf">segmentTruss</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>



    <span class="n">edge</span> <span class="o">=</span> <span class="n">point2</span> <span class="o">-</span> <span class="n">point1</span>
    <span class="n">edgeLength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>

    <span class="n">stanceOffset</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.42</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">stanceYaw</span> <span class="o">=</span> <span class="mf">0.0</span>


    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span> <span class="o">*</span> <span class="n">edgeLength</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>

    <span class="n">stanceTransform</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">stanceTransform</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">stanceTransform</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">stanceOffset</span><span class="p">)</span>
    <span class="c">#stanceTransform.RotateZ(stanceYaw)</span>

    <span class="n">geometry</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="n">stanceTransform</span><span class="o">.</span><span class="n">GetLinearInverse</span><span class="p">())</span>

    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">edge</span><span class="o">/</span><span class="n">edgeLength</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>


    <span class="n">xwidth</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">ywidth</span> <span class="o">=</span> <span class="n">edgeLength</span>
    <span class="n">zwidth</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PreMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">stanceTransform</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">point1</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;truss&#39;</span>
    <span class="n">otdfType</span> <span class="o">=</span> <span class="s">&#39;robot_knees&#39;</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;affordances&#39;</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">(),</span> <span class="n">xwidth</span><span class="o">=</span><span class="n">xwidth</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="n">ywidth</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="n">zwidth</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">friendly_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">otdf_type</span><span class="o">=</span><span class="n">otdfType</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>

    <span class="n">frameObj</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetUserTransform</span><span class="p">(),</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39; frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">frameObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="segmentHoseNozzle"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentHoseNozzle">[docs]</a><span class="k">def</span> <span class="nf">segmentHoseNozzle</span><span class="p">(</span><span class="n">point1</span><span class="p">):</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">cropToSphere</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="s">&#39;nozzle search region&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">point1</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">point1</span><span class="p">)</span>

    <span class="n">nozzleRadius</span> <span class="o">=</span> <span class="mf">0.0266</span>
    <span class="n">nozzleLength</span> <span class="o">=</span> <span class="mf">0.042</span>
    <span class="n">nozzleTipRadius</span> <span class="o">=</span> <span class="mf">0.031</span>
    <span class="n">nozzleTipLength</span> <span class="o">=</span> <span class="mf">0.024</span>


    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">nozzleLength</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nozzleLength</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]),</span> <span class="n">radius</span><span class="o">=</span><span class="n">nozzleRadius</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nozzleLength</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nozzleLength</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">nozzleTipLength</span><span class="p">]),</span> <span class="n">radius</span><span class="o">=</span><span class="n">nozzleTipRadius</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;hose nozzle&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>
    <span class="n">frameObj</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;nozzle frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">frameObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">friendly_name</span><span class="o">=</span><span class="s">&#39;firehose&#39;</span><span class="p">,</span> <span class="n">otdf_type</span><span class="o">=</span><span class="s">&#39;firehose&#39;</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="segmentDrillWall"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDrillWall">[docs]</a><span class="k">def</span> <span class="nf">segmentDrillWall</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">,</span> <span class="n">point3</span><span class="p">):</span>


    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>



    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">,</span> <span class="n">point3</span><span class="p">]</span>

    <span class="n">viewPlaneNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">getSegmentationView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">())</span>
    <span class="n">expectedNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">point2</span> <span class="o">-</span> <span class="n">point1</span><span class="p">,</span> <span class="n">point3</span> <span class="o">-</span> <span class="n">point1</span><span class="p">)</span>
    <span class="n">expectedNormal</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">expectedNormal</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">expectedNormal</span><span class="p">,</span> <span class="n">viewPlaneNormal</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">expectedNormal</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">expectedNormal</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="p">(</span><span class="n">point1</span> <span class="o">+</span> <span class="n">point2</span> <span class="o">+</span> <span class="n">point3</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">projectPointToPlane</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">pointsInWallFrame</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">GetLinearInverse</span><span class="p">()</span><span class="o">.</span><span class="n">TransformPoint</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span>
        <span class="n">pointsInWallFrame</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pointsInWallFrame</span><span class="p">,</span> <span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
        <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;drill target&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;drill target frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">refitWallCallbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">refitDrillWall</span><span class="p">,</span> <span class="n">aff</span><span class="p">))</span>

    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                  <span class="n">p1y</span><span class="o">=</span><span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">p1z</span><span class="o">=</span><span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                  <span class="n">p2y</span><span class="o">=</span><span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2z</span><span class="o">=</span><span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                  <span class="n">p3y</span><span class="o">=</span><span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">p3z</span><span class="o">=</span><span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                  <span class="n">friendly_name</span><span class="o">=</span><span class="s">&#39;drill_wall&#39;</span><span class="p">,</span> <span class="n">otdf_type</span><span class="o">=</span><span class="s">&#39;drill_wall&#39;</span><span class="p">)</span>

    <span class="n">aff</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>


</div>
<span class="n">refitWallCallbacks</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="refitWall"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.refitWall">[docs]</a><span class="k">def</span> <span class="nf">refitWall</span><span class="p">(</span><span class="n">point1</span><span class="p">):</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">viewPlaneNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">getSegmentationView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">())</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">viewPlaneNormal</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">wallPoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">wallPoints</span><span class="p">,</span> <span class="s">&#39;wall points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">refitWallCallbacks</span><span class="p">:</span>
        <span class="n">func</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="refitDrillWall"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.refitDrillWall">[docs]</a><span class="k">def</span> <span class="nf">refitDrillWall</span><span class="p">(</span><span class="n">aff</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">):</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetUserTransform</span><span class="p">()</span>

    <span class="n">targetOrigin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>

    <span class="n">projectedOrigin</span> <span class="o">=</span> <span class="n">projectPointToPlane</span><span class="p">(</span><span class="n">targetOrigin</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">projectedOrigin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">targetOrigin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">projectedOrigin</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetUserTransform</span><span class="p">()</span><span class="o">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">GetMatrix</span><span class="p">())</span>


<span class="c"># this should be depreciated!</span></div>
<div class="viewcode-block" id="getGroundHeightFromFeet"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getGroundHeightFromFeet">[docs]</a><span class="k">def</span> <span class="nf">getGroundHeightFromFeet</span><span class="p">():</span>
    <span class="n">rfoot</span> <span class="o">=</span> <span class="n">getLinkFrame</span><span class="p">(</span> <span class="n">drcargs</span><span class="o">.</span><span class="n">getDirectorConfig</span><span class="p">()[</span><span class="s">&#39;rightFootLink&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rfoot</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span>  <span class="mf">0.0745342</span>

<span class="c"># this should be depreciated!</span></div>
<div class="viewcode-block" id="getTranslationRelativeToFoot"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getTranslationRelativeToFoot">[docs]</a><span class="k">def</span> <span class="nf">getTranslationRelativeToFoot</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="n">rfoot</span> <span class="o">=</span> <span class="n">getLinkFrame</span><span class="p">(</span> <span class="n">drcargs</span><span class="o">.</span><span class="n">getDirectorConfig</span><span class="p">()[</span><span class="s">&#39;rightFootLink&#39;</span><span class="p">]</span> <span class="p">)</span>

</div>
<div class="viewcode-block" id="segmentDrillWallConstrained"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDrillWallConstrained">[docs]</a><span class="k">def</span> <span class="nf">segmentDrillWallConstrained</span><span class="p">(</span><span class="n">rightAngleLocation</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">viewPlaneNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">getSegmentationView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">())</span>
    <span class="n">expectedNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">point2</span> <span class="o">-</span> <span class="n">point1</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">expectedNormal</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">expectedNormal</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">expectedNormal</span><span class="p">,</span> <span class="n">viewPlaneNormal</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">expectedNormal</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">expectedNormal</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">triangleOrigin</span> <span class="o">=</span> <span class="n">projectPointToPlane</span><span class="p">(</span><span class="n">point2</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">triangleOrigin</span><span class="p">)</span>

    <span class="n">createDrillWall</span><span class="p">(</span><span class="n">rightAngleLocation</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="createDrillWall"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.createDrillWall">[docs]</a><span class="k">def</span> <span class="nf">createDrillWall</span><span class="p">(</span><span class="n">rightAngleLocation</span><span class="p">,</span> <span class="n">trianglePose</span><span class="p">):</span>

    <span class="c"># recover the origin and axes from the pose:</span>
    <span class="n">triangleOrigin</span> <span class="o">=</span> <span class="n">trianglePose</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()</span>
    <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">getAxesFromTransform</span><span class="p">(</span> <span class="n">trianglePose</span> <span class="p">)</span>

    <span class="c"># 0.6096 = 24 * .0254 (m = feet)</span>
    <span class="c"># 0.3048 = 12 * .0254 (m = feet)</span>
    <span class="n">edgeRight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">edgeUp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>


    <span class="n">pointsInWallFrame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">rightAngleLocation</span> <span class="o">==</span> <span class="n">DRILL_TRIANGLE_BOTTOM_LEFT</span><span class="p">:</span>
        <span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">edgeUp</span>
        <span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">edgeRight</span>

    <span class="k">elif</span> <span class="n">rightAngleLocation</span> <span class="o">==</span> <span class="n">DRILL_TRIANGLE_BOTTOM_RIGHT</span><span class="p">:</span>
        <span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">edgeUp</span>      <span class="c"># edgeRight +edgeUp</span>
        <span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">edgeRight</span>  <span class="c"># edgeRight</span>

    <span class="k">elif</span> <span class="n">rightAngleLocation</span> <span class="o">==</span> <span class="n">DRILL_TRIANGLE_TOP_LEFT</span><span class="p">:</span>
        <span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">edgeRight</span>
        <span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">edgeUp</span>

    <span class="k">elif</span> <span class="n">rightAngleLocation</span> <span class="o">==</span> <span class="n">DRILL_TRIANGLE_TOP_RIGHT</span><span class="p">:</span>
        <span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">edgeRight</span>
        <span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">edgeRight</span> <span class="o">-</span> <span class="n">edgeUp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;unexpected value for right angle location: &#39;</span><span class="p">,</span> <span class="o">+</span> <span class="n">rightAngleLocation</span><span class="p">)</span>

    <span class="n">center</span> <span class="o">=</span> <span class="n">pointsInWallFrame</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span>
    <span class="n">shrinkFactor</span> <span class="o">=</span> <span class="mi">1</span><span class="c">#0.90</span>
    <span class="n">shrinkPoints</span> <span class="o">=</span> <span class="p">(</span><span class="n">pointsInWallFrame</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">*</span> <span class="n">shrinkFactor</span> <span class="o">+</span> <span class="n">center</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pointsInWallFrame</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pointsInWallFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">pointsInWallFrame</span><span class="p">[</span><span class="mi">0</span><span class="p">]))):</span>
        <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span><span class="c">#01)</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shrinkPoints</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">shrinkPoints</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">shrinkPoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]))):</span>
        <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span><span class="c">#0.025</span>

    <span class="n">folder</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">getOrCreateContainer</span><span class="p">(</span><span class="s">&#39;affordances&#39;</span><span class="p">)</span>

    <span class="n">wall</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;wall&#39;</span><span class="p">)</span>
    <span class="n">om</span><span class="o">.</span><span class="n">removeFromObjectModel</span><span class="p">(</span><span class="n">wall</span><span class="p">)</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;wall&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">trianglePose</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">refitWallCallbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">refitDrillWall</span><span class="p">,</span> <span class="n">aff</span><span class="p">))</span>

    <span class="n">frameObj</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">trianglePose</span><span class="p">,</span> <span class="s">&#39;wall frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">frameObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">triangleOrigin</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                  <span class="n">p1y</span><span class="o">=</span><span class="n">shrinkPoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">p1z</span><span class="o">=</span><span class="n">shrinkPoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                  <span class="n">p2y</span><span class="o">=</span><span class="n">shrinkPoints</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2z</span><span class="o">=</span><span class="n">shrinkPoints</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                  <span class="n">p3y</span><span class="o">=</span><span class="n">shrinkPoints</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">p3z</span><span class="o">=</span><span class="n">shrinkPoints</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                  <span class="n">friendly_name</span><span class="o">=</span><span class="s">&#39;drill_wall&#39;</span><span class="p">,</span> <span class="n">otdf_type</span><span class="o">=</span><span class="s">&#39;drill_wall&#39;</span><span class="p">)</span>

    <span class="n">aff</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>


    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    rfoot = getLinkFrame(drcargs.getDirectorConfig()[&#39;rightFootLink&#39;])</span>
<span class="sd">    tt = getTransformFromAxes(xaxis, yaxis, zaxis)</span>
<span class="sd">    tt.PostMultiply()</span>
<span class="sd">    tt.Translate(rfoot.GetPosition())</span>
<span class="sd">    showFrame(tt, &#39;rfoot with wall orientation&#39;)</span>
<span class="sd">    aff.footToAffTransform = computeAToB(tt, trianglePose)</span>

<span class="sd">    footToAff = list(aff.footToAffTransform.GetPosition())</span>
<span class="sd">    tt.TransformVector(footToAff, footToAff)</span>

<span class="sd">    d = DebugData()</span>
<span class="sd">    d.addSphere(tt.GetPosition(), radius=0.02)</span>
<span class="sd">    d.addLine(tt.GetPosition(), np.array(tt.GetPosition()) + np.array(footToAff))</span>
<span class="sd">    showPolyData(d.getPolyData(), &#39;rfoot debug&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>

</div>
<div class="viewcode-block" id="getDrillAffordanceParams"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getDrillAffordanceParams">[docs]</a><span class="k">def</span> <span class="nf">getDrillAffordanceParams</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">,</span> <span class="n">drillType</span><span class="o">=</span><span class="s">&quot;dewalt_button&quot;</span><span class="p">):</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">drillType</span><span class="o">==</span><span class="s">&quot;dewalt_button&quot;</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                  <span class="n">button_x</span><span class="o">=</span><span class="mf">0.007</span><span class="p">,</span>
                  <span class="n">button_y</span><span class="o">=-</span><span class="mf">0.035</span><span class="p">,</span>
                  <span class="n">button_z</span><span class="o">=-</span><span class="mf">0.06</span><span class="p">,</span>
                  <span class="n">button_roll</span><span class="o">=-</span><span class="mf">90.0</span><span class="p">,</span>
                  <span class="n">button_pitch</span><span class="o">=-</span><span class="mf">90.0</span><span class="p">,</span>
                  <span class="n">button_yaw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">bit_x</span><span class="o">=-</span><span class="mf">0.01</span><span class="p">,</span>
                  <span class="n">bit_y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">bit_z</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
                  <span class="n">bit_roll</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">bit_pitch</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span>
                  <span class="n">bit_yaw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">friendly_name</span><span class="o">=</span><span class="s">&#39;dewalt_button&#39;</span><span class="p">,</span> <span class="n">otdf_type</span><span class="o">=</span><span class="s">&#39;dewalt_button&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                  <span class="n">button_x</span><span class="o">=</span><span class="mf">0.007</span><span class="p">,</span>
                  <span class="n">button_y</span><span class="o">=-</span><span class="mf">0.035</span><span class="p">,</span>
                  <span class="n">button_z</span><span class="o">=-</span><span class="mf">0.06</span><span class="p">,</span>
                  <span class="n">button_roll</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">button_pitch</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">button_yaw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">bit_x</span><span class="o">=</span><span class="mf">0.18</span><span class="p">,</span>
                  <span class="n">bit_y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">bit_z</span><span class="o">=</span><span class="mf">0.13</span><span class="p">,</span>
                  <span class="n">bit_roll</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">bit_pitch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">bit_yaw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">friendly_name</span><span class="o">=</span><span class="s">&#39;dewalt_barrel&#39;</span><span class="p">,</span> <span class="n">otdf_type</span><span class="o">=</span><span class="s">&#39;dewalt_barrel&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">params</span>

</div>
<div class="viewcode-block" id="getDrillMesh"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getDrillMesh">[docs]</a><span class="k">def</span> <span class="nf">getDrillMesh</span><span class="p">(</span><span class="n">applyBitOffset</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="n">button</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.007</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.035</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.06</span><span class="p">])</span>
    <span class="n">drillMesh</span> <span class="o">=</span> <span class="n">ioUtils</span><span class="o">.</span><span class="n">readPolyData</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCBase</span><span class="p">(),</span> <span class="s">&#39;software/models/otdf/dewalt_button.obj&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">applyBitOffset</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">drillMesh</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">drillMesh</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addPolyData</span><span class="p">(</span><span class="n">drillMesh</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.155</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">],</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">())</span>



</div>
<div class="viewcode-block" id="getDrillBarrelMesh"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getDrillBarrelMesh">[docs]</a><span class="k">def</span> <span class="nf">getDrillBarrelMesh</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">ioUtils</span><span class="o">.</span><span class="n">readPolyData</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCBase</span><span class="p">(),</span> <span class="s">&#39;software/models/otdf/dewalt.ply&#39;</span><span class="p">),</span> <span class="n">computeNormals</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="segmentDrill"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDrill">[docs]</a><span class="k">def</span> <span class="nf">segmentDrill</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">,</span> <span class="n">point3</span><span class="p">):</span>


    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">viewPlaneNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">getSegmentationView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">())</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">viewPlaneNormal</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="n">tablePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">,</span> <span class="s">&#39;table plane points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>
    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">cropToSphere</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">point2</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">)</span>
    <span class="n">drillPoints</span> <span class="o">=</span> <span class="n">extractLargestCluster</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">)</span>

    <span class="n">drillToTopPoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.002904</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.010029</span><span class="p">,</span> <span class="mf">0.153182</span><span class="p">])</span>

    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">normal</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">point3</span> <span class="o">-</span> <span class="n">point2</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PreMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="o">-</span><span class="n">drillToTopPoint</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">point2</span><span class="p">)</span>

    <span class="n">drillMesh</span> <span class="o">=</span> <span class="n">getDrillMesh</span><span class="p">()</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">drillMesh</span><span class="p">,</span> <span class="s">&#39;drill&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;drill frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">getDrillAffordanceParams</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="makePolyDataFields"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.makePolyDataFields">[docs]</a><span class="k">def</span> <span class="nf">makePolyDataFields</span><span class="p">(</span><span class="n">pd</span><span class="p">):</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">computeDelaunay3D</span><span class="p">(</span><span class="n">pd</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mesh</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">origin</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">wireframe</span> <span class="o">=</span> <span class="n">getOrientedBoundingBox</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

    <span class="n">edgeLengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">])</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>

    <span class="n">boxCenter</span> <span class="o">=</span> <span class="n">computeCentroid</span><span class="p">(</span><span class="n">wireframe</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">boxCenter</span><span class="p">)</span>

    <span class="n">pd</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">GetLinearInverse</span><span class="p">())</span>
    <span class="n">wireframe</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">wireframe</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">GetLinearInverse</span><span class="p">())</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">GetLinearInverse</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">FieldContainer</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="n">pd</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">wireframe</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">edgeLengths</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="makeMovable"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.makeMovable">[docs]</a><span class="k">def</span> <span class="nf">makeMovable</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">initialTransform</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Adds a child frame to the given PolyDataItem.  If initialTransform is not</span>
<span class="sd">    given, then an origin frame is computed for the polydata using the</span>
<span class="sd">    center and orientation of the oriented bounding of the polydata.  The polydata</span>
<span class="sd">    is transformed using the inverse of initialTransform and then a child frame</span>
<span class="sd">    is assigned to the object to reposition it.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pd</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">polyData</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">initialTransform</span>

    <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">origin</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">wireframe</span> <span class="o">=</span> <span class="n">getOrientedBoundingBox</span><span class="p">(</span><span class="n">pd</span><span class="p">)</span>
        <span class="n">edgeLengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">])</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>
        <span class="n">boxCenter</span> <span class="o">=</span> <span class="n">computeCentroid</span><span class="p">(</span><span class="n">wireframe</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">boxCenter</span><span class="p">)</span>

    <span class="n">pd</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">GetLinearInverse</span><span class="p">())</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setPolyData</span><span class="p">(</span><span class="n">pd</span><span class="p">)</span>

    <span class="n">frame</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getChildFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">frame</span><span class="p">:</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">copyFrame</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">vis</span><span class="o">.</span><span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="segmentTable"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentTable">[docs]</a><span class="k">def</span> <span class="nf">segmentTable</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Segment a horizontal table surface (perpendicular to +Z) in the given polyData</span>
<span class="sd">    using the given search point.</span>

<span class="sd">    Returns polyData, tablePoints, origin, normal</span>
<span class="sd">    polyData is the input polyData with a new &#39;dist_to_plane&#39; attribute.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">expectedNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">tableNormalEpsilon</span> <span class="o">=</span> <span class="mf">0.4</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">expectedNormal</span><span class="p">,</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="n">expectedNormal</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">searchPoint</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="n">tableNormalEpsilon</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">tablePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>

    <span class="n">tablePoints</span> <span class="o">=</span> <span class="n">labelDistanceToPoint</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">)</span>
    <span class="n">tablePointsClusters</span> <span class="o">=</span> <span class="n">extractClusters</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">clusterTolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">tablePointsClusters</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#39;distance_to_point&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="n">tablePoints</span> <span class="o">=</span> <span class="n">tablePointsClusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">,</span> <span class="s">&#39;table plane points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">,</span> <span class="s">&#39;table points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">polyData</span><span class="p">,</span> <span class="n">tablePoints</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span>

</div>
<div class="viewcode-block" id="filterClusterObjects"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.filterClusterObjects">[docs]</a><span class="k">def</span> <span class="nf">filterClusterObjects</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">cluster</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>




</div>
<div class="viewcode-block" id="segmentTableThenFindDrills"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentTableThenFindDrills">[docs]</a><span class="k">def</span> <span class="nf">segmentTableThenFindDrills</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span><span class="n">pickedPoint</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Given a point cloud of a table with drills on it.</span>
<span class="sd">        Find all clusters and fit drills</span>
<span class="sd">        Assumes that all clusters are of drills</span>
<span class="sd">        Nothing else is ever on a table ;)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># 1 segment a table and return clusters and the plane normal</span>
    <span class="n">clusters</span><span class="p">,</span> <span class="n">tablePoints</span><span class="p">,</span> <span class="n">plane_origin</span><span class="p">,</span> <span class="n">plane_normal</span> <span class="o">=</span> <span class="n">segmentTableSceneClusters</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">pickedPoint</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="c"># 2 Detect drills within the clusters:</span>
    <span class="n">viewFrame</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewFrame</span><span class="p">()</span>
    <span class="n">forwardDirection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">viewFrame</span><span class="o">.</span><span class="n">TransformVector</span><span class="p">(</span><span class="n">forwardDirection</span><span class="p">,</span> <span class="n">forwardDirection</span><span class="p">)</span>
    <span class="n">robotForward</span> <span class="o">=</span><span class="n">forwardDirection</span>

    <span class="n">fitResults</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">for</span> <span class="n">clusterObj</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
        <span class="c"># vis.showPolyData(clusterObj, &#39;cluster debug&#39;)</span>
        <span class="n">drillFrame</span> <span class="o">=</span> <span class="n">fitDrillBarrel</span> <span class="p">(</span><span class="n">clusterObj</span><span class="p">,</span> <span class="n">robotForward</span><span class="p">,</span> <span class="n">plane_origin</span><span class="p">,</span> <span class="n">plane_normal</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">drillFrame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fitResults</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">clusterObj</span><span class="p">,</span> <span class="n">drillFrame</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">fitResults</span><span class="p">:</span>
        <span class="k">return</span>


    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fitResult</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fitResults</span><span class="p">):</span>
        <span class="n">cluster</span><span class="p">,</span> <span class="n">drillFrame</span> <span class="o">=</span> <span class="n">fitResult</span>
        <span class="n">drillOrigin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">drillFrame</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>
        <span class="n">drillMesh</span> <span class="o">=</span> <span class="n">getDrillBarrelMesh</span><span class="p">()</span>

        <span class="c">#drill = om.findObjectByName(&#39;drill&#39;)</span>
        <span class="n">name</span><span class="o">=</span> <span class="s">&#39;drill </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span>
        <span class="n">name2</span><span class="o">=</span> <span class="s">&#39;drill </span><span class="si">%d</span><span class="s"> frame&#39;</span> <span class="o">%</span> <span class="n">i</span>
        <span class="n">drill</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">drillMesh</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">drillFrame</span> <span class="o">=</span> <span class="n">updateFrame</span><span class="p">(</span><span class="n">drillFrame</span><span class="p">,</span> <span class="n">name2</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">drill</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">drill</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">drillFrame</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>

        <span class="n">drill</span><span class="o">.</span><span class="n">setSolidColor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="c">#cluster.setProperty(&#39;Visible&#39;, True)</span>



</div>
<div class="viewcode-block" id="segmentTableScene"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentTableScene">[docs]</a><span class="k">def</span> <span class="nf">segmentTableScene</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">,</span> <span class="n">filterClustering</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This seems to be unused, depreciated? &#39;&#39;&#39;</span>

    <span class="n">objectClusters</span><span class="p">,</span> <span class="n">tablePoints</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">segmentTableSceneClusters</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">)</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">makePolyDataFields</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">objectClusters</span><span class="p">]</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">cluster</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span> <span class="k">if</span> <span class="n">cluster</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filterClustering</span><span class="p">):</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">filterClusterObjects</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">FieldContainer</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">makePolyDataFields</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">),</span> <span class="n">clusters</span><span class="o">=</span><span class="n">clusters</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="segmentTableSceneClusters"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentTableSceneClusters">[docs]</a><span class="k">def</span> <span class="nf">segmentTableSceneClusters</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">,</span> <span class="n">clusterInXY</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Given a point cloud of a table with some objects on it</span>
<span class="sd">        and a point on that table</span>
<span class="sd">        determine the plane of the table and</span>
<span class="sd">        extract clusters above the table</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">tablePoints</span><span class="p">,</span> <span class="n">plane_origin</span><span class="p">,</span> <span class="n">plane_normal</span> <span class="o">=</span> <span class="n">segmentTable</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">)</span>

    <span class="n">tableCentroid</span> <span class="o">=</span> <span class="n">computeCentroid</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">)</span>

    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
    <span class="c"># TODO: replace with &#39;all points above the table&#39;:</span>
    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">cropToSphere</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">tableCentroid</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="c"># was 1.0</span>

    <span class="n">tableCentroidFrame</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">(</span><span class="n">tableCentroid</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">showFrame</span><span class="p">(</span><span class="n">tableCentroidFrame</span><span class="p">,</span> <span class="s">&#39;tableCentroid&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">showPolyData</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="s">&#39;searchRegion&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">())</span>

    <span class="n">objectClusters</span> <span class="o">=</span> <span class="n">extractClusters</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">clusterInXY</span><span class="p">,</span> <span class="n">clusterTolerance</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c">#print &#39;got %d clusters&#39; % len(objectClusters)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">objectClusters</span><span class="p">):</span>
        <span class="n">name</span><span class="o">=</span> <span class="s">&quot;cluster </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span>
        <span class="n">showPolyData</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">getRandomColor</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">objectClusters</span><span class="p">,</span> <span class="n">tablePoints</span><span class="p">,</span> <span class="n">plane_origin</span><span class="p">,</span> <span class="n">plane_normal</span>

</div>
<div class="viewcode-block" id="segmentTableEdge"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentTableEdge">[docs]</a><span class="k">def</span> <span class="nf">segmentTableEdge</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">,</span> <span class="n">edgePoint</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    segment a table using two points:</span>
<span class="sd">    searchPoint is a point on the table top</span>
<span class="sd">    edgePoint is a point on the edge facing the robot</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">tablePoints</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">segmentTable</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">searchPoint</span><span class="p">)</span>

    <span class="n">tableMesh</span> <span class="o">=</span> <span class="n">computeDelaunay3D</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">)</span>
    <span class="n">origin</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">wireframe</span> <span class="o">=</span> <span class="n">getOrientedBoundingBox</span><span class="p">(</span><span class="n">tableMesh</span><span class="p">)</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


    <span class="n">edgeLengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">])</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">findAxis</span><span class="p">(</span><span class="n">referenceVector</span><span class="p">):</span>
        <span class="n">refAxis</span> <span class="o">=</span> <span class="n">referenceVector</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">referenceVector</span><span class="p">)</span>
        <span class="n">axisProjections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">refAxis</span><span class="p">))</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">])</span>
        <span class="n">axisIndex</span> <span class="o">=</span> <span class="n">axisProjections</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">axisIndex</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">refAxis</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="n">axis</span>
        <span class="k">return</span> <span class="n">axis</span><span class="p">,</span> <span class="n">axisIndex</span>

    <span class="n">tableXAxis</span><span class="p">,</span> <span class="n">tableXAxisIndex</span> <span class="o">=</span> <span class="n">findAxis</span><span class="p">(</span><span class="n">searchPoint</span> <span class="o">-</span> <span class="n">edgePoint</span><span class="p">)</span>
    <span class="n">tableZAxis</span><span class="p">,</span> <span class="n">tableZAxisIndex</span> <span class="o">=</span> <span class="n">findAxis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">tableYAxis</span><span class="p">,</span> <span class="n">tableYAxisIndex</span> <span class="o">=</span> <span class="n">findAxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">tableZAxis</span><span class="p">,</span> <span class="n">tableXAxis</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">tableXAxisIndex</span><span class="p">,</span> <span class="n">tableYAxisIndex</span><span class="p">,</span> <span class="n">tableZAxisIndex</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">tableXAxis</span><span class="p">,</span> <span class="n">tableYAxis</span><span class="p">,</span> <span class="n">tableZAxis</span>
    <span class="n">edgeLengths</span> <span class="o">=</span> <span class="n">edgeLengths</span><span class="p">[</span><span class="n">tableXAxisIndex</span><span class="p">],</span> <span class="n">edgeLengths</span><span class="p">[</span><span class="n">tableYAxisIndex</span><span class="p">],</span> <span class="n">edgeLengths</span><span class="p">[</span><span class="n">tableZAxisIndex</span><span class="p">]</span>

    <span class="n">edgeCenter</span> <span class="o">=</span> <span class="n">origin</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">edgeLengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">edgeLengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">edgeLeft</span> <span class="o">=</span> <span class="n">edgeCenter</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">edgeLengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">edgeRight</span> <span class="o">=</span> <span class="n">edgeCenter</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">edgeLengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">edgeRight</span><span class="p">)</span>

    <span class="n">table_center</span> <span class="o">=</span> <span class="p">[</span><span class="n">edgeLengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgeLengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">edgeLengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PreMultiply</span><span class="p">()</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">(</span><span class="n">table_center</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">t3</span><span class="p">)</span>

    <span class="n">tablePoints</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">GetLinearInverse</span><span class="p">())</span>
    <span class="n">wireframe</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">wireframe</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">GetLinearInverse</span><span class="p">())</span>
    <span class="n">tableMesh</span> <span class="o">=</span> <span class="n">transformPolyData</span><span class="p">(</span><span class="n">tableMesh</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">GetLinearInverse</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">FieldContainer</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="n">tablePoints</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">wireframe</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">tableMesh</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">edgeLengths</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="segmentDrillAuto"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDrillAuto">[docs]</a><span class="k">def</span> <span class="nf">segmentDrillAuto</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">polyData</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">polyData</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">expectedNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">expectedNormal</span><span class="p">,</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="n">expectedNormal</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="n">tablePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">,</span> <span class="s">&#39;table plane points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">tablePoints</span> <span class="o">=</span> <span class="n">labelDistanceToPoint</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">,</span> <span class="n">point1</span><span class="p">)</span>
    <span class="n">tablePointsClusters</span> <span class="o">=</span> <span class="n">extractClusters</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">)</span>
    <span class="n">tablePointsClusters</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#39;distance_to_point&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="n">tablePoints</span> <span class="o">=</span> <span class="n">tablePointsClusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">,</span> <span class="s">&#39;table points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>
    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">cropToSphere</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">)</span>
    <span class="n">drillPoints</span> <span class="o">=</span> <span class="n">extractLargestCluster</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


    <span class="c"># determine drill orientation (rotation about z axis)</span>

    <span class="n">centroids</span> <span class="o">=</span> <span class="n">computeCentroids</span><span class="p">(</span><span class="n">drillPoints</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">normal</span><span class="p">)</span>

    <span class="n">centroidsPolyData</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getVtkPolyDataFromNumpyPoints</span><span class="p">(</span><span class="n">centroids</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">centroidsPolyData</span><span class="p">,</span> <span class="s">&#39;cluster centroids&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">drillToTopPoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.002904</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.010029</span><span class="p">,</span> <span class="mf">0.153182</span><span class="p">])</span>

    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">normal</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">centroids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">centroids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>

    <span class="c"># note this hack to orient the drill correctly:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="o">-</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PreMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="o">-</span><span class="n">drillToTopPoint</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">centroids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">drillMesh</span> <span class="o">=</span> <span class="n">getDrillMesh</span><span class="p">()</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">drillMesh</span><span class="p">,</span> <span class="s">&#39;drill&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;drill frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">getDrillAffordanceParams</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>


</div>
<div class="viewcode-block" id="segmentDrillButton"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDrillButton">[docs]</a><span class="k">def</span> <span class="nf">segmentDrillButton</span><span class="p">(</span><span class="n">point1</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;sensed drill button&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># there is no orientation, but this allows the XYZ point to be queried</span>
    <span class="n">pointerTipFrame</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">pointerTipFrame</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">frameObj</span> <span class="o">=</span> <span class="n">updateFrame</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetUserTransform</span><span class="p">(),</span> <span class="s">&#39;sensed drill button frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">frameObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="segmentPointerTip"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentPointerTip">[docs]</a><span class="k">def</span> <span class="nf">segmentPointerTip</span><span class="p">(</span><span class="n">point1</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;sensed pointer tip&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># there is no orientation, but this allows the XYZ point to be queried</span>
    <span class="n">pointerTipFrame</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">pointerTipFrame</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">frameObj</span> <span class="o">=</span> <span class="n">updateFrame</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetUserTransform</span><span class="p">(),</span> <span class="s">&#39;sensed pointer tip frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">frameObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="fitGroundObject"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.fitGroundObject">[docs]</a><span class="k">def</span> <span class="nf">fitGroundObject</span><span class="p">(</span><span class="n">polyData</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">expectedDimensionsMin</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">],</span> <span class="n">expectedDimensionsMax</span><span class="o">=</span><span class="p">[</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]):</span>

    <span class="n">removeGroundFunc</span> <span class="o">=</span> <span class="n">removeGroundSimple</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">polyData</span> <span class="ow">or</span> <span class="n">getCurrentRevolutionData</span><span class="p">()</span>
    <span class="n">groundPoints</span><span class="p">,</span> <span class="n">scenePoints</span> <span class="o">=</span>  <span class="n">removeGroundFunc</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">groundThickness</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">sceneHeightFromGround</span><span class="o">=</span><span class="mf">0.035</span><span class="p">)</span>

    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="n">extractClusters</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">clusterTolerance</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">clusterId</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>


        <span class="n">origin</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">getOrientedBoundingBox</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
        <span class="n">edgeLengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span>

        <span class="n">found</span> <span class="o">=</span> <span class="p">(</span><span class="n">expectedDimensionsMin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">edgeLengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">expectedDimensionsMax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
             <span class="ow">and</span> <span class="n">expectedDimensionsMin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">edgeLengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">expectedDimensionsMax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">updatePolyData</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s">&#39;candidate cluster </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">clusterId</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">updatePolyData</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s">&#39;cluster </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">clusterId</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>


    <span class="n">viewFrame</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewFrame</span><span class="p">()</span>
    <span class="n">viewOrigin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">viewFrame</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">viewOrigin</span> <span class="o">-</span> <span class="n">computeCentroid</span><span class="p">(</span><span class="n">cluster</span><span class="p">))</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">]</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">candidates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dists</span><span class="p">)]</span>

    <span class="n">cluster</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">makePolyDataFields</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vis</span><span class="o">.</span><span class="n">showClusterObjects</span><span class="p">([</span><span class="n">obj</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;segmentation&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="findHorizontalSurfaces"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.findHorizontalSurfaces">[docs]</a><span class="k">def</span> <span class="nf">findHorizontalSurfaces</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">removeGroundFirst</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">normalEstimationSearchRadius</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                          <span class="n">clusterTolerance</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">distanceToPlaneThreshold</span><span class="o">=</span><span class="mf">0.0025</span><span class="p">,</span> <span class="n">normalsDotUpRange</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">showClusters</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find the horizontal surfaces, tuned to work with walking terrain</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">searchZ</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]</span>
    <span class="n">voxelGridLeafSize</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">minClusterSize</span> <span class="o">=</span> <span class="mi">150</span>
    <span class="n">verboseFlag</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">removeGroundFirst</span><span class="p">):</span>
        <span class="n">groundPoints</span><span class="p">,</span> <span class="n">scenePoints</span> <span class="o">=</span>  <span class="n">removeGround</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">groundThickness</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">sceneHeightFromGround</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">scenePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="n">searchZ</span><span class="p">)</span>
        <span class="n">updatePolyData</span><span class="p">(</span><span class="n">groundPoints</span><span class="p">,</span> <span class="s">&#39;ground points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="n">verboseFlag</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scenePoints</span> <span class="o">=</span> <span class="n">polyData</span>



    <span class="k">if</span> <span class="ow">not</span> <span class="n">scenePoints</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPCLNormalEstimation</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetSearchRadius</span><span class="p">(</span><span class="n">normalEstimationSearchRadius</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="n">voxelGridLeafSize</span><span class="p">))</span>

    <span class="c"># Duration 0.2 sec for V1 log:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">scenePoints</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

    <span class="n">normals</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;normals&#39;</span><span class="p">)</span>
    <span class="n">normalsDotUp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="n">normalsDotUp</span><span class="p">,</span> <span class="s">&#39;normals_dot_up&#39;</span><span class="p">)</span>
    <span class="n">surfaces</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;normals_dot_up&#39;</span><span class="p">,</span> <span class="n">normalsDotUpRange</span><span class="p">)</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;scene points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;normals_dot_up&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="n">verboseFlag</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span> <span class="s">&#39;surfaces points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;normals_dot_up&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="n">verboseFlag</span><span class="p">)</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="n">extractClusters</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span> <span class="n">clusterTolerance</span><span class="o">=</span><span class="n">clusterTolerance</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="n">minClusterSize</span><span class="p">)</span>
    <span class="n">planeClusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">clustersLarge</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">om</span><span class="o">.</span><span class="n">removeFromObjectModel</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;surface clusters&#39;</span><span class="p">))</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">getOrCreateContainer</span><span class="p">(</span><span class="s">&#39;surface clusters&#39;</span><span class="p">,</span> <span class="n">parentObj</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>

        <span class="n">updatePolyData</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s">&#39;surface cluster </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">getRandomColor</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="n">verboseFlag</span><span class="p">)</span>
        <span class="n">planePoints</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">distanceToPlaneThreshold</span><span class="p">)</span>
        <span class="n">planePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">distanceToPlaneThreshold</span><span class="p">,</span> <span class="n">distanceToPlaneThreshold</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">planePoints</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">minClusterSize</span><span class="p">:</span>
            <span class="n">clustersLarge</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">makePolyDataFields</span><span class="p">(</span><span class="n">planePoints</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">planeClusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="n">folder</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">getOrCreateContainer</span><span class="p">(</span><span class="s">&#39;surface objects&#39;</span><span class="p">,</span> <span class="n">parentObj</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">showClusters</span><span class="p">:</span>
        <span class="n">vis</span><span class="o">.</span><span class="n">showClusterObjects</span><span class="p">(</span><span class="n">planeClusters</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">clustersLarge</span>

</div>
<div class="viewcode-block" id="fitVerticalPosts"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.fitVerticalPosts">[docs]</a><span class="k">def</span> <span class="nf">fitVerticalPosts</span><span class="p">(</span><span class="n">polyData</span><span class="p">):</span>

    <span class="n">groundPoints</span><span class="p">,</span> <span class="n">scenePoints</span> <span class="o">=</span>  <span class="n">removeGround</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">scenePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">scenePoints</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="n">scenePoints</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">extractClusters</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="n">clusterTolerance</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>




    <span class="k">def</span> <span class="nf">isPostCluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">):</span>

        <span class="n">up</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">minPostLength</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">maxRadius</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">up</span><span class="p">,</span><span class="n">lineDirection</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lineDirection</span><span class="p">))))</span>

        <span class="k">if</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">origin</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">getOrientedBoundingBox</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
        <span class="n">edgeLengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">edgeLengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minPostLength</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># extract top half</span>
        <span class="n">zvalues</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">zvalues</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">)</span>

        <span class="n">minZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">zvalues</span><span class="p">)</span>
        <span class="n">maxZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">zvalues</span><span class="p">)</span>

        <span class="n">cluster</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="n">minZ</span> <span class="o">+</span> <span class="n">maxZ</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">maxZ</span><span class="p">])</span>
        <span class="n">origin</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">getOrientedBoundingBox</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
        <span class="n">edgeLengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">edgeLengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxRadius</span> <span class="ow">or</span> <span class="n">edgeLengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxRadius</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">makeCylinderAffordance</span><span class="p">(</span><span class="n">linePoints</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">,</span> <span class="n">lineOrigin</span><span class="p">,</span> <span class="n">postId</span><span class="p">):</span>

        <span class="n">pts</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">linePoints</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pts</span><span class="o">-</span><span class="n">lineOrigin</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">lineOrigin</span> <span class="o">+</span> <span class="n">lineDirection</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">lineOrigin</span> <span class="o">+</span> <span class="n">lineDirection</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">lineLength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p2</span><span class="o">-</span><span class="n">p1</span><span class="p">)</span>
        <span class="n">t</span>  <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">getTransformFromOriginAndNormal</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">)</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">poseFromTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">classname</span><span class="o">=</span><span class="s">&#39;CylinderAffordanceItem&#39;</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="s">&#39;post </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">postId</span><span class="p">,</span>
                    <span class="n">uuid</span><span class="o">=</span><span class="n">newUUID</span><span class="p">(),</span> <span class="n">pose</span><span class="o">=</span><span class="n">pose</span><span class="p">,</span> <span class="n">Radius</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">Length</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">lineLength</span><span class="p">),</span> <span class="n">Color</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="n">desc</span><span class="p">[</span><span class="s">&#39;Collision Enabled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">affordanceManager</span><span class="o">.</span><span class="n">newAffordanceFromDescription</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>


    <span class="n">rejectFolder</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">getOrCreateContainer</span><span class="p">(</span><span class="s">&#39;nonpost clusters&#39;</span><span class="p">,</span> <span class="n">parentObj</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">())</span>
    <span class="n">keepFolder</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">getOrCreateContainer</span><span class="p">(</span><span class="s">&#39;post clusters&#39;</span><span class="p">,</span> <span class="n">parentObj</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>

        <span class="n">linePoint</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">,</span> <span class="n">linePoints</span> <span class="o">=</span> <span class="n">applyLineFit</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isPostCluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">):</span>
            <span class="n">vis</span><span class="o">.</span><span class="n">showPolyData</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s">&#39;cluster </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">getRandomColor</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">keepFolder</span><span class="p">)</span>
            <span class="n">makeCylinderAffordance</span><span class="p">(</span><span class="n">linePoints</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">,</span> <span class="n">linePoint</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vis</span><span class="o">.</span><span class="n">showPolyData</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s">&#39;cluster </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">getRandomColor</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">rejectFolder</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="findAndFitDrillBarrel"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.findAndFitDrillBarrel">[docs]</a><span class="k">def</span> <span class="nf">findAndFitDrillBarrel</span><span class="p">(</span><span class="n">polyData</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Find the horizontal surfaces</span>
<span class="sd">    on the horizontal surfaces, find all the drills</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">polyData</span> <span class="ow">or</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">groundPoints</span><span class="p">,</span> <span class="n">scenePoints</span> <span class="o">=</span>  <span class="n">removeGround</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">groundThickness</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">sceneHeightFromGround</span><span class="o">=</span><span class="mf">0.50</span><span class="p">)</span>

    <span class="n">scenePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">scenePoints</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="n">normalEstimationSearchRadius</span> <span class="o">=</span> <span class="mf">0.10</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPCLNormalEstimation</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetSearchRadius</span><span class="p">(</span><span class="n">normalEstimationSearchRadius</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">scenePoints</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

    <span class="n">normals</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;normals&#39;</span><span class="p">)</span>
    <span class="n">normalsDotUp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="n">normalsDotUp</span><span class="p">,</span> <span class="s">&#39;normals_dot_up&#39;</span><span class="p">)</span>

    <span class="n">surfaces</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;normals_dot_up&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>


    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">groundPoints</span><span class="p">,</span> <span class="s">&#39;ground points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">scenePoints</span><span class="p">,</span> <span class="s">&#39;scene points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;normals_dot_up&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span> <span class="s">&#39;surfaces&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="n">extractClusters</span><span class="p">(</span><span class="n">surfaces</span><span class="p">,</span> <span class="n">clusterTolerance</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">minClusterSize</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="n">fitResults</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">viewFrame</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewFrame</span><span class="p">()</span>
    <span class="n">forwardDirection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">viewFrame</span><span class="o">.</span><span class="n">TransformVector</span><span class="p">(</span><span class="n">forwardDirection</span><span class="p">,</span> <span class="n">forwardDirection</span><span class="p">)</span>
    <span class="n">robotOrigin</span> <span class="o">=</span> <span class="n">viewFrame</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()</span>
    <span class="n">robotForward</span> <span class="o">=</span><span class="n">forwardDirection</span>

    <span class="c">#print &#39;robot origin:&#39;, robotOrigin</span>
    <span class="c">#print &#39;robot forward:&#39;, robotForward</span>
    <span class="n">centroid</span> <span class="o">=</span><span class="p">[]</span>

    <span class="k">for</span> <span class="n">clusterId</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>
        <span class="n">clusterObj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s">&#39;surface cluster </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">clusterId</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">origin</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">getOrientedBoundingBox</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
        <span class="n">edgeLengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span>

        <span class="n">skipCluster</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">edgeLength</span> <span class="ow">in</span> <span class="n">edgeLengths</span><span class="p">:</span>
            <span class="c">#print &#39;cluster %d edge length: %f&#39; % (clusterId, edgeLength)</span>
            <span class="k">if</span> <span class="n">edgeLength</span> <span class="o">&lt;</span> <span class="mf">0.35</span> <span class="ow">or</span> <span class="n">edgeLength</span> <span class="o">&gt;</span> <span class="mf">0.75</span><span class="p">:</span>
                <span class="n">skipCluster</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">skipCluster</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">clusterObj</span><span class="o">.</span><span class="n">setSolidColor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">drillFrame</span> <span class="o">=</span> <span class="n">segmentDrillBarrelFrame</span><span class="p">(</span><span class="n">centroid</span><span class="p">,</span> <span class="n">polyData</span><span class="o">=</span><span class="n">scenePoints</span><span class="p">,</span> <span class="n">forwardDirection</span><span class="o">=</span><span class="n">robotForward</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">drillFrame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">fitResults</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">clusterObj</span><span class="p">,</span> <span class="n">drillFrame</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&#39;fit drill failed for cluster:&#39;</span><span class="p">,</span> <span class="n">clusterId</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">fitResults</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">sortFittedDrills</span><span class="p">(</span><span class="n">fitResults</span><span class="p">,</span> <span class="n">robotOrigin</span><span class="p">,</span> <span class="n">robotForward</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">centroid</span>
</div>
<div class="viewcode-block" id="sortFittedDrills"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.sortFittedDrills">[docs]</a><span class="k">def</span> <span class="nf">sortFittedDrills</span><span class="p">(</span><span class="n">fitResults</span><span class="p">,</span> <span class="n">robotOrigin</span><span class="p">,</span> <span class="n">robotForward</span><span class="p">):</span>

    <span class="n">angleToFitResults</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fitResult</span> <span class="ow">in</span> <span class="n">fitResults</span><span class="p">:</span>
        <span class="n">cluster</span><span class="p">,</span> <span class="n">drillFrame</span> <span class="o">=</span> <span class="n">fitResult</span>
        <span class="n">drillOrigin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">drillFrame</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>
        <span class="n">angleToDrill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">computeSignedAngleBetweenVectors</span><span class="p">(</span><span class="n">robotForward</span><span class="p">,</span> <span class="n">drillOrigin</span> <span class="o">-</span> <span class="n">robotOrigin</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">angleToFitResults</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">angleToDrill</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">drillFrame</span><span class="p">))</span>
        <span class="c">#print &#39;angle to candidate drill:&#39;, angleToDrill</span>

    <span class="n">angleToFitResults</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c">#print &#39;using drill at angle:&#39;, angleToFitResults[0][0]</span>

    <span class="n">drillMesh</span> <span class="o">=</span> <span class="n">getDrillBarrelMesh</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fitResult</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">angleToFitResults</span><span class="p">):</span>

        <span class="n">angleToDrill</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">drillFrame</span> <span class="o">=</span> <span class="n">fitResult</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">drill</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;drill&#39;</span><span class="p">)</span>
            <span class="n">drill</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">drillMesh</span><span class="p">,</span> <span class="s">&#39;drill&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">drillFrame</span> <span class="o">=</span> <span class="n">updateFrame</span><span class="p">(</span><span class="n">drillFrame</span><span class="p">,</span> <span class="s">&#39;drill frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">drill</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">drill</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">drillFrame</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>

            <span class="n">drill</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">otdf_type</span><span class="o">=</span><span class="s">&#39;dewalt_button&#39;</span><span class="p">,</span> <span class="n">friendly_name</span><span class="o">=</span><span class="s">&#39;dewalt_button&#39;</span><span class="p">))</span>
            <span class="n">drill</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>

            <span class="n">drill</span><span class="o">.</span><span class="n">setSolidColor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="c">#cluster.setProperty(&#39;Visible&#39;, True)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">drill</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">drillMesh</span><span class="p">,</span> <span class="s">&#39;drill candidate&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">())</span>
            <span class="n">drill</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">drillFrame</span><span class="p">)</span>
            <span class="n">om</span><span class="o">.</span><span class="n">addToObjectModel</span><span class="p">(</span><span class="n">drill</span><span class="p">,</span> <span class="n">parentObj</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="computeSignedAngleBetweenVectors"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.computeSignedAngleBetweenVectors">[docs]</a><span class="k">def</span> <span class="nf">computeSignedAngleBetweenVectors</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">perpendicularVector</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Computes the signed angle between two vectors in 3d, given a perpendicular vector</span>
<span class="sd">    to determine sign.  Result returned is radians.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">perpendicularVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">perpendicularVector</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">perpendicularVector</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">perpendicularVector</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">perpendicularVector</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="segmentDrillBarrelFrame"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDrillBarrelFrame">[docs]</a><span class="k">def</span> <span class="nf">segmentDrillBarrelFrame</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">polyData</span><span class="p">,</span> <span class="n">forwardDirection</span><span class="p">):</span>

    <span class="n">tableClusterSearchRadius</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="n">drillClusterSearchRadius</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c">#0.3</span>


    <span class="n">expectedNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">plane_origin</span><span class="p">,</span> <span class="n">plane_normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">expectedNormal</span><span class="p">,</span>
        <span class="n">perpendicularAxis</span><span class="o">=</span><span class="n">expectedNormal</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span>
        <span class="n">searchRadius</span><span class="o">=</span><span class="n">tableClusterSearchRadius</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="n">tablePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">,</span> <span class="s">&#39;table plane points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">tablePoints</span> <span class="o">=</span> <span class="n">labelDistanceToPoint</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">,</span> <span class="n">point1</span><span class="p">)</span>
    <span class="n">tablePointsClusters</span> <span class="o">=</span> <span class="n">extractClusters</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">)</span>
    <span class="n">tablePointsClusters</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#39;distance_to_point&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tablePointsClusters</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">tablePoints</span> <span class="o">=</span> <span class="n">tablePointsClusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">,</span> <span class="s">&#39;table points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">searchRegion</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="n">searchRegion</span> <span class="o">=</span> <span class="n">cropToSphere</span><span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">drillClusterSearchRadius</span><span class="p">)</span>
    <span class="c">#drillPoints = extractLargestCluster(searchRegion, minClusterSize=1)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">fitDrillBarrel</span> <span class="p">(</span><span class="n">searchRegion</span><span class="p">,</span> <span class="n">forwardDirection</span><span class="p">,</span> <span class="n">plane_origin</span><span class="p">,</span> <span class="n">plane_normal</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>




</div>
<div class="viewcode-block" id="segmentDrillBarrel"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDrillBarrel">[docs]</a><span class="k">def</span> <span class="nf">segmentDrillBarrel</span><span class="p">(</span><span class="n">point1</span><span class="p">):</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">forwardDirection</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">getCurrentView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">())</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">segmentDrillBarrel</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">polyData</span><span class="p">,</span> <span class="n">forwardDirection</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="n">drillMesh</span> <span class="o">=</span> <span class="n">getDrillBarrelMesh</span><span class="p">()</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">drillMesh</span><span class="p">,</span> <span class="s">&#39;drill&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">drillFrame</span> <span class="o">=</span> <span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;drill frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">drillFrame</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">aff</span><span class="p">,</span> <span class="n">drillFrame</span>


</div>
<div class="viewcode-block" id="segmentDrillAlignedWithTable"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDrillAlignedWithTable">[docs]</a><span class="k">def</span> <span class="nf">segmentDrillAlignedWithTable</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">polyData</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Yet Another Drill Fitting Algorithm [tm]</span>
<span class="sd">    This one fits the button drill assuming its on the table</span>
<span class="sd">    and aligned with the table frame (because the button drill orientation is difficult to find)</span>
<span class="sd">    Table must have long side facing robot</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">polyData</span> <span class="ow">or</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="c"># segment the table and recover the precise up direction normal:</span>
    <span class="n">polyDataOut</span><span class="p">,</span> <span class="n">tablePoints</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">segmentTable</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span><span class="n">point</span><span class="p">)</span>
    <span class="c">#print origin # this origin is bunk</span>
    <span class="c">#tableCentroid = computeCentroid(tablePoints)</span>

    <span class="c"># get the bounding box edges</span>
    <span class="n">OBBorigin</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">getOrientedBoundingBox</span><span class="p">(</span><span class="n">tablePoints</span><span class="p">)</span>
    <span class="c">#print &quot;OBB out&quot;</span>
    <span class="c">#print OBBorigin</span>
    <span class="c">#print edges</span>
    <span class="n">edgeLengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">])</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>
    <span class="c">#print edgeLengths</span>
    <span class="c">#print axes</span>

    <span class="c"># check which direction the robot is facing and flip x-axis of table if necessary</span>
    <span class="n">viewDirection</span> <span class="o">=</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewDirection</span><span class="p">()</span>
    <span class="c">#print &quot;main axes&quot;, axes[1]</span>
    <span class="c">#print &quot;viewDirection&quot;, viewDirection</span>
    <span class="c">#dp = np.dot(axes[1], viewDirection)</span>
    <span class="c">#print dp</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">viewDirection</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c">#print &quot;flip the x-direction&quot;</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


    <span class="c"># define the x-axis to be along the 2nd largest edge</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">normal</span> <span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">tableOrientation</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>

    <span class="c">#tableTransform = transformUtils.frameFromPositionAndRPY( tableCentroid , tableOrientation.GetOrientation() )</span>
    <span class="c">#updateFrame(tableTransform, &#39;table frame [z up, x away face]&#39;, parent=&quot;segmentation&quot;, visible=True).addToView(app.getDRCView())</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">segmentTableScene</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">point</span> <span class="p">)</span>
    <span class="c">#vis.showClusterObjects(data.clusters + [data.table], parent=&#39;segmentation&#39;)</span>

    <span class="c"># crude use of the table frame to determine the frame of the drill on the table</span>
    <span class="c">#t2 = transformUtils.frameFromPositionAndRPY([0,0,0], [180, 0 , 90] )</span>
    <span class="c">#drillOrientationTransform = transformUtils.copyFrame( om.findObjectByName(&#39;object 1 frame&#39;).transform )</span>
    <span class="c">#drillOrientationTransform.PreMultiply()</span>
    <span class="c">#drillOrientationTransform.Concatenate(t2)</span>
    <span class="c">#vis.updateFrame(t, &#39;drillOrientationTransform&#39;,visible=True)</span>

    <span class="c">#table_xaxis, table_yaxis, table_zaxis = transformUtils.getAxesFromTransform( data.table.frame )</span>
    <span class="c">#drillOrientation = transformUtils.orientationFromAxes( table_yaxis, table_xaxis,  -1*np.array( table_zaxis) )</span>
    <span class="n">drillTransform</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()</span> <span class="p">,</span> <span class="n">tableOrientation</span><span class="o">.</span><span class="n">GetOrientation</span><span class="p">()</span> <span class="p">)</span>

    <span class="n">drillMesh</span> <span class="o">=</span> <span class="n">getDrillMesh</span><span class="p">()</span>

    <span class="n">drill</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;drill&#39;</span><span class="p">)</span>
    <span class="n">om</span><span class="o">.</span><span class="n">removeFromObjectModel</span><span class="p">(</span><span class="n">drill</span><span class="p">)</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">drillMesh</span><span class="p">,</span> <span class="s">&#39;drill&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">drillTransform</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">frameObj</span> <span class="o">=</span> <span class="n">updateFrame</span><span class="p">(</span><span class="n">drillTransform</span><span class="p">,</span> <span class="s">&#39;drill frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">frameObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">getDrillAffordanceParams</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">drillTransform</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">drillType</span><span class="o">=</span><span class="s">&quot;dewalt_button&quot;</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="segmentDrillInHand"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDrillInHand">[docs]</a><span class="k">def</span> <span class="nf">segmentDrillInHand</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="n">distanceToLineThreshold</span> <span class="o">=</span> <span class="mf">0.05</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelDistanceToLine</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;distance_to_line&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">distanceToLineThreshold</span><span class="p">])</span>

    <span class="n">lineSegment</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
    <span class="n">lineLength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lineSegment</span><span class="p">)</span>

    <span class="n">cropped</span><span class="p">,</span> <span class="n">polyData</span> <span class="o">=</span> <span class="n">cropToPlane</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">lineSegment</span><span class="o">/</span><span class="n">lineLength</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">lineLength</span> <span class="o">+</span> <span class="mf">0.03</span><span class="p">])</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span> <span class="s">&#39;drill cluster&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">drillPoints</span> <span class="o">=</span> <span class="n">cropped</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">lineSegment</span><span class="o">/</span><span class="n">lineLength</span>

    <span class="n">centroids</span> <span class="o">=</span> <span class="n">computeCentroids</span><span class="p">(</span><span class="n">drillPoints</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">normal</span><span class="p">)</span>

    <span class="n">centroidsPolyData</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getVtkPolyDataFromNumpyPoints</span><span class="p">(</span><span class="n">centroids</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">centroidsPolyData</span><span class="p">,</span> <span class="s">&#39;cluster centroids&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">drillToTopPoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.002904</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.010029</span><span class="p">,</span> <span class="mf">0.153182</span><span class="p">])</span>

    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">normal</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">centroids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">centroids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PreMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="o">-</span><span class="n">drillToTopPoint</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>

    <span class="n">drillMesh</span> <span class="o">=</span> <span class="n">getDrillMesh</span><span class="p">()</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">drillMesh</span><span class="p">,</span> <span class="s">&#39;drill&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;drill frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">getDrillAffordanceParams</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()),</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>


</div>
<div class="viewcode-block" id="addDrillAffordance"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.addDrillAffordance">[docs]</a><span class="k">def</span> <span class="nf">addDrillAffordance</span><span class="p">():</span>

    <span class="n">drillMesh</span> <span class="o">=</span> <span class="n">getDrillMesh</span><span class="p">()</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">showPolyData</span><span class="p">(</span><span class="n">drillMesh</span><span class="p">,</span> <span class="s">&#39;drill&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">FrameAffordanceItem</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;drill frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">getDrillAffordanceParams</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">aff</span>

</div>
<div class="viewcode-block" id="getLinkFrame"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getLinkFrame">[docs]</a><span class="k">def</span> <span class="nf">getLinkFrame</span><span class="p">(</span><span class="n">linkName</span><span class="p">):</span>
    <span class="n">robotStateModel</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;robot state model&#39;</span><span class="p">)</span>
    <span class="n">robotStateModel</span> <span class="o">=</span> <span class="n">robotStateModel</span> <span class="ow">or</span> <span class="n">getVisibleRobotModel</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">robotStateModel</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">robotStateModel</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getLinkToWorld</span><span class="p">(</span><span class="n">linkName</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>

</div>
<div class="viewcode-block" id="getDrillInHandOffset"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getDrillInHandOffset">[docs]</a><span class="k">def</span> <span class="nf">getDrillInHandOffset</span><span class="p">(</span><span class="n">zRotation</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">zTranslation</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xTranslation</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">yTranslation</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">flip</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="n">drillOffset</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">drillOffset</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">flip</span><span class="p">:</span>
        <span class="n">drillOffset</span><span class="o">.</span><span class="n">RotateY</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span>
    <span class="n">drillOffset</span><span class="o">.</span><span class="n">RotateZ</span><span class="p">(</span><span class="n">zRotation</span><span class="p">)</span>
    <span class="n">drillOffset</span><span class="o">.</span><span class="n">RotateY</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span>
    <span class="c">#drillOffset.Translate(0, 0.09, zTranslation - 0.015)</span>
    <span class="c">#drillOffset.Translate(zTranslation - 0.015, 0.035 + xTranslation, 0.0)</span>
    <span class="n">drillOffset</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">zTranslation</span><span class="p">,</span> <span class="n">xTranslation</span><span class="p">,</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="n">yTranslation</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">drillOffset</span>

</div>
<div class="viewcode-block" id="moveDrillToHand"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.moveDrillToHand">[docs]</a><span class="k">def</span> <span class="nf">moveDrillToHand</span><span class="p">(</span><span class="n">drillOffset</span><span class="p">,</span> <span class="n">hand</span><span class="o">=</span><span class="s">&#39;right&#39;</span><span class="p">):</span>
    <span class="n">drill</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;drill&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">drill</span><span class="p">:</span>
        <span class="n">drill</span> <span class="o">=</span> <span class="n">addDrillAffordance</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">hand</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;right&#39;</span><span class="p">,</span> <span class="s">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">drillTransform</span> <span class="o">=</span> <span class="n">drill</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetUserTransform</span><span class="p">()</span>
    <span class="n">rightBaseLink</span> <span class="o">=</span> <span class="n">getLinkFrame</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_hand_face&#39;</span> <span class="o">%</span> <span class="n">hand</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">drillTransform</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">drillTransform</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
    <span class="n">drillTransform</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">drillOffset</span><span class="p">)</span>
    <span class="n">drillTransform</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">rightBaseLink</span><span class="p">)</span>
    <span class="n">drill</span><span class="o">.</span><span class="n">_renderAllViews</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="PointPicker"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.PointPicker">[docs]</a><span class="k">class</span> <span class="nc">PointPicker</span><span class="p">(</span><span class="n">TimerCallback</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">TimerCallback</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetFps</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numberOfPoints</span> <span class="o">=</span> <span class="n">numberOfPoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotationObj</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="PointPicker.clear"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.PointPicker.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfPoints</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hoverPos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastMovePos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="PointPicker.onMouseMove"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.PointPicker.onMouseMove">[docs]</a>    <span class="k">def</span> <span class="nf">onMouseMove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displayPoint</span><span class="p">,</span> <span class="n">modifiers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastMovePos</span> <span class="o">=</span> <span class="n">displayPoint</span>
</div>
<div class="viewcode-block" id="PointPicker.onMousePress"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.PointPicker.onMousePress">[docs]</a>    <span class="k">def</span> <span class="nf">onMousePress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displayPoint</span><span class="p">,</span> <span class="n">modifiers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c">#print &#39;mouse press:&#39;, modifiers</span>
        <span class="c">#if not modifiers:</span>
        <span class="c">#    return</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfPoints</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoverPos</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="PointPicker.finish"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.PointPicker.finish">[docs]</a>    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">om</span><span class="o">.</span><span class="n">removeFromObjectModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotationObj</span><span class="p">)</span>

        <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotationFunc</span><span class="p">(</span><span class="o">*</span><span class="n">points</span><span class="p">)</span>

        <span class="n">removeViewPicker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PointPicker.handleRelease"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.PointPicker.handleRelease">[docs]</a>    <span class="k">def</span> <span class="nf">handleRelease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displayPoint</span><span class="p">):</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="PointPicker.draw"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.PointPicker.draw">[docs]</a>    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>

        <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoverPos</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">]</span>

        <span class="c"># draw points</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawLines</span><span class="p">:</span>
            <span class="c"># draw lines</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

            <span class="c"># connect end points</span>
            <span class="k">if</span> <span class="n">points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">annotationObj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;annotation&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotationObj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Color&#39;</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotationObj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetPickable</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="PointPicker.tick"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.PointPicker.tick">[docs]</a>    <span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hoverPos</span> <span class="o">=</span> <span class="n">pickPoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastMovePos</span><span class="p">,</span> <span class="n">getSegmentationView</span><span class="p">(),</span> <span class="n">obj</span><span class="o">=</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="LineDraw"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.LineDraw">[docs]</a><span class="k">class</span> <span class="nc">LineDraw</span><span class="p">(</span><span class="n">TimerCallback</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="n">TimerCallback</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetFps</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">renderer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkLeaderActor2D</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">SetArrowPlacementToNone</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">GetPositionCoordinate</span><span class="p">()</span><span class="o">.</span><span class="n">SetCoordinateSystemToViewport</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">GetPosition2Coordinate</span><span class="p">()</span><span class="o">.</span><span class="n">SetCoordinateSystemToViewport</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetLineWidth</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">SetPosition2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="LineDraw.clear"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.LineDraw.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p2</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastMovePos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">RemoveActor2D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LineDraw.onMouseMove"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.LineDraw.onMouseMove">[docs]</a>    <span class="k">def</span> <span class="nf">onMouseMove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displayPoint</span><span class="p">,</span> <span class="n">modifiers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastMovePos</span> <span class="o">=</span> <span class="n">displayPoint</span>
</div>
<div class="viewcode-block" id="LineDraw.onMousePress"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.LineDraw.onMousePress">[docs]</a>    <span class="k">def</span> <span class="nf">onMousePress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displayPoint</span><span class="p">,</span> <span class="n">modifiers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastMovePos</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">AddActor2D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastMovePos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="LineDraw.finish"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.LineDraw.finish">[docs]</a>    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">RemoveActor2D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotationFunc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p2</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="LineDraw.handleRelease"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.LineDraw.handleRelease">[docs]</a>    <span class="k">def</span> <span class="nf">handleRelease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displayPoint</span><span class="p">):</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="LineDraw.tick"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.LineDraw.tick">[docs]</a>    <span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">SetPosition2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastMovePos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</div></div>
<span class="n">viewPickers</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="addViewPicker"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.addViewPicker">[docs]</a><span class="k">def</span> <span class="nf">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">viewPickers</span>
    <span class="n">viewPickers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="removeViewPicker"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.removeViewPicker">[docs]</a><span class="k">def</span> <span class="nf">removeViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">viewPickers</span>
    <span class="n">viewPickers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="distanceToLine"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.distanceToLine">[docs]</a><span class="k">def</span> <span class="nf">distanceToLine</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
    <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">((</span><span class="n">x0</span> <span class="o">-</span> <span class="n">x1</span><span class="p">),</span> <span class="p">(</span><span class="n">x0</span><span class="o">-</span><span class="n">x2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denom</span>

</div>
<div class="viewcode-block" id="labelDistanceToLine"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.labelDistanceToLine">[docs]</a><span class="k">def</span> <span class="nf">labelDistanceToLine</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">linePoint1</span><span class="p">,</span> <span class="n">linePoint2</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="o">=</span><span class="s">&#39;distance_to_line&#39;</span><span class="p">):</span>

    <span class="n">x0</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">linePoint1</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">linePoint2</span><span class="p">)</span>

    <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">((</span><span class="n">x0</span> <span class="o">-</span> <span class="n">x1</span><span class="p">),</span> <span class="p">(</span><span class="n">x0</span><span class="o">-</span><span class="n">x2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denom</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">dists</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">polyData</span>

</div>
<div class="viewcode-block" id="labelDistanceToPoint"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.labelDistanceToPoint">[docs]</a><span class="k">def</span> <span class="nf">labelDistanceToPoint</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="o">=</span><span class="s">&#39;distance_to_point&#39;</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">points</span> <span class="o">-</span> <span class="n">point</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">points</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">dists</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">polyData</span>

</div>
<div class="viewcode-block" id="getPlaneEquationFromPolyData"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getPlaneEquationFromPolyData">[docs]</a><span class="k">def</span> <span class="nf">getPlaneEquationFromPolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="p">):</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span>  <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">expectedNormal</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">normal</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)]))</span>



</div>
<div class="viewcode-block" id="computeEdge"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.computeEdge">[docs]</a><span class="k">def</span> <span class="nf">computeEdge</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">edgeAxis</span><span class="p">,</span> <span class="n">perpAxis</span><span class="p">,</span> <span class="n">binWidth</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelPointDistanceAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">edgeAxis</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="o">=</span><span class="s">&#39;dist_along_edge&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelPointDistanceAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">perpAxis</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="o">=</span><span class="s">&#39;dist_perp_to_edge&#39;</span><span class="p">)</span>


    <span class="n">polyData</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">binByScalar</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_along_edge&#39;</span><span class="p">,</span> <span class="n">binWidth</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">binLabels</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;bin_labels&#39;</span><span class="p">)</span>
    <span class="n">distToEdge</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_perp_to_edge&#39;</span><span class="p">)</span>

    <span class="n">numberOfBins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">edgePoints</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">numberOfBins</span><span class="p">):</span>
        <span class="n">binPoints</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">binLabels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">binDists</span> <span class="o">=</span> <span class="n">distToEdge</span><span class="p">[</span><span class="n">binLabels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">binDists</span><span class="p">):</span>
            <span class="n">edgePoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binPoints</span><span class="p">[</span><span class="n">binDists</span><span class="o">.</span><span class="n">argmax</span><span class="p">()])</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edgePoints</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="computeCentroids"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.computeCentroids">[docs]</a><span class="k">def</span> <span class="nf">computeCentroids</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">binWidth</span><span class="o">=</span><span class="mf">0.025</span><span class="p">):</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelPointDistanceAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="o">=</span><span class="s">&#39;dist_along_axis&#39;</span><span class="p">)</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">binByScalar</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_along_axis&#39;</span><span class="p">,</span> <span class="n">binWidth</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">binLabels</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;bin_labels&#39;</span><span class="p">)</span>

    <span class="n">numberOfBins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">numberOfBins</span><span class="p">):</span>
        <span class="n">binPoints</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">binLabels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">binPoints</span><span class="p">):</span>
            <span class="n">centroids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">binPoints</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">centroids</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="computePointCountsAlongAxis"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.computePointCountsAlongAxis">[docs]</a><span class="k">def</span> <span class="nf">computePointCountsAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">binWidth</span><span class="o">=</span><span class="mf">0.025</span><span class="p">):</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelPointDistanceAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="o">=</span><span class="s">&#39;dist_along_axis&#39;</span><span class="p">)</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">binByScalar</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_along_axis&#39;</span><span class="p">,</span> <span class="n">binWidth</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">binLabels</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;bin_labels&#39;</span><span class="p">)</span>

    <span class="n">numberOfBins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">binCount</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">numberOfBins</span><span class="p">):</span>
        <span class="n">binPoints</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">binLabels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">binCount</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binPoints</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">binCount</span><span class="p">)</span>



</div>
<div class="viewcode-block" id="binByScalar"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.binByScalar">[docs]</a><span class="k">def</span> <span class="nf">binByScalar</span><span class="p">(</span><span class="n">lidarData</span><span class="p">,</span> <span class="n">scalarArrayName</span><span class="p">,</span> <span class="n">binWidth</span><span class="p">,</span> <span class="n">binLabelsArrayName</span><span class="o">=</span><span class="s">&#39;bin_labels&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Gets the array with name scalarArrayName from lidarData.</span>
<span class="sd">    Computes bins by dividing the scalar array into bins of size binWidth.</span>
<span class="sd">    Adds a new label array to the lidar points identifying which bin the point belongs to,</span>
<span class="sd">    where the first bin is labeled with 0.</span>
<span class="sd">    Returns the new, labeled lidar data and the bins.</span>
<span class="sd">    The bins are an array where each value represents a bin edge.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">scalars</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">lidarData</span><span class="p">,</span> <span class="n">scalarArrayName</span><span class="p">)</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">scalars</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">scalars</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">binWidth</span><span class="p">,</span> <span class="n">binWidth</span><span class="p">)</span>
    <span class="n">binLabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">scalars</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binLabels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">scalars</span><span class="p">))</span>
    <span class="n">newData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">lidarData</span><span class="p">)</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">newData</span><span class="p">,</span> <span class="n">binLabels</span><span class="p">,</span> <span class="n">binLabelsArrayName</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newData</span><span class="p">,</span> <span class="n">bins</span>

</div>
<div class="viewcode-block" id="showObbs"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.showObbs">[docs]</a><span class="k">def</span> <span class="nf">showObbs</span><span class="p">(</span><span class="n">polyData</span><span class="p">):</span>

    <span class="n">labelsArrayName</span> <span class="o">=</span> <span class="s">&#39;cluster_labels&#39;</span>
    <span class="k">assert</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">labelsArrayName</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkAnnotateOBBs</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetInputArrayToProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkDataObject</span><span class="o">.</span><span class="n">FIELD_ASSOCIATION_POINTS</span><span class="p">,</span> <span class="n">labelsArrayName</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">showPolyData</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">(),</span> <span class="s">&#39;bboxes&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="getOrientedBoundingBox"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getOrientedBoundingBox">[docs]</a><span class="k">def</span> <span class="nf">getOrientedBoundingBox</span><span class="p">(</span><span class="n">polyData</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    returns origin, edges, and outline wireframe</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nPoints</span> <span class="o">=</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">nPoints</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>

    <span class="n">labelsArrayName</span> <span class="o">=</span> <span class="s">&#39;bbox_labels&#39;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nPoints</span><span class="p">)</span>
    <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">addNumpyToVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">labelsArrayName</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkAnnotateOBBs</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetInputArrayToProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkDataObject</span><span class="o">.</span><span class="n">FIELD_ASSOCIATION_POINTS</span><span class="p">,</span> <span class="n">labelsArrayName</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">GetNumberOfBoundingBoxes</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

    <span class="n">f</span><span class="o">.</span><span class="n">GetBoundingBoxOrigin</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">GetBoundingBoxEdge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">origin</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="segmentBlockByAnnotation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentBlockByAnnotation">[docs]</a><span class="k">def</span> <span class="nf">segmentBlockByAnnotation</span><span class="p">(</span><span class="n">blockDimensions</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">):</span>

    <span class="n">segmentationObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">segmentationObj</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">ScalarVisibilityOff</span><span class="p">()</span>
    <span class="n">segmentationObj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Point Size&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">segmentationObj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Alpha&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>

    <span class="c"># constraint z to lie in plane</span>
    <span class="c">#p1[2] = p2[2] = p3[2] = max(p1[2], p2[2], p3[2])</span>

    <span class="n">zedge</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">zedge</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">zedge</span><span class="p">)</span>

    <span class="c">#xwidth = distanceToLine(p3, p1, p2)</span>

    <span class="c"># expected dimensions</span>
    <span class="n">xwidth</span><span class="p">,</span> <span class="n">ywidth</span> <span class="o">=</span> <span class="n">blockDimensions</span>

    <span class="n">zwidth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">zedge</span><span class="p">)</span>

    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p3</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">yaxis</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>

    <span class="c"># reorient axes</span>
    <span class="n">viewPlaneNormal</span> <span class="o">=</span> <span class="n">getSegmentationView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">viewPlaneNormal</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">yaxis</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">p3</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xaxis</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c"># make right handed</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="p">((</span><span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">xaxis</span><span class="o">*</span><span class="n">xwidth</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">yaxis</span><span class="o">*</span><span class="n">ywidth</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">origin</span> <span class="o">-</span> <span class="n">xaxis</span><span class="o">*</span><span class="n">xwidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">xaxis</span><span class="o">*</span><span class="n">xwidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">origin</span> <span class="o">-</span> <span class="n">yaxis</span><span class="o">*</span><span class="n">ywidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">yaxis</span><span class="o">*</span><span class="n">ywidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">origin</span> <span class="o">-</span> <span class="n">zaxis</span><span class="o">*</span><span class="n">zwidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">zaxis</span><span class="o">*</span><span class="n">zwidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;block axes&#39;</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Color&#39;</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Visible&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;annotation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Visible&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="n">cube</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCubeSource</span><span class="p">()</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">SetXLength</span><span class="p">(</span><span class="n">xwidth</span><span class="p">)</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">SetYLength</span><span class="p">(</span><span class="n">ywidth</span><span class="p">)</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">SetZLength</span><span class="p">(</span><span class="n">zwidth</span><span class="p">)</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">cube</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="s">&#39;block affordance&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">BlockAffordanceItem</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;affordances&#39;</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">xwidth</span><span class="o">=</span><span class="n">xwidth</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="n">ywidth</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="n">zwidth</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>



<span class="c">####</span>
<span class="c"># debrs task ground frame</span>
</div>
<div class="viewcode-block" id="getBoardCorners"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getBoardCorners">[docs]</a><span class="k">def</span> <span class="nf">getBoardCorners</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;xaxis&#39;</span><span class="p">,</span> <span class="s">&#39;yaxis&#39;</span><span class="p">,</span> <span class="s">&#39;zaxis&#39;</span><span class="p">]]</span>
    <span class="n">widths</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;xwidth&#39;</span><span class="p">,</span> <span class="s">&#39;ywidth&#39;</span><span class="p">,</span> <span class="s">&#39;zwidth&#39;</span><span class="p">]]</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">[</span>
            <span class="n">origin</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">origin</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">origin</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">origin</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">origin</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">origin</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">origin</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">origin</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
           <span class="p">]</span>
</div>
<div class="viewcode-block" id="getPointDistances"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getPointDistances">[docs]</a><span class="k">def</span> <span class="nf">getPointDistances</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="computeClosestCorner"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.computeClosestCorner">[docs]</a><span class="k">def</span> <span class="nf">computeClosestCorner</span><span class="p">(</span><span class="n">aff</span><span class="p">,</span> <span class="n">referenceFrame</span><span class="p">):</span>
    <span class="n">corners</span> <span class="o">=</span> <span class="n">getBoardCorners</span><span class="p">(</span><span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">getPointDistances</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">referenceFrame</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()),</span> <span class="n">corners</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">corners</span><span class="p">[</span><span class="n">dists</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>

</div>
<div class="viewcode-block" id="computeGroundFrame"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.computeGroundFrame">[docs]</a><span class="k">def</span> <span class="nf">computeGroundFrame</span><span class="p">(</span><span class="n">aff</span><span class="p">,</span> <span class="n">referenceFrame</span><span class="p">):</span>

    <span class="n">refAxis</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">referenceFrame</span><span class="o">.</span><span class="n">TransformVector</span><span class="p">(</span><span class="n">refAxis</span><span class="p">,</span> <span class="n">refAxis</span><span class="p">)</span>

    <span class="n">refAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">refAxis</span><span class="p">)</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;xaxis&#39;</span><span class="p">,</span> <span class="s">&#39;yaxis&#39;</span><span class="p">,</span> <span class="s">&#39;zaxis&#39;</span><span class="p">]]</span>
    <span class="n">axisProjections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">refAxis</span><span class="p">))</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">])</span>
    <span class="n">boardAxis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">axisProjections</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">boardAxis</span><span class="p">,</span> <span class="n">refAxis</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">boardAxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">boardAxis</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">boardAxis</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">closestCorner</span> <span class="o">=</span> <span class="n">computeClosestCorner</span><span class="p">(</span><span class="n">aff</span><span class="p">,</span> <span class="n">referenceFrame</span><span class="p">)</span>
    <span class="n">groundFrame</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">groundFrame</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">groundFrame</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">closestCorner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">closestCorner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">groundFrame</span>

</div>
<div class="viewcode-block" id="computeCornerFrame"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.computeCornerFrame">[docs]</a><span class="k">def</span> <span class="nf">computeCornerFrame</span><span class="p">(</span><span class="n">aff</span><span class="p">,</span> <span class="n">referenceFrame</span><span class="p">):</span>

    <span class="n">refAxis</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">referenceFrame</span><span class="o">.</span><span class="n">TransformVector</span><span class="p">(</span><span class="n">refAxis</span><span class="p">,</span> <span class="n">refAxis</span><span class="p">)</span>

    <span class="n">refAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">refAxis</span><span class="p">)</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;xaxis&#39;</span><span class="p">,</span> <span class="s">&#39;yaxis&#39;</span><span class="p">,</span> <span class="s">&#39;zaxis&#39;</span><span class="p">]]</span>
    <span class="n">edgeLengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">edgeLength</span> <span class="k">for</span> <span class="n">edgeLength</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;xwidth&#39;</span><span class="p">,</span> <span class="s">&#39;ywidth&#39;</span><span class="p">,</span> <span class="s">&#39;zwidth&#39;</span><span class="p">]]</span>

    <span class="n">axisProjections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">refAxis</span><span class="p">))</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">])</span>
    <span class="n">boardAxis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">axisProjections</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">boardAxis</span><span class="p">,</span> <span class="n">refAxis</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">boardAxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">boardAxis</span>

    <span class="n">longAxis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">edgeLengths</span><span class="p">)]</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">boardAxis</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>

    <span class="n">closestCorner</span> <span class="o">=</span> <span class="n">computeClosestCorner</span><span class="p">(</span><span class="n">aff</span><span class="p">,</span> <span class="n">referenceFrame</span><span class="p">)</span>
    <span class="n">cornerFrame</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">cornerFrame</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">cornerFrame</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">closestCorner</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cornerFrame</span>

</div>
<div class="viewcode-block" id="publishTriad"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.publishTriad">[docs]</a><span class="k">def</span> <span class="nf">publishTriad</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">collectionId</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>

    <span class="n">o</span> <span class="o">=</span> <span class="n">lcmvs</span><span class="o">.</span><span class="n">obj_t</span><span class="p">()</span>

    <span class="n">xyz</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()</span>
    <span class="n">rpy</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">rollPitchYawFromTransform</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>

    <span class="n">o</span><span class="o">.</span><span class="n">roll</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">yaw</span> <span class="o">=</span> <span class="n">rpy</span>
    <span class="n">o</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">xyz</span>
    <span class="n">o</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">lcmvs</span><span class="o">.</span><span class="n">obj_collection_t</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">collectionId</span>
    <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;stance_triads&#39;</span>
    <span class="n">m</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">lcmvs</span><span class="o">.</span><span class="n">obj_collection_t</span><span class="o">.</span><span class="n">AXIS3D</span>
    <span class="n">m</span><span class="o">.</span><span class="n">nobjs</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">m</span><span class="o">.</span><span class="n">reset</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">m</span><span class="o">.</span><span class="n">objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="p">]</span>

    <span class="n">lcmUtils</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s">&#39;OBJ_COLLECTION&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="createBlockAffordance"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.createBlockAffordance">[docs]</a><span class="k">def</span> <span class="nf">createBlockAffordance</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">,</span> <span class="n">xwidth</span><span class="p">,</span> <span class="n">ywidth</span><span class="p">,</span> <span class="n">zwidth</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;affordances&#39;</span><span class="p">):</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">BoxAffordanceItem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">getCurrentRenderView</span><span class="p">())</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Dimensions&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">xwidth</span><span class="p">,</span> <span class="n">ywidth</span><span class="p">,</span> <span class="n">zwidth</span><span class="p">]])</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">om</span><span class="o">.</span><span class="n">addToObjectModel</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">parentObj</span><span class="o">=</span><span class="n">om</span><span class="o">.</span><span class="n">getOrCreateContainer</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>
    <span class="n">frameObj</span> <span class="o">=</span> <span class="n">vis</span><span class="o">.</span><span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39; frame&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>
    <span class="n">frameObj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">affordanceManager</span><span class="o">.</span><span class="n">registerAffordance</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span>

</div>
<div class="viewcode-block" id="segmentBlockByTopPlane"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentBlockByTopPlane">[docs]</a><span class="k">def</span> <span class="nf">segmentBlockByTopPlane</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">blockDimensions</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="p">,</span> <span class="n">expectedXAxis</span><span class="p">,</span> <span class="n">edgeSign</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;block affordance&#39;</span><span class="p">):</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">planeOrigin</span><span class="p">,</span> <span class="n">normal</span>  <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">expectedNormal</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">applyLineFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>

    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">lineDirection</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">normal</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">expectedXAxis</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xaxis</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c"># make right handed</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">zaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">zaxis</span><span class="p">)</span>

    <span class="n">expectedXAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>

    <span class="n">edgePoints</span> <span class="o">=</span> <span class="n">computeEdge</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">*</span><span class="n">edgeSign</span><span class="p">)</span>
    <span class="n">edgePoints</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getVtkPolyDataFromNumpyPoints</span><span class="p">(</span><span class="n">edgePoints</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">edgePoints</span><span class="p">,</span> <span class="s">&#39;edge points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">linePoint</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">applyLineFit</span><span class="p">(</span><span class="n">edgePoints</span><span class="p">)</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">lineDirection</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">expectedXAxis</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xaxis</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c"># make right handed</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">zaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">zaxis</span><span class="p">)</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelPointDistanceAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="o">=</span><span class="s">&#39;dist_along_line&#39;</span><span class="p">)</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pts</span><span class="o">-</span><span class="n">linePoint</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">linePoint</span> <span class="o">+</span> <span class="n">zaxis</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">linePoint</span> <span class="o">+</span> <span class="n">zaxis</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">projectPointToPlane</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">planeOrigin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">projectPointToPlane</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">planeOrigin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>

    <span class="n">xwidth</span><span class="p">,</span> <span class="n">ywidth</span> <span class="o">=</span> <span class="n">blockDimensions</span>
    <span class="n">zwidth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">edgeSign</span><span class="o">*</span><span class="n">xaxis</span><span class="o">*</span><span class="n">xwidth</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">yaxis</span><span class="o">*</span><span class="n">ywidth</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">zaxis</span><span class="o">*</span><span class="n">zwidth</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>

    <span class="c">#d.addSphere(linePoint, radius=0.02)</span>
    <span class="c">#d.addLine(linePoint, linePoint + yaxis*ywidth)</span>
    <span class="c">#d.addLine(linePoint, linePoint + xaxis*xwidth)</span>
    <span class="c">#d.addLine(linePoint, linePoint + zaxis*zwidth)</span>


    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>

    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="c">#d.addLine(origin - xaxis*xwidth/2.0, origin + xaxis*xwidth/2.0)</span>
    <span class="c">#d.addLine(origin - yaxis*ywidth/2.0, origin + yaxis*ywidth/2.0)</span>
    <span class="c">#d.addLine(origin - zaxis*zwidth/2.0, origin + zaxis*zwidth/2.0)</span>

    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">xaxis</span><span class="o">*</span><span class="n">xwidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">yaxis</span><span class="o">*</span><span class="n">ywidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">zaxis</span><span class="o">*</span><span class="n">zwidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>


    <span class="c">#obj = updatePolyData(d.getPolyData(), &#39;block axes&#39;)</span>
    <span class="c">#obj.setProperty(&#39;Color&#39;, QtGui.QColor(255, 255, 0))</span>
    <span class="c">#obj.setProperty(&#39;Visible&#39;, False)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">createBlockAffordance</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">,</span> <span class="n">xwidth</span><span class="p">,</span> <span class="n">ywidth</span><span class="p">,</span> <span class="n">zwidth</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Color&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">222</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="mi">184</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="mi">135</span><span class="o">/</span><span class="mf">255.0</span><span class="p">])</span>

    <span class="n">computeDebrisGraspSeed</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">computeDebrisStanceFrame</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">showFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;debris stance frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">publishCallback</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">publishDebrisStanceFrame</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">obj</span>

</div>
<div class="viewcode-block" id="computeDebrisGraspSeed"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.computeDebrisGraspSeed">[docs]</a><span class="k">def</span> <span class="nf">computeDebrisGraspSeed</span><span class="p">(</span><span class="n">aff</span><span class="p">):</span>

    <span class="n">debrisReferenceFrame</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;debris reference frame&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debrisReferenceFrame</span><span class="p">:</span>

        <span class="n">debrisReferenceFrame</span> <span class="o">=</span> <span class="n">debrisReferenceFrame</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">affCornerFrame</span> <span class="o">=</span> <span class="n">computeCornerFrame</span><span class="p">(</span><span class="n">aff</span><span class="p">,</span> <span class="n">debrisReferenceFrame</span><span class="p">)</span>
        <span class="n">showFrame</span><span class="p">(</span><span class="n">affCornerFrame</span><span class="p">,</span> <span class="s">&#39;board corner frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">aff</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="computeDebrisStanceFrame"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.computeDebrisStanceFrame">[docs]</a><span class="k">def</span> <span class="nf">computeDebrisStanceFrame</span><span class="p">(</span><span class="n">aff</span><span class="p">):</span>

    <span class="n">debrisReferenceFrame</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;debris reference frame&#39;</span><span class="p">)</span>
    <span class="n">debrisWallEdge</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;debris plane edge&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debrisReferenceFrame</span> <span class="ow">and</span> <span class="n">debrisWallEdge</span><span class="p">:</span>

        <span class="n">debrisReferenceFrame</span> <span class="o">=</span> <span class="n">debrisReferenceFrame</span><span class="o">.</span><span class="n">transform</span>

        <span class="n">affGroundFrame</span> <span class="o">=</span> <span class="n">computeGroundFrame</span><span class="p">(</span><span class="n">aff</span><span class="p">,</span> <span class="n">debrisReferenceFrame</span><span class="p">)</span>

        <span class="n">updateFrame</span><span class="p">(</span><span class="n">affGroundFrame</span><span class="p">,</span> <span class="s">&#39;board ground frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">affWallEdge</span> <span class="o">=</span> <span class="n">computeGroundFrame</span><span class="p">(</span><span class="n">aff</span><span class="p">,</span> <span class="n">debrisReferenceFrame</span><span class="p">)</span>

        <span class="n">framePos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">affGroundFrame</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">debrisWallEdge</span><span class="o">.</span><span class="n">points</span>
        <span class="n">edgeAxis</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
        <span class="n">edgeAxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edgeAxis</span><span class="p">)</span>
        <span class="n">projectedPos</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">edgeAxis</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">framePos</span> <span class="o">-</span> <span class="n">p1</span><span class="p">,</span> <span class="n">edgeAxis</span><span class="p">)</span>

        <span class="n">affWallFrame</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
        <span class="n">affWallFrame</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>

        <span class="n">useWallFrameForRotation</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">useWallFrameForRotation</span><span class="p">:</span>
            <span class="n">affWallFrame</span><span class="o">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="n">debrisReferenceFrame</span><span class="o">.</span><span class="n">GetMatrix</span><span class="p">())</span>
            <span class="n">affWallFrame</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">projectedPos</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">debrisReferenceFrame</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()))</span>

            <span class="n">stanceWidth</span> <span class="o">=</span> <span class="mf">0.20</span>
            <span class="n">stanceOffsetX</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.35</span>
            <span class="n">stanceOffsetY</span> <span class="o">=</span> <span class="mf">0.45</span>
            <span class="n">stanceRotation</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">affWallFrame</span><span class="o">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="n">affGroundFrame</span><span class="o">.</span><span class="n">GetMatrix</span><span class="p">())</span>
            <span class="n">affWallFrame</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">projectedPos</span> <span class="o">-</span> <span class="n">framePos</span><span class="p">)</span>

            <span class="n">stanceWidth</span> <span class="o">=</span> <span class="mf">0.20</span>
            <span class="n">stanceOffsetX</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.35</span>
            <span class="n">stanceOffsetY</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.45</span>
            <span class="n">stanceRotation</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="n">stanceFrame</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">getFootFramesFromReferenceFrame</span><span class="p">(</span><span class="n">affWallFrame</span><span class="p">,</span> <span class="n">stanceWidth</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">stanceRotation</span><span class="p">),</span> <span class="p">[</span><span class="n">stanceOffsetX</span><span class="p">,</span> <span class="n">stanceOffsetY</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">stanceFrame</span>

</div>
<div class="viewcode-block" id="publishDebrisStanceFrame"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.publishDebrisStanceFrame">[docs]</a><span class="k">def</span> <span class="nf">publishDebrisStanceFrame</span><span class="p">(</span><span class="n">aff</span><span class="p">):</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">computeDebrisStanceFrame</span><span class="p">(</span><span class="n">aff</span><span class="p">)</span>
    <span class="n">publishTriad</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="segmentBlockByPlanes"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentBlockByPlanes">[docs]</a><span class="k">def</span> <span class="nf">segmentBlockByPlanes</span><span class="p">(</span><span class="n">blockDimensions</span><span class="p">):</span>

    <span class="n">planes</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;selected planes&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">children</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">viewPlaneNormal</span> <span class="o">=</span> <span class="n">getSegmentationView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">()</span>
    <span class="n">origin1</span><span class="p">,</span> <span class="n">normal1</span><span class="p">,</span> <span class="n">plane1</span> <span class="o">=</span> <span class="n">getPlaneEquationFromPolyData</span><span class="p">(</span><span class="n">planes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">viewPlaneNormal</span><span class="p">)</span>
    <span class="n">origin2</span><span class="p">,</span> <span class="n">normal2</span><span class="p">,</span> <span class="n">plane2</span> <span class="o">=</span> <span class="n">getPlaneEquationFromPolyData</span><span class="p">(</span><span class="n">planes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">viewPlaneNormal</span><span class="p">)</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">normal2</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">normal1</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>

    <span class="n">pts1</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">planes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">pts2</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">planes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>

    <span class="n">linePoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">centroid2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pts2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">pts2</span><span class="p">)</span>
    <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPlane</span><span class="o">.</span><span class="n">ProjectPoint</span><span class="p">(</span><span class="n">centroid2</span><span class="p">,</span> <span class="n">origin1</span><span class="p">,</span> <span class="n">normal1</span><span class="p">,</span> <span class="n">linePoint</span><span class="p">)</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pts1</span><span class="o">-</span><span class="n">linePoint</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">linePoint</span> <span class="o">+</span> <span class="n">zaxis</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">linePoint</span> <span class="o">+</span> <span class="n">zaxis</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>

    <span class="n">xwidth</span><span class="p">,</span> <span class="n">ywidth</span> <span class="o">=</span> <span class="n">blockDimensions</span>
    <span class="n">zwidth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">xaxis</span><span class="o">*</span><span class="n">xwidth</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">yaxis</span><span class="o">*</span><span class="n">ywidth</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">zaxis</span><span class="o">*</span><span class="n">zwidth</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>

    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">linePoint</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>

    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">origin</span> <span class="o">-</span> <span class="n">xaxis</span><span class="o">*</span><span class="n">xwidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">xaxis</span><span class="o">*</span><span class="n">xwidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">origin</span> <span class="o">-</span> <span class="n">yaxis</span><span class="o">*</span><span class="n">ywidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">yaxis</span><span class="o">*</span><span class="n">ywidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">origin</span> <span class="o">-</span> <span class="n">zaxis</span><span class="o">*</span><span class="n">zwidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">zaxis</span><span class="o">*</span><span class="n">zwidth</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;block axes&#39;</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Color&#39;</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Visible&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="n">cube</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCubeSource</span><span class="p">()</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">SetXLength</span><span class="p">(</span><span class="n">xwidth</span><span class="p">)</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">SetYLength</span><span class="p">(</span><span class="n">ywidth</span><span class="p">)</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">SetZLength</span><span class="p">(</span><span class="n">zwidth</span><span class="p">)</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">cube</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="s">&#39;block affordance&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">BlockAffordanceItem</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;affordances&#39;</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetUserTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">addToView</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">getDRCView</span><span class="p">())</span>

    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">xwidth</span><span class="o">=</span><span class="n">xwidth</span><span class="p">,</span> <span class="n">ywidth</span><span class="o">=</span><span class="n">ywidth</span><span class="p">,</span> <span class="n">zwidth</span><span class="o">=</span><span class="n">zwidth</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setAffordanceParams</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="estimatePointerTip"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.estimatePointerTip">[docs]</a><span class="k">def</span> <span class="nf">estimatePointerTip</span><span class="p">(</span><span class="n">robotModel</span><span class="p">,</span> <span class="n">polyData</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a robot model, uses forward kinematics to determine a pointer tip</span>
<span class="sd">    search region, then does a ransac line fit in the search region to find</span>
<span class="sd">    points on the pointer, and selects the maximum point along the line fit</span>
<span class="sd">    as the pointer tip.  Returns the pointer tip xyz on success and returns</span>
<span class="sd">    None on failure.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">palmFrame</span> <span class="o">=</span> <span class="n">robotModel</span><span class="o">.</span><span class="n">getLinkFrame</span><span class="p">(</span><span class="s">&#39;r_hand_force_torque&#39;</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.06</span><span class="p">]</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.24</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.06</span><span class="p">]</span>

    <span class="n">palmFrame</span><span class="o">.</span><span class="n">TransformPoint</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
    <span class="n">palmFrame</span><span class="o">.</span><span class="n">TransformPoint</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;pointer line&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">cropToLineSegment</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="c">#print &#39;pointer search region is empty&#39;</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">vis</span><span class="o">.</span><span class="n">updatePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;cropped to pointer line&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelDistanceToLine</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;distance_to_line&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c">#print &#39;pointer search region is empty&#39;</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;distance to pointer line&#39;</span><span class="p">,</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;distance_to_line&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">ransacDistanceThreshold</span> <span class="o">=</span> <span class="mf">0.0075</span>
    <span class="n">lineOrigin</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">,</span> <span class="n">polyData</span> <span class="o">=</span> <span class="n">applyLineFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="n">ransacDistanceThreshold</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;line fit ransac&#39;</span><span class="p">,</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;ransac_labels&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">lineDirection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lineDirection</span><span class="p">)</span>
    <span class="n">lineDirection</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lineDirection</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lineDirection</span><span class="p">,</span> <span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lineDirection</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;ransac_labels&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c">#print &#39;pointer ransac line fit failed to find inliers&#39;</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;line fit points&#39;</span><span class="p">,</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;dist_along_line&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Point Size&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">pts</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pts</span><span class="o">-</span><span class="n">lineOrigin</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">lineOrigin</span> <span class="o">+</span> <span class="n">lineDirection</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">lineOrigin</span> <span class="o">+</span> <span class="n">lineDirection</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="c">#d.addSphere(p1, radius=0.005)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;fit pointer line&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">p2</span>

</div>
<div class="viewcode-block" id="startBoundedPlaneSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startBoundedPlaneSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startBoundedPlaneSegmentation</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentBoundedPlaneByAnnotation</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startValveSegmentationByWallPlane"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startValveSegmentationByWallPlane">[docs]</a><span class="k">def</span> <span class="nf">startValveSegmentationByWallPlane</span><span class="p">(</span><span class="n">expectedValveRadius</span><span class="p">):</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentValveByWallPlane</span><span class="p">,</span> <span class="n">expectedValveRadius</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startValveSegmentationManual"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startValveSegmentationManual">[docs]</a><span class="k">def</span> <span class="nf">startValveSegmentationManual</span><span class="p">(</span><span class="n">expectedValveRadius</span><span class="p">):</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentValve</span><span class="p">,</span> <span class="n">expectedValveRadius</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startRefitWall"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startRefitWall">[docs]</a><span class="k">def</span> <span class="nf">startRefitWall</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">refitWall</span>


</div>
<div class="viewcode-block" id="startWyeSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startWyeSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startWyeSegmentation</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentWye</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startDoorHandleSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startDoorHandleSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startDoorHandleSegmentation</span><span class="p">(</span><span class="n">otdfType</span><span class="p">):</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentDoorHandle</span><span class="p">,</span> <span class="n">otdfType</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startTrussSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startTrussSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startTrussSegmentation</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentTruss</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startHoseNozzleSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startHoseNozzleSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startHoseNozzleSegmentation</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentHoseNozzle</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="storePoint"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.storePoint">[docs]</a><span class="k">def</span> <span class="nf">storePoint</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_pickPoint</span>
    <span class="n">_pickPoint</span> <span class="o">=</span> <span class="n">p</span>

</div>
<div class="viewcode-block" id="getPickPoint"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getPickPoint">[docs]</a><span class="k">def</span> <span class="nf">getPickPoint</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_pickPoint</span>
    <span class="k">return</span> <span class="n">_pickPoint</span>

</div>
<div class="viewcode-block" id="startPickPoint"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startPickPoint">[docs]</a><span class="k">def</span> <span class="nf">startPickPoint</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">storePoint</span>

</div>
<div class="viewcode-block" id="startSelectToolTip"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startSelectToolTip">[docs]</a><span class="k">def</span> <span class="nf">startSelectToolTip</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">selectToolTip</span>

</div>
<div class="viewcode-block" id="startDrillSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startDrillSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startDrillSegmentation</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentDrill</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startDrillAutoSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startDrillAutoSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startDrillAutoSegmentation</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentDrillAuto</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startDrillButtonSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startDrillButtonSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startDrillButtonSegmentation</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentDrillButton</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startPointerTipSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startPointerTipSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startPointerTipSegmentation</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentPointerTip</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startDrillAutoSegmentationAlignedWithTable"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startDrillAutoSegmentationAlignedWithTable">[docs]</a><span class="k">def</span> <span class="nf">startDrillAutoSegmentationAlignedWithTable</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentDrillAlignedWithTable</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startDrillBarrelSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startDrillBarrelSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startDrillBarrelSegmentation</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentDrillBarrel</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startDrillWallSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startDrillWallSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startDrillWallSegmentation</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentDrillWall</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="startDrillWallSegmentationConstrained"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startDrillWallSegmentationConstrained">[docs]</a><span class="k">def</span> <span class="nf">startDrillWallSegmentationConstrained</span><span class="p">(</span><span class="n">rightAngleLocation</span><span class="p">):</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentDrillWallConstrained</span><span class="p">,</span> <span class="n">rightAngleLocation</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="startDrillInHandSegmentation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startDrillInHandSegmentation">[docs]</a><span class="k">def</span> <span class="nf">startDrillInHandSegmentation</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">drawLines</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentDrillInHand</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="startSegmentDebrisWall"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startSegmentDebrisWall">[docs]</a><span class="k">def</span> <span class="nf">startSegmentDebrisWall</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentDebrisWall</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="startSegmentDebrisWallManual"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.startSegmentDebrisWallManual">[docs]</a><span class="k">def</span> <span class="nf">startSegmentDebrisWallManual</span><span class="p">():</span>

    <span class="n">picker</span> <span class="o">=</span> <span class="n">PointPicker</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">addViewPicker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">picker</span><span class="o">.</span><span class="n">annotationFunc</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">segmentDebrisWallManual</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="selectToolTip"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.selectToolTip">[docs]</a><span class="k">def</span> <span class="nf">selectToolTip</span><span class="p">(</span><span class="n">point1</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">point1</span>


</div>
<div class="viewcode-block" id="segmentDebrisWallManual"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDebrisWallManual">[docs]</a><span class="k">def</span> <span class="nf">segmentDebrisWallManual</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>

    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">point1</span><span class="p">,</span> <span class="n">point2</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="n">edgeObj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;debris plane edge&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">edgeObj</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">]</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
    <span class="n">xaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>

    <span class="n">updateFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;debris plane frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">edgeObj</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">refFrame</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">refFrame</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">refFrame</span><span class="o">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">GetMatrix</span><span class="p">())</span>
    <span class="n">refFrame</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="o">-</span><span class="n">xaxis</span> <span class="o">+</span> <span class="n">yaxis</span> <span class="o">+</span> <span class="n">zaxis</span><span class="o">*</span><span class="mf">20.0</span><span class="p">)</span>
    <span class="n">updateFrame</span><span class="p">(</span><span class="n">refFrame</span><span class="p">,</span> <span class="s">&#39;debris reference frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">edgeObj</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="segmentDebrisWall"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDebrisWall">[docs]</a><span class="k">def</span> <span class="nf">segmentDebrisWall</span><span class="p">(</span><span class="n">point1</span><span class="p">):</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span><span class="p">)</span>

    <span class="n">viewPlaneNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">getSegmentationView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">())</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">viewPlaneNormal</span><span class="p">,</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="n">viewPlaneNormal</span><span class="p">,</span>
                                             <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;unbounded plane points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">labelOutliers</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">neighborsInSearchRadius</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;voxel plane points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;is_outlier&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;is_outlier&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">labelDistanceToPoint</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="n">point1</span><span class="p">)</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">extractClusters</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="n">clusterTolerance</span><span class="o">=</span><span class="mf">0.10</span><span class="p">)</span>
    <span class="n">clusters</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#39;distance_to_point&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">planeObj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;debris plane points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">perpAxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">perpAxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">perpAxis</span><span class="p">)</span>
    <span class="n">edgeAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">perpAxis</span><span class="p">)</span>

    <span class="n">edgePoints</span> <span class="o">=</span> <span class="n">computeEdge</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="n">edgeAxis</span><span class="p">,</span> <span class="n">perpAxis</span><span class="p">)</span>
    <span class="n">edgePoints</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getVtkPolyDataFromNumpyPoints</span><span class="p">(</span><span class="n">edgePoints</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">edgePoints</span><span class="p">,</span> <span class="s">&#39;edge points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">linePoint</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">applyLineFit</span><span class="p">(</span><span class="n">edgePoints</span><span class="p">)</span>

    <span class="c">#binCounts = computePointCountsAlongAxis(planePoints, lineDirection)</span>


    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">lineDirection</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">normal</span>

    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">zaxis</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">xaxis</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">pts</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pts</span><span class="o">-</span><span class="n">linePoint</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">linePoint</span> <span class="o">+</span> <span class="n">xaxis</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">linePoint</span> <span class="o">+</span> <span class="n">xaxis</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">projectPointToPlane</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">projectPointToPlane</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="n">edgeObj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;debris plane edge&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">planeObj</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">edgeObj</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">]</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>

    <span class="n">updateFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;debris plane frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">planeObj</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">refFrame</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTransform</span><span class="p">()</span>
    <span class="n">refFrame</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">refFrame</span><span class="o">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">GetMatrix</span><span class="p">())</span>
    <span class="n">refFrame</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="o">-</span><span class="n">xaxis</span> <span class="o">+</span> <span class="n">yaxis</span> <span class="o">+</span> <span class="n">zaxis</span><span class="o">*</span><span class="mf">20.0</span><span class="p">)</span>
    <span class="n">updateFrame</span><span class="p">(</span><span class="n">refFrame</span><span class="p">,</span> <span class="s">&#39;debris reference frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">planeObj</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="segmentBoundedPlaneByAnnotation"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentBoundedPlaneByAnnotation">[docs]</a><span class="k">def</span> <span class="nf">segmentBoundedPlaneByAnnotation</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>

    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">shallowCopy</span><span class="p">(</span><span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span><span class="p">)</span>


    <span class="n">viewPlaneNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">getSegmentationView</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">GetViewPlaneNormal</span><span class="p">())</span>

    <span class="n">polyData</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">distanceThreshold</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">viewPlaneNormal</span><span class="p">,</span> <span class="n">perpendicularAxis</span><span class="o">=</span><span class="n">viewPlaneNormal</span><span class="p">,</span>
                                             <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;dist_to_plane&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">])</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;unbounded plane points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">applyVoxelGrid</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="n">leafSize</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">labelOutliers</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">neighborsInSearchRadius</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;voxel plane points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;is_outlier&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;is_outlier&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">labelDistanceToPoint</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="n">point1</span><span class="p">)</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">extractClusters</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="n">clusterTolerance</span><span class="o">=</span><span class="mf">0.10</span><span class="p">)</span>
    <span class="n">clusters</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#39;distance_to_point&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="n">planePoints</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;plane points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">perpAxis</span> <span class="o">=</span> <span class="n">point2</span> <span class="o">-</span> <span class="n">point1</span>
    <span class="n">perpAxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">perpAxis</span><span class="p">)</span>
    <span class="n">edgeAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">perpAxis</span><span class="p">)</span>

    <span class="n">edgePoints</span> <span class="o">=</span> <span class="n">computeEdge</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="n">edgeAxis</span><span class="p">,</span> <span class="n">perpAxis</span><span class="p">)</span>
    <span class="n">edgePoints</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getVtkPolyDataFromNumpyPoints</span><span class="p">(</span><span class="n">edgePoints</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">edgePoints</span><span class="p">,</span> <span class="s">&#39;edge points&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">linePoint</span><span class="p">,</span> <span class="n">lineDirection</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">applyLineFit</span><span class="p">(</span><span class="n">edgePoints</span><span class="p">)</span>

    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">normal</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">lineDirection</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">perpAxis</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xaxis</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c"># make right handed</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>

    <span class="n">pts</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">planePoints</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pts</span><span class="o">-</span><span class="n">linePoint</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">linePoint</span> <span class="o">+</span> <span class="n">yaxis</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">linePoint</span> <span class="o">+</span> <span class="n">yaxis</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">projectPointToPlane</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">projectPointToPlane</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;plane edge&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">((</span><span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span><span class="p">)</span><span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="n">updateFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;plane edge frame&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


</div>
<span class="n">savedCameraParams</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="perspective"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.perspective">[docs]</a><span class="k">def</span> <span class="nf">perspective</span><span class="p">():</span>

    <span class="k">global</span> <span class="n">savedCameraParams</span>
    <span class="k">if</span> <span class="n">savedCameraParams</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">getDefaultAffordanceObject</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">aff</span><span class="p">:</span>
        <span class="n">aff</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Alpha&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetPickable</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">view</span> <span class="o">=</span> <span class="n">getSegmentationView</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">ParallelProjectionOff</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">savedCameraParams</span><span class="p">[</span><span class="s">&#39;Position&#39;</span><span class="p">])</span>
    <span class="n">c</span><span class="o">.</span><span class="n">SetFocalPoint</span><span class="p">(</span><span class="n">savedCameraParams</span><span class="p">[</span><span class="s">&#39;FocalPoint&#39;</span><span class="p">])</span>
    <span class="n">c</span><span class="o">.</span><span class="n">SetViewUp</span><span class="p">(</span><span class="n">savedCameraParams</span><span class="p">[</span><span class="s">&#39;ViewUp&#39;</span><span class="p">])</span>
    <span class="n">view</span><span class="o">.</span><span class="n">setCameraManipulationStyle</span><span class="p">()</span>
    <span class="n">view</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="saveCameraParams"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.saveCameraParams">[docs]</a><span class="k">def</span> <span class="nf">saveCameraParams</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="k">global</span> <span class="n">savedCameraParams</span>
    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">or</span> <span class="p">(</span><span class="n">savedCameraParams</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>

        <span class="n">view</span> <span class="o">=</span> <span class="n">getSegmentationView</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span>
        <span class="n">savedCameraParams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Position</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">(),</span> <span class="n">FocalPoint</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">GetFocalPoint</span><span class="p">(),</span> <span class="n">ViewUp</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">GetViewUp</span><span class="p">())</span>


</div>
<div class="viewcode-block" id="getDefaultAffordanceObject"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getDefaultAffordanceObject">[docs]</a><span class="k">def</span> <span class="nf">getDefaultAffordanceObject</span><span class="p">():</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">getActiveObject</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">AffordanceItem</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">om</span><span class="o">.</span><span class="n">getObjects</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">AffordanceItem</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>
</div>
<div class="viewcode-block" id="getVisibleRobotModel"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.getVisibleRobotModel">[docs]</a><span class="k">def</span> <span class="nf">getVisibleRobotModel</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">om</span><span class="o">.</span><span class="n">getObjects</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">roboturdf</span><span class="o">.</span><span class="n">RobotModelItem</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;Visible&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>
</div>
<div class="viewcode-block" id="orthoX"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.orthoX">[docs]</a><span class="k">def</span> <span class="nf">orthoX</span><span class="p">():</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">getDefaultAffordanceObject</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">aff</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">saveCameraParams</span><span class="p">()</span>

    <span class="n">aff</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Alpha&#39;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
    <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetPickable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">view</span> <span class="o">=</span> <span class="n">getSegmentationView</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">ParallelProjectionOn</span><span class="p">()</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">]</span>
    <span class="n">viewDirection</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;xaxis&#39;</span><span class="p">]</span>
    <span class="n">viewUp</span> <span class="o">=</span> <span class="o">-</span><span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;yaxis&#39;</span><span class="p">]</span>
    <span class="n">viewDistance</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;xwidth&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;zwidth&#39;</span><span class="p">]</span>

    <span class="n">c</span><span class="o">.</span><span class="n">SetFocalPoint</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">origin</span> <span class="o">-</span> <span class="n">viewDirection</span><span class="o">*</span><span class="n">viewDistance</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">SetViewUp</span><span class="p">(</span><span class="n">viewUp</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">SetParallelScale</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>

    <span class="n">view</span><span class="o">.</span><span class="n">setActorManipulationStyle</span><span class="p">()</span>
    <span class="n">view</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="orthoY"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.orthoY">[docs]</a><span class="k">def</span> <span class="nf">orthoY</span><span class="p">():</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">getDefaultAffordanceObject</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">aff</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">saveCameraParams</span><span class="p">()</span>

    <span class="n">aff</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Alpha&#39;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
    <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetPickable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">view</span> <span class="o">=</span> <span class="n">getSegmentationView</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">ParallelProjectionOn</span><span class="p">()</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">]</span>
    <span class="n">viewDirection</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;yaxis&#39;</span><span class="p">]</span>
    <span class="n">viewUp</span> <span class="o">=</span> <span class="o">-</span><span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;xaxis&#39;</span><span class="p">]</span>
    <span class="n">viewDistance</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;ywidth&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;zwidth&#39;</span><span class="p">]</span>

    <span class="n">c</span><span class="o">.</span><span class="n">SetFocalPoint</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">origin</span> <span class="o">-</span> <span class="n">viewDirection</span><span class="o">*</span><span class="n">viewDistance</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">SetViewUp</span><span class="p">(</span><span class="n">viewUp</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">SetParallelScale</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>

    <span class="n">view</span><span class="o">.</span><span class="n">setActorManipulationStyle</span><span class="p">()</span>
    <span class="n">view</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="orthoZ"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.orthoZ">[docs]</a><span class="k">def</span> <span class="nf">orthoZ</span><span class="p">():</span>

    <span class="n">aff</span> <span class="o">=</span> <span class="n">getDefaultAffordanceObject</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">aff</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">saveCameraParams</span><span class="p">()</span>

    <span class="n">aff</span><span class="o">.</span><span class="n">updateParamsFromActorTransform</span><span class="p">()</span>
    <span class="n">aff</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;Alpha&#39;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
    <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">SetPickable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">view</span> <span class="o">=</span> <span class="n">getSegmentationView</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">ParallelProjectionOn</span><span class="p">()</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">]</span>
    <span class="n">viewDirection</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;zaxis&#39;</span><span class="p">]</span>
    <span class="n">viewUp</span> <span class="o">=</span> <span class="o">-</span><span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;yaxis&#39;</span><span class="p">]</span>
    <span class="n">viewDistance</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;zwidth&#39;</span><span class="p">]</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">aff</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;ywidth&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>

    <span class="n">c</span><span class="o">.</span><span class="n">SetFocalPoint</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">origin</span> <span class="o">-</span> <span class="n">viewDirection</span><span class="o">*</span><span class="n">viewDistance</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">SetViewUp</span><span class="p">(</span><span class="n">viewUp</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">SetParallelScale</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>

    <span class="n">view</span><span class="o">.</span><span class="n">setActorManipulationStyle</span><span class="p">()</span>
    <span class="n">view</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="zoomToDisplayPoint"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.zoomToDisplayPoint">[docs]</a><span class="k">def</span> <span class="nf">zoomToDisplayPoint</span><span class="p">(</span><span class="n">displayPoint</span><span class="p">,</span> <span class="n">boundsRadius</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="n">pickedPoint</span> <span class="o">=</span> <span class="n">pickPoint</span><span class="p">(</span><span class="n">displayPoint</span><span class="p">,</span> <span class="n">getSegmentationView</span><span class="p">(),</span> <span class="n">obj</span><span class="o">=</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pickedPoint</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">view</span> <span class="o">=</span> <span class="n">view</span> <span class="ow">or</span> <span class="n">app</span><span class="o">.</span><span class="n">getCurrentRenderView</span><span class="p">()</span>

    <span class="n">worldPt1</span><span class="p">,</span> <span class="n">worldPt2</span> <span class="o">=</span> <span class="n">getRayFromDisplayPoint</span><span class="p">(</span><span class="n">getSegmentationView</span><span class="p">(),</span> <span class="n">displayPoint</span><span class="p">)</span>

    <span class="n">diagonal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">boundsRadius</span><span class="p">,</span> <span class="n">boundsRadius</span><span class="p">,</span> <span class="n">boundsRadius</span><span class="p">])</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">pickedPoint</span> <span class="o">-</span> <span class="n">diagonal</span><span class="p">,</span> <span class="n">pickedPoint</span> <span class="o">+</span> <span class="n">diagonal</span><span class="p">])</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
    <span class="n">view</span><span class="o">.</span><span class="n">renderer</span><span class="p">()</span><span class="o">.</span><span class="n">ResetCamera</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="p">()</span><span class="o">.</span><span class="n">SetFocalPoint</span><span class="p">(</span><span class="n">pickedPoint</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="extractPointsAlongClickRay"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.extractPointsAlongClickRay">[docs]</a><span class="k">def</span> <span class="nf">extractPointsAlongClickRay</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">polyData</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">distanceToLineThreshold</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">nearestToCamera</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="c">#segmentationObj = om.findObjectByName(&#39;pointcloud snapshot&#39;)</span>
    <span class="k">if</span> <span class="n">polyData</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">polyData</span> <span class="o">=</span> <span class="n">getCurrentRevolutionData</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">polyData</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelDistanceToLine</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">position</span> <span class="o">+</span> <span class="n">ray</span><span class="p">)</span>

    <span class="c"># extract points near line</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;distance_to_line&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">distanceToLineThreshold</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">None</span>


    <span class="n">polyData</span> <span class="o">=</span> <span class="n">labelPointDistanceAlongAxis</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">resultArrayName</span><span class="o">=</span><span class="s">&#39;distance_along_line&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">thresholdPoints</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;distance_along_line&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">polyData</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">updatePolyData</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;ray points&#39;</span><span class="p">,</span> <span class="n">colorByName</span><span class="o">=</span><span class="s">&#39;distance_to_line&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">nearestToCamera</span><span class="p">:</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;distance_along_line&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;distance_to_line&#39;</span><span class="p">)</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">vtkNumpy</span><span class="o">.</span><span class="n">getNumpyFromVtk</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="s">&#39;Points&#39;</span><span class="p">)</span>
    <span class="n">intersectionPoint</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">dists</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span> <span class="n">intersectionPoint</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">intersectionPoint</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;intersecting ray&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">())</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetLineWidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">d2</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">end_of_ray</span> <span class="o">=</span> <span class="n">position</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">ray</span>
    <span class="n">d2</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">end_of_ray</span><span class="p">)</span>
    <span class="n">obj2</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d2</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;camera ray&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">getDebugFolder</span><span class="p">())</span>
    <span class="n">obj2</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetLineWidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">intersectionPoint</span>

</div>
<div class="viewcode-block" id="segmentDrillWallFromTag"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDrillWallFromTag">[docs]</a><span class="k">def</span> <span class="nf">segmentDrillWallFromTag</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">ray</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Fix the drill wall relative to a ray intersected with the wall</span>
<span class="sd">    Desc: given a position and a ray (typically derived from a camera pixel)</span>
<span class="sd">    Use that point to determine a position for the Drill Wall</span>
<span class="sd">    This function uses a hard coded offset between the position on the wall</span>
<span class="sd">    to produce the drill cutting origin</span>
<span class="sd">    &#39;&#39;&#39;</span>


    <span class="c">#inputObj = om.findObjectByName(&#39;pointcloud snapshot&#39;)</span>
    <span class="c">#polyData = shallowCopy(inputObj.polyData)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">getCurrentRevolutionData</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">polyData</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span> <span class="c"># no data yet</span>
        <span class="k">print</span> <span class="s">&quot;no LIDAR data yet&quot;</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="n">point1</span> <span class="o">=</span> <span class="n">extractPointsAlongClickRay</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">polyData</span> <span class="p">)</span>

    <span class="c"># view direction is out:</span>
    <span class="n">viewDirection</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SegmentationContext</span><span class="o">.</span><span class="n">getGlobalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getViewDirection</span><span class="p">()</span>
    <span class="n">polyDataOut</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">applyPlaneFit</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">expectedNormal</span><span class="o">=</span><span class="n">viewDirection</span><span class="p">,</span> <span class="n">searchOrigin</span><span class="o">=</span><span class="n">point1</span><span class="p">,</span> <span class="n">searchRadius</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">angleEpsilon</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">returnOrigin</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># project the lidar point onto the plane (older, variance is &gt;1cm with robot 2m away)</span>
    <span class="c">#intersection_point = projectPointToPlane(point1, origin, normal)</span>
    <span class="c"># intersect the ray with the plane (variance was about 4mm with robot 2m away)</span>
    <span class="n">intersection_point</span> <span class="o">=</span> <span class="n">intersectLineWithPlane</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>

    <span class="c"># Define a frame:</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="n">yaxis</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
    <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">getTransformFromAxes</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">PostMultiply</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">intersection_point</span><span class="p">)</span>

    <span class="n">t2</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">copyFrame</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t2</span><span class="o">.</span><span class="n">PreMultiply</span><span class="p">()</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">(</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="o">-</span><span class="mf">0.25</span><span class="p">]</span> <span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">t2</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">t3</span><span class="p">)</span>

    <span class="n">rightAngleLocation</span> <span class="o">=</span> <span class="s">&#39;bottom left&#39;</span>
    <span class="n">createDrillWall</span><span class="p">(</span><span class="n">rightAngleLocation</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

    <span class="n">wall</span><span class="o">=</span>  <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;wall&#39;</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">updateFrame</span><span class="p">(</span> <span class="n">t</span> <span class="p">,</span><span class="s">&#39;wall fit tag&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">wall</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>


    <span class="n">d</span> <span class="o">=</span> <span class="n">DebugData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span> <span class="n">intersection_point</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.002</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">updatePolyData</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">getPolyData</span><span class="p">(),</span> <span class="s">&#39;intersection&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">wall</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="c">#</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetLineWidth</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>

</div>
<div class="viewcode-block" id="segmentDrillWallFromWallCenter"><a class="viewcode-back" href="../../generated/director.segmentation.html#director.segmentation.segmentDrillWallFromWallCenter">[docs]</a><span class="k">def</span> <span class="nf">segmentDrillWallFromWallCenter</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the drill wall target as an offset from the center of</span>
<span class="sd">    the full wall</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># find the valve wall and its center</span>
    <span class="n">inputObj</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;pointcloud snapshot&#39;</span><span class="p">)</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">inputObj</span><span class="o">.</span><span class="n">polyData</span>

    <span class="c"># hardcoded position to target frame from center of wall</span>
    <span class="c"># conincides with the distance from the april tag to this position</span>
    <span class="n">wallFrame</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">copyFrame</span><span class="p">(</span> <span class="n">findWallCenter</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">wallFrame</span><span class="o">.</span><span class="n">PreMultiply</span><span class="p">()</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">transformUtils</span><span class="o">.</span><span class="n">frameFromPositionAndRPY</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.07</span><span class="p">,</span><span class="o">-</span><span class="mf">0.3276</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">wallFrame</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">t3</span><span class="p">)</span>

    <span class="n">rightAngleLocation</span> <span class="o">=</span> <span class="s">&#39;bottom left&#39;</span>
    <span class="n">createDrillWall</span><span class="p">(</span><span class="n">rightAngleLocation</span><span class="p">,</span> <span class="n">wallFrame</span><span class="p">)</span>

    <span class="n">wall</span><span class="o">=</span>  <span class="n">om</span><span class="o">.</span><span class="n">findObjectByName</span><span class="p">(</span><span class="s">&#39;wall&#39;</span><span class="p">)</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">updateFrame</span><span class="p">(</span> <span class="n">wallFrame</span> <span class="p">,</span><span class="s">&#39;wall fit lidar&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">wall</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>